# プロファイル自動復旧ガイド

このドキュメントは、R-Autoの認証プロファイルの自動復旧機能と、万が一システムが自動で復旧できない状態に陥った場合の手動復旧手順について説明します。

## 1. 3つのプロファイルの役割

システムは、安定したタスク実行のために3種類のプロファイルを使用します。

- **プライマリプロファイル (`db/playwright_profile`)**
  - ✅ 通常のタスク実行時に、最初に使われるメインのプロファイルです。

- **セカンダリプロファイル (`db/playwright_profile_secondary`)**
  - 🔄 プライマリプロファイルでログイン失敗を検知した際に、自動的に切り替わって使用される予備のプロファイルです。

- **バックアッププロファイル (`db/playwright_profile_backup`)**
  - 💾 最後に正常な動作が確認されたプロファイルのコピーです。「認証プロファイルの復元」タスクの復元元として使われます。

---

## 2. 自動復旧の仕組み

タスク実行中に楽天のログインページへのリダイレクト（セッション切れ）が発生した場合、システムは以下の手順で自動的に復旧を試みます。

#### フロー図

```
フロー開始
   |
   V
[優先プロファイルでタスク実行]
   |
   +-- (成功) --> [タスク完了]
   |
   +-- (ログイン失敗検知) --> [警告ログ出力]
         |
         V
      [もう一方のプロファイルで再試行]
         |
         +-- (成功) --> [✅ 自動復旧処理の実行] --> [タスク完了]
         |                |
         |                +--> 1. 失敗したプロファイルを削除
         |                +--> 2. 正常なプロファイルを、失敗したプロファイルの場所にコピー
         |                +--> 3. 復旧したプロファイルをバックアップに保存
         |
         +-- (失敗) --> [🚨 エラーログ出力] --> [タスク失敗]
```

#### 解説

この仕組みにより、片方のプロファイルの認証が切れても、ユーザーが何もしなくてもシステムが自動で問題を解決し、常に正常なプロファイルを維持しようとします。

例えば、「プライマリ」優先設定時にプライマリプロファイルで失敗した場合：
1.  システムは自動で**セカンダリプロファイル**に切り替えてタスクを再実行します。
2.  再実行が成功すると、システムは以下のファイル操作を行います。
    - 失敗した**プライマリプロファイル**を削除します。
    - 正常だった**セカンダリプロファイル**の内容を、**プライマリプロファイル**の場所にコピーします。
    - 復旧した**プライマリプロファイル**を**バックアップ**に保存します。
3.  これにより、次のタスクは再び正常な状態のプライマリプロファイルから開始されます。

---

## 3. 手動での完全復旧手順

ごく稀に、プライマリとセカンダリの両方のプロファイルでログインできなくなることがあります。その場合は、以下の手順で簡単にシステムを正常な状態に戻すことができます。

### 手順1: 認証状態の再保存

1.  サイドメニューから **[システムコンフィグ]** ページに移動します。
2.  **[認証状態の保存]** ボタンをクリックします。
    - 確認ダイアログが表示されたら「OK」を押します。
3.  VNCクライアント（例: RealVNC Viewer）で `localhost:5900` に接続します。
4.  表示されているブラウザで、手動で楽天ROOMにログインします。
5.  ログインが完了したら、ブラウザのウィンドウを**閉じてください**。

この操作により、**プライマリプロファイル**と**バックアッププロファイル**が、新しくログインした正常な状態で上書きされます。

### 手順2: 認証プロファイルの復元（推奨）

手順1が完了したら、続けて以下の操作を行うことで、システムを最もクリーンな初期状態に戻せます。

1.  **[システムコンフィグ]** ページで、**[認証プロファイルの復元]** ボタンをクリックします。
    - 確認ダイアログが表示されたら「OK」を押します。

この操作により、以下の処理が実行されます。
- **プライマリプロファイル**が、バックアップから完全に復元されます。
- **セカンダリプロファイル**が削除され、空の状態で再作成されます。

これで、プライマリは正常、セカンダリはクリーンという万全の状態で、再び安定した自動運用を再開できます。