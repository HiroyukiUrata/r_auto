# Gemini API 導入ロードマップ

現在のブラウザ操作（スクレイピング）による投稿文生成を、より安定的で高速な **Google Cloud Platform (GCP) 上の Gemini API** を直接呼び出す方式に移行するための手順です。

### API化のメリット
- **安定性の向上**: ブラウザのUI変更に影響されず、安定して動作します。
- **処理速度の向上**: ブラウザを介さないため、投稿文の生成が格段に速くなります。
- **コスト管理の強化**: GCPの予算管理機能で、想定外の費用発生を確実に防ぎます。
- **無料枠の活用**: 1分あたり60リクエストまでの無料枠を最大限に活用できます。

---

## ステップ1: Google Cloud Platform (GCP) の準備

まず、APIを利用するための基盤となるGCPプロジェクトを準備します。

1.  **GCPアカウント作成**:
    *   まだお持ちでない場合は、Google Cloud公式サイト からアカウントを作成します。

2.  **新規プロジェクト作成**:
    *   GCPコンソールにログインし、新しいプロジェクトを作成します。（例: `r-auto-system`）

3.  **課金の有効化**:
    *   作成したプロジェクトに課金アカウントをリンクします。
    *   **注**: 無料枠を利用する場合でも、本人確認のために課金情報の登録が必要です。

---

## ステップ2: APIの有効化

プロジェクトでGemini APIを使えるようにします。

1.  GCPコンソールの検索バーで「**Vertex AI API**」を検索します。
2.  表示されたAPIを選択し、「有効にする」ボタンをクリックします。

---

## ステップ3: 認証情報の作成（推奨: サービスアカウント）

アプリケーションがGCPにアクセスするための「鍵」を作成します。セキュリティ上、**サービスアカウント**の利用を強く推奨します。

1.  GCPコンソールで「IAMと管理」>「サービスアカウント」に移動します。
2.  「サービスアカウントを作成」をクリックします。
    *   **サービスアカウント名**: `gemini-api-user` など分かりやすい名前を入力します。
    *   **ロール**: 「**Vertex AI ユーザー**」のロールを付与します。
3.  作成したサービスアカウントのメールアドレスをクリックし、「キー」タブに移動します。
4.  「鍵を追加」>「新しい鍵を作成」を選択し、キーのタイプとして「**JSON**」を選んで作成します。
5.  **JSONファイルが自動的にダウンロードされます。** このファイルは非常に重要なので、安全な場所に保管してください。
    *   例: プロジェクトルートに `auth` フォルダを作成し、`r-auto-service-account.json` のような名前で保存します。

---

## ステップ4: 予算とアラートの設定（コスト管理）

想定外の利用料金が発生しないように、利用額の上限を設定します。

1.  GCPコンソールで「お支払い」>「**予算とアラート**」に移動します。
2.  「予算を作成」をクリックします。
3.  **予算額**: 月々の上限額（例: 10ドル）を設定します。
4.  **アクション**:
    *   「通知のしきい値」を設定します。（例: 予算の50%, 90%, 100%でメール通知）
    *   **（最重要）**「**Pub/Sub 通知をこの予算に接続してプログラムによるアクションをトリガーする**」を選択し、**課金を無効にするアクション**を設定します。これにより、予算を超えた場合にAPIの利用が自動で停止され、高額請求を確実に防げます。

---

## ステップ5: アプリケーションの改修

最後に、アプリケーションのコードをAPIを利用するように変更します。

1.  **ライブラリのインストール**:
    *   `requirements.txt` にGoogle Cloudの公式ライブラリを追加します。
        ```
        google-cloud-aiplatform
        ```

2.  **設定画面の追加**:
    *   システムコンフィグ画面 (`config.html`) に、ステップ3でダウンロードした**サービスアカウントJSONファイルのパス**を設定する入力欄を追加します。

3.  **`create_caption.py` の全面改修**:
    *   Playwrightによるブラウザ操作のコードをすべて削除します。
    *   設定ファイルからサービスアカウントのパスを読み込み、GCPへの認証を行います。
    *   `get_products_for_caption_creation` で取得した商品情報を基に、APIに送信するリクエストを作成します。
    *   `google.cloud.aiplatform` ライブラリを使ってGemini Proモデルを呼び出し、投稿文を生成します。
    *   APIからの応答（生成された投稿文）を解析し、`update_ai_caption` でデータベースを更新します。

---

以上の手順で、安全かつ効率的なAPIベースの投稿文生成システムへ移行できます。
次のステップとして、具体的なコードの改修に進むことができます。