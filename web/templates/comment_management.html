{% extends "base.html" %}

{% block title %}ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿ç®¡ç† - R-Auto Control Panel{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">ğŸ’¬ ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿ç®¡ç†</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <button type="button" class="btn btn-sm btn-outline-primary" id="bulk-execute-btn" onclick="bulkExecute()" disabled>
                <i class="bi bi-send-fill me-1"></i>é¸æŠã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã«æŠ•ç¨¿
            </button>
            <button type="button" class="btn btn-sm btn-outline-secondary" id="bulk-skip-btn" onclick="bulkSkip()" disabled>
                <i class="bi bi-skip-forward-fill me-1"></i>é¸æŠã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ã‚¹ã‚­ãƒƒãƒ—
            </button>
            <button type="button" class="btn btn-sm btn-outline-secondary" id="select-all-toggle-btn" onclick="toggleSelectAll()">
                <i class="bi bi-check-square me-1"></i>ã™ã¹ã¦é¸æŠ
            </button>
        </div>
    </div>
</div>

<div class="table-responsive">
    <table class="table table-striped table-sm align-middle" style="table-layout: fixed; width: 100%;">
        <thead>
            <tr>
                <th scope="col" style="width: 5%;"></th>
                <th scope="col" style="width: 7%;">ã‚¢ã‚¤ã‚³ãƒ³</th>
                <th scope="col" style="width: 58%;">ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±</th>
                <th scope="col" style="width: 30%;">ã‚¢ã‚¯ã‚·ãƒ§ãƒ³/ãƒ•ã‚©ãƒ­ãƒ¼çŠ¶æ…‹</th>
            </tr>
        </thead>
        <tbody id="user-table-body">
            <!-- ãƒ‡ãƒ¼ã‚¿ã¯JavaScriptã§ã“ã“ã«æŒ¿å…¥ã•ã‚Œã¾ã™ -->
        </tbody>
    </table>
</div>

<!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="infoModal" tabindex="-1" aria-labelledby="infoModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="infoModalLabel">ãƒ¦ãƒ¼ã‚¶ãƒ¼è©³ç´°</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <h6 class="fw-bold">ãƒ¦ãƒ¼ã‚¶ãƒ¼å</h6>
        <p id="modal-user-name"></p>
        <h6 class="fw-bold mt-3">ç”Ÿæˆæ¸ˆã¿ã‚³ãƒ¡ãƒ³ãƒˆ</h6>
        <p id="modal-comment-text" style="white-space: pre-wrap;"></p>
        <h6 class="fw-bold mt-3">å…¨ãƒ‡ãƒ¼ã‚¿</h6>
        <pre><code id="modal-full-data" class="bg-light p-2 rounded" style="font-size: 0.8rem; display: block;"></code></pre>
      </div>
      <div class="modal-footer">
        <a href="#" id="modal-profile-link" class="btn btn-primary" target="_blank" rel="noopener noreferrer" style="display: none;"><i class="bi bi-box-arrow-up-right me-1"></i>ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’é–‹ã</a>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block styles %}
<style>
    .truncate-cell {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    tbody tr {
        cursor: pointer;
    }
    tr.selected .img-thumbnail {
        border: 3px solid #0d6efd;
        padding: 1px;
    }
    .user-icon {
        width: 50px;
        height: 50px;
        aspect-ratio: 1 / 1;
        object-fit: cover;
        border-radius: 50%;
    }
    .table .form-check-input {
        width: 1.25em;
        height: 1.25em;
        vertical-align: middle;
    }
    .table th:first-child,
    .table td:first-child {
        display: none;
    }
    /* ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ãªã©ã®å°ã•ã„ç”»é¢å‘ã‘ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    @media (max-width: 767.98px) {
        thead {
            display: none; /* ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’éè¡¨ç¤º */
        }
        tr {
            display: grid;
            grid-template-columns: 70px 1fr; /* ã‚¢ã‚¤ã‚³ãƒ³ | æƒ…å ± */
            grid-template-areas:
                "icon info";
            gap: 0.75rem;
            border: 1px solid #dee2e6;
            border-top: none; /* ä¸Šã®å¢ƒç•Œç·šã‚’æ¶ˆã™ */
            border-radius: .25rem;
            margin-bottom: 0;
            padding: 0.75rem;
            position: relative;
        }
        td {
            display: block;
            text-align: left !important;
            width: 100% !important;
            border: none;
            padding: 0;
        }
        td:before {
            content: attr(data-label);
            font-weight: bold;
            display: block;
            color: #6c757d;
        }
        td[data-label="ã‚¢ã‚¤ã‚³ãƒ³"] {
            grid-area: icon;
            align-self: start; /* ã‚¢ã‚¤ã‚³ãƒ³ã‚»ãƒ«ãŒç¸¦ã«ä¼¸ã³ãªã„ã‚ˆã†ã«ã™ã‚‹ */
            padding: 0 !important; /* ä½™ç™½ã‚’ãªãã™ */
        }
        td[data-label="ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±"] { grid-area: info; min-width: 0; }

        /* ã‚¹ãƒãƒ›ã§ã¯éè¡¨ç¤ºã«ã™ã‚‹åˆ— */
        td[data-label="ã‚¢ã‚¯ã‚·ãƒ§ãƒ³/ãƒ•ã‚©ãƒ­ãƒ¼çŠ¶æ…‹"],
        td[data-label="æœ€çµ‚ã‚³ãƒ¡ãƒ³ãƒˆ"] {
            display: none;
        }

        /* ãƒ©ãƒ™ãƒ«ãŒä¸è¦ãªã‚»ãƒ« */
        td[data-label="ã‚¢ã‚¤ã‚³ãƒ³"]:before,
        td[data-label="ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±"]:before {
            content: "";
            display: none;
        }
        /* æœ€åˆã®è¡Œã ã‘ä¸Šã®å¢ƒç•Œç·šã‚’è¡¨ç¤º */
        tr:first-child {
            border-top: 1px solid #dee2e6;
        }
        .desktop-only { display: none; }
    }
    @media (min-width: 767.99px) {
        .mobile-only { display: none; }
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    let infoModalInstance = null;

    function showInfoModal(element) {
        event.stopPropagation();
        const user = JSON.parse(element.dataset.user);

        document.getElementById('modal-user-name').textContent = user.name;
        document.getElementById('modal-comment-text').textContent = user.comment_text;
        document.getElementById('modal-full-data').textContent = JSON.stringify(user, null, 2);

        const profileLink = document.getElementById('modal-profile-link');
        if (user.profile_page_url && user.profile_page_url !== 'å–å¾—å¤±æ•—') {
            profileLink.href = user.profile_page_url;
            profileLink.style.display = 'inline-block';
        } else {
            profileLink.style.display = 'none';
        }

        infoModalInstance.show();
    }

    function getSelectedUserIds() {
        return Array.from(document.querySelectorAll('.user-checkbox:checked')).map(cb => cb.value);
    }

    function updateBulkActionButtons() {
        const selectedIds = getSelectedUserIds();
        const disabled = selectedIds.length === 0;
        document.getElementById('bulk-execute-btn').disabled = disabled;
        document.getElementById('bulk-skip-btn').disabled = disabled;
    }

    function toggleSelectAll() {
        const allCheckboxes = document.querySelectorAll('.user-checkbox');
        const allSelected = getSelectedUserIds().length === allCheckboxes.length;
        allCheckboxes.forEach(checkbox => {
            checkbox.checked = !allSelected;
            checkbox.closest('tr').classList.toggle('selected', !allSelected);
        });
        updateBulkActionButtons();
    }

    async function bulkExecute() {
        const userIds = getSelectedUserIds();
        if (userIds.length === 0) return;
        if (!confirm(`${userIds.length}ä»¶ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿ã—ã¾ã™ã‹ï¼Ÿ`)) return;
        alert(`ï¼ˆæœªå®Ÿè£…ï¼‰${userIds.join(', ')} ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿ã—ã¾ã™ã€‚`);
        // TODO: APIå‘¼ã³å‡ºã—ã‚’å®Ÿè£…
    }

    async function bulkSkip() {
        const userIds = getSelectedUserIds();
        if (userIds.length === 0) return;
        if (!confirm(`${userIds.length}ä»¶ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã‹ï¼Ÿ`)) return;

        fetch('/api/users/skip', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ user_ids: userIds })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert(data.message);
                location.reload(); // ç”»é¢ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ãƒªã‚¹ãƒˆã‚’æ›´æ–°
            } else {
                alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + data.error);
            }
        })
        .catch(error => alert('é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error));
    }

    document.addEventListener('DOMContentLoaded', function () {
        infoModalInstance = new bootstrap.Modal(document.getElementById('infoModal'));

        fetch('/api/comment-targets') // TODO: ã“ã®APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’å®Ÿè£…ã™ã‚‹å¿…è¦ãŒã‚ã‚‹
            .then(response => {
                if (!response.ok) {
                    if (response.status === 404) return []; // 404ã®å ´åˆã¯ç©ºã®é…åˆ—ã‚’è¿”ã™
                    throw new Error('APIã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                }
                return response.json();
            })
            .then(data => {
                const tableBody = document.getElementById('user-table-body');
                tableBody.innerHTML = '';
                if (data.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="6" class="text-center">ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿å¯¾è±¡ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã„ã¾ã›ã‚“ã€‚</td></tr>';
                    return;
                }
                data.forEach(user => {
                    const escapedUserJson = JSON.stringify(user).replace(/'/g, '&apos;').replace(/"/g, '&quot;');
                    const lastCommented = user.last_commented_at ? new Date(user.last_commented_at).toLocaleDateString('ja-JP') : 'ãªã—';
                    
                    // ãƒ•ã‚©ãƒ­ãƒ¼çŠ¶æ…‹ã®ã‚¢ã‚¤ã‚³ãƒ³ã‚’æ±ºå®š
                    // è‡ªåˆ†ãŒãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ã„ã‚‹ã‹ (is_following)
                    const isFollowingIcon = user.is_following ? '<i class="bi bi-person-check-fill text-primary" title="ã‚ãªãŸãŒãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ã„ã¾ã™"></i>' : '<i class="bi bi-person-plus text-muted" title="ã‚ãªãŸã¯ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ã„ã¾ã›ã‚“"></i>';
                    // ç›¸æ‰‹ãŒãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ãã‚ŒãŸã‹ (follow_count)
                    const followedByIcon = user.follow_count > 0 ? '<i class="bi bi-person-heart text-danger" title="ç›¸æ‰‹ã‹ã‚‰ãƒ•ã‚©ãƒ­ãƒ¼ã•ã‚Œã¾ã—ãŸ"></i>' : '';

                    // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³æ•°ã®è¡¨ç¤ºãƒ­ã‚¸ãƒƒã‚¯
                    const recentLikes = user.recent_like_count || 0;
                    const totalLikes = user.like_count || 0;
                    const likeDisplay = recentLikes < totalLikes ? `${recentLikes}+` : recentLikes;

                    const recentCollects = user.recent_collect_count || 0;
                    const totalCollects = user.collect_count || 0;
                    const collectDisplay = recentCollects < totalCollects ? `${recentCollects}+` : recentCollects;

                    // 3æ—¥ä»¥ä¸ŠçµŒé & 5ã„ã„ã­ä»¥ä¸Šã®å„ªå…ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚¢ã‚¤ã‚³ãƒ³ã‚’è¿½åŠ 
                    let priorityIcon = '';
                    const threeDaysAgo = new Date();
                    threeDaysAgo.setDate(threeDaysAgo.getDate() - 3);
                    if (user.last_commented_at && new Date(user.last_commented_at) < threeDaysAgo && user.recent_like_count >= 5) {
                        priorityIcon = '<span title="å†ã‚³ãƒ¡ãƒ³ãƒˆå¯¾è±¡ã®å„ªå…ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ã™ï¼ˆæœ€çµ‚ã‚³ãƒ¡ãƒ³ãƒˆã‹ã‚‰3æ—¥ä»¥ä¸ŠçµŒé ï¼† ä»Šå›5ã„ã„ã­ä»¥ä¸Šï¼‰">ğŸ”¥</span>';
                    }

                    const row = `
                        <tr id="user-row-${user.id}" data-user='${escapedUserJson}'>
                            <td>
                                <input class="form-check-input user-checkbox" type="checkbox" value="${user.id}" onclick="event.stopPropagation();">
                            </td>
                            <td data-label="ã‚¢ã‚¤ã‚³ãƒ³">
                                <a href="${user.profile_page_url || '#'}" target="_blank" rel="noopener noreferrer">
                                    <img src="${user.profile_image_url || 'https://via.placeholder.com/50'}" alt="${user.name}" class="user-icon img-thumbnail">
                                </a>
                            </td>
                            <td class="text-start" data-label="ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±" style="min-width: 0;">
                                <!-- PCè¡¨ç¤ºç”¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¨ã‚³ãƒ¡ãƒ³ãƒˆ -->
                                <div class="fw-bold truncate-cell" title="${user.name || ''}">${priorityIcon} ${user.name || ''}</div>
                                <div class="text-muted small truncate-cell desktop-only" title="${user.comment_text || ''}">${user.comment_text || ''}</div>
                                <div class="mobile-only mt-1 d-flex justify-content-between align-items-center">
                                    <div>
                                        <span class="small me-2">â¤ï¸ ${likeDisplay}</span>
                                        <span class="small me-2">ğŸ“‚ ${collectDisplay}</span>
                                        <span class="small">${isFollowingIcon} ${followedByIcon}</span>
                                    </div>
                                    <button type="button" class="btn btn-link p-0 text-secondary" onclick="showInfoModal(this.closest('tr'))" title="è©³ç´°æƒ…å ±ã‚’è¡¨ç¤º"><i class="bi bi-info-circle fs-5"></i></button>
                                </div>
                            </td>
                            <td class="small text-muted desktop-only" data-label="ã‚¢ã‚¯ã‚·ãƒ§ãƒ³/ãƒ•ã‚©ãƒ­ãƒ¼çŠ¶æ…‹" style="min-width: 0;">
                                <div class="d-flex justify-content-between align-items-center h-100 w-100">
                                    <div class="d-flex flex-wrap align-items-center gap-2 text-nowrap">
                                        <span>â¤ï¸ ${likeDisplay}</span>
                                        <span>ğŸ“‚ ${collectDisplay}</span>
                                        <span>${isFollowingIcon} ${followedByIcon}</span>
                                    </div>
                                    <button type="button" class="btn btn-link p-0 text-secondary" onclick="showInfoModal(this.closest('tr'))" title="è©³ç´°æƒ…å ±ã‚’è¡¨ç¤º"><i class="bi bi-info-circle fs-5"></i></button>
                                </div>
                            </td>
                        </tr>
                    `;
                    tableBody.innerHTML += row;
                });
            })
            .catch(error => {
                console.error('Error:', error);
                const tableBody = document.getElementById('user-table-body');
                tableBody.innerHTML = `<tr><td colspan="6" class="text-center text-danger">${error.message}</td></tr>`;
            });

        document.getElementById('user-table-body').addEventListener('change', function (e) {
            if (e.target.classList.contains('user-checkbox')) {
                e.target.closest('tr').classList.toggle('selected', e.target.checked);
                updateBulkActionButtons();
            }
        });

        document.getElementById('user-table-body').addEventListener('click', function (e) {
            if (e.target.closest('a, button, .form-check-input')) return;
            
            const row = e.target.closest('tr');
            // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹å‹•ä½œã«å¤‰æ›´
            const checkbox = row.querySelector('.user-checkbox');
            if (checkbox) checkbox.click();
        });
    });
</script>
{% endblock %}