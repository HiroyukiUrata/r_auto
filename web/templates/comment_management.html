{% extends "base.html" %}

{% block title %}ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿ç®¡ç† - R-Auto Control Panel{% endblock %}

{% block styles %}
<style>
    /* æ¤œç´¢ãƒœãƒƒã‚¯ã‚¹ã®ã‚¢ã‚¤ã‚³ãƒ³ */
    .search-box {
        position: relative;
    }
    .search-box .bi-search {
        position: absolute;
        left: 10px;
        top: 50%;
        transform: translateY(-50%);
        color: #6c757d;
    }
    .search-box .form-control {
        padding-left: 2.5rem;
    }
    /* ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³è¡¨ç¤ºã§ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’éè¡¨ç¤ºã«ã™ã‚‹ */
    @media (max-width: 767.98px) {
        thead {
            display: none;
        }
        /* å„åˆ—ã®å¹…ã‚’å†èª¿æ•´ */
        tbody tr td:nth-child(1) { width: 17%; } /* ã‚¢ã‚¤ã‚³ãƒ³ */
        tbody tr td:nth-child(2) { width: 55%; } /* ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ± */
        tbody tr td:nth-child(3) { width: 18%; } /* ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ */
        tbody tr td:nth-child(4) { width: 10%; } /* è©³ç´° */
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">ğŸ’¬ ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿ç®¡ç†</h1>
    <div class="btn-toolbar mb-2 mb-md-0 d-flex justify-content-end align-items-center">
        <div class="me-auto">
            <div id="bulk-actions-wrapper" class="d-flex align-items-center">
                <div class="d-flex flex-wrap gap-2 me-2" id="bulk-action-buttons">
                    <button type="button" class="btn btn-sm btn-outline-secondary" id="select-all-toggle-btn" onclick="toggleSelectAll()" title="ã™ã¹ã¦é¸æŠ/è§£é™¤">
                        <i class="bi bi-check-square"></i><span class="d-none d-md-inline ms-1">å…¨é¸æŠ</span>
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-secondary" id="bulk-skip-btn" onclick="bulkSkip()" disabled title="é¸æŠã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ã‚¹ã‚­ãƒƒãƒ—">
                        <i class="bi bi-skip-forward-fill"></i><span class="d-none d-md-inline ms-1">ã‚¹ã‚­ãƒƒãƒ—</span>
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-info" id="bulk-dryrun-btn" onclick="bulkDryRun()" disabled title="æŠ•ç¨¿äºˆè¡Œï¼ˆãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³ï¼‰">
                        <i class="bi bi-send-slash-fill"></i><span class="d-none d-md-inline ms-1">äºˆè¡Œ</span>
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-primary" id="bulk-execute-btn" onclick="bulkExecute()" disabled title="é¸æŠã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã«æŠ•ç¨¿">
                        <i class="bi bi-send-fill"></i><span class="d-none d-md-inline ms-1">æŠ•ç¨¿</span>
                    </button>
                </div>
                <!-- ã‚¹ãƒãƒ›è¡¨ç¤ºæ™‚ã®ã¿å‡¡ä¾‹ã‚¢ã‚¤ã‚³ãƒ³ã‚’è¡¨ç¤º -->
                <i id="bulk-action-legend" class="bi bi-info-circle d-inline-block d-md-none text-secondary" style="cursor: pointer; font-size: 1.2rem;" data-bs-toggle="tooltip" data-bs-html="true" data-bs-title="<div class='text-start'>ãƒ»<i class='bi bi-check-square'></i>: å…¨é¸æŠ/è§£é™¤<br>ãƒ»<i class='bi bi-skip-forward-fill'></i>: ã‚¹ã‚­ãƒƒãƒ—<br>ãƒ»<i class='bi bi-send-slash-fill'></i>: äºˆè¡Œ<br>ãƒ»<i class='bi bi-send-fill'></i>: æŠ•ç¨¿</div>"></i>
            </div>
        </div>
        <div class="form-check form-switch ms-3">
            <input class="form-check-input" type="checkbox" role="switch" id="show-all-users-switch" onchange="updateViewOptions(); fetchUsers();">
            <label class="form-check-label small" for="show-all-users-switch">
                å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼è¡¨ç¤º
            </label>
        </div>
    </div>
</div>

<!-- å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼è¡¨ç¤ºæ™‚ã®æ¤œç´¢ãƒ»ã‚½ãƒ¼ãƒˆç”¨ã‚³ãƒ³ãƒ†ãƒŠ -->
<div id="filter-container" class="mb-3" style="display: none;">
    <div class="row g-2">
        <div class="col-7">
            <div class="search-box h-100">
                <i class="bi bi-search"></i>
                <input type="search" id="user-search-input" class="form-control h-100" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼åã§æ¤œç´¢...">
            </div>
        </div>
        <div class="col-5">
            <select class="form-select" id="sort-select" onchange="fetchUsers()">
                <option value="recent_action" selected>ğŸ•’æ–°ã—ã„é †</option>
                <option value="commented">ğŸ’¬æ¸ˆãƒ¦ãƒ¼ã‚¶ãƒ¼</option>
                <option value="like_count_desc">â¤ï¸å¤šã„é †</option>
                <option value="commented_at_desc">ğŸ’¬æ–°ã—ã„é †</option>
                <option value="commented_at_asc">ğŸ’¬å¤ã„é †</option>
            </select>
        </div>
    </div>
</div>

<div class="table-responsive">
    <table class="table table-striped table-sm align-middle" style="table-layout: fixed; width: 100%;">
        <thead>
            <tr>
                <th scope="col" style="width: 70px;">ã‚¢ã‚¤ã‚³ãƒ³</th>
                <th scope="col" style="width: 60%;">ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±</th>
                <th scope="col" style="width: 20%;">ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</th>
                <th scope="col" style="width: 10%;">è©³ç´°</th>
            </tr>
        </thead>
        <tbody id="user-table-body">
            <!-- ãƒ‡ãƒ¼ã‚¿ã¯JavaScriptã§ã“ã“ã«æŒ¿å…¥ã•ã‚Œã¾ã™ -->
        </tbody>
    </table>
</div>

<!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="infoModal" tabindex="-1" aria-labelledby="infoModalLabel" aria-hidden="true"> 
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="infoModalLabel">ãƒ¦ãƒ¼ã‚¶ãƒ¼è©³ç´°</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="d-flex justify-content-between align-items-center">
            <h6 class="fw-bold mb-0">ãƒ¦ãƒ¼ã‚¶ãƒ¼å</h6>
            <a href="#" id="modal-profile-link" class="btn btn-sm btn-outline-primary" target="_blank" rel="noopener noreferrer" style="display: none;" title="ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’é–‹ã"><i class="bi bi-box-arrow-up-right"></i></a>
        </div>
        <p id="modal-user-name"></p>
        <div class="d-flex justify-content-between align-items-center mt-3">
            <h6 class="fw-bold mb-0">ç”Ÿæˆæ¸ˆã¿ã‚³ãƒ¡ãƒ³ãƒˆ</h6>
            <div class="btn-group">
                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="templateDropdown" data-bs-toggle="dropdown" aria-expanded="false" title="ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’é©ç”¨">
                    <i class="bi bi-card-text"></i>
                </button>
                <ul class="dropdown-menu" aria-labelledby="templateDropdown" id="comment-template-list"></ul>
                <button type="button" class="btn btn-sm btn-outline-success" id="modal-save-comment-btn" onclick="updateComment()" title="ã‚³ãƒ¡ãƒ³ãƒˆã‚’ä¿å­˜"><i class="bi bi-save-fill"></i></button>
            </div>
        </div>
        <textarea class="form-control" id="modal-comment-text" rows="6" style="white-space: pre-wrap;"></textarea>
        <div class="d-flex justify-content-between align-items-start mt-3">
            <h6 class="fw-bold mb-0">
                <a class="text-decoration-none text-dark" data-bs-toggle="collapse" href="#collapseFullData" role="button" aria-expanded="false" aria-controls="collapseFullData">
                    å…¨ãƒ‡ãƒ¼ã‚¿ <i class="bi bi-chevron-down small"></i>
                </a>
            </h6>
        </div>
        <div class="collapse" id="collapseFullData">
            <div style="position: relative;">
                <pre><code id="modal-full-data" class="bg-light p-2 rounded" style="font-size: 0.8rem; display: block; min-height: 100px;"></code></pre>
                <button class="btn btn-outline-secondary" onclick="copyFullData('modal-full-data')" title="ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¨é¸æŠ" style="position: absolute; top: 5px; right: 5px; padding: .1rem .4rem; font-size: .8rem;">
                    <i class="bi bi-clipboard"></i>
                </button>
            </div>
        </div>
      </div>
      <div class="modal-footer">
        <!-- ã€ŒæŠ•ç¨¿æ¸ˆãƒšãƒ¼ã‚¸ã¸ã€ãƒœã‚¿ãƒ³ã®ã¿ãƒ•ãƒƒã‚¿ãƒ¼ã«æ®‹ã™ -->
        <a href="#" id="modal-last-comment-link" class="btn btn-info" target="_blank" rel="noopener noreferrer" style="display: none;"><i class="bi bi-chat-left-text-fill me-1"></i>æŠ•ç¨¿æ¸ˆãƒšãƒ¼ã‚¸ã¸</a>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<style>
    .truncate-cell {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    tbody tr {
        cursor: pointer;
    }
    /* è¡Œã®èƒŒæ™¯è‰²ãƒã‚¤ãƒ©ã‚¤ãƒˆã¯ä½¿ã‚ãšã€é€æ˜ã«ã™ã‚‹ */
    tr.selected {
        background-color: transparent !important;
    }
    /* é¸æŠã•ã‚ŒãŸè¡Œã®ã‚¢ã‚¤ã‚³ãƒ³æ ç·šã‚’å¼·èª¿ */
    tr.selected .img-thumbnail {
        border: 3px solid #0d6efd; /* ãƒ—ãƒ©ã‚¤ãƒãƒªã‚«ãƒ©ãƒ¼ã§æ ç·šã‚’å¤ªã */
        padding: 1px; /* æ ç·šã®å¤ªã•ãŒå¢—ãˆãŸåˆ†ã€ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’èª¿æ•´ */
    }
    .user-icon {
        width: 50px;
        height: 50px;
        aspect-ratio: 1 / 1;
        object-fit: cover;
        border-radius: 50%;
    }
    .icon-container {
        position: relative;
        display: inline-block; /* or block, depending on layout */
    }
    .status-icons {
        position: absolute;
        top: -8px;
        left: -2px;
        display: flex;
        gap: 2px;
        z-index: 1; /* ã‚¢ã‚¤ã‚³ãƒ³ã®æ ç·šã‚ˆã‚Šæ‰‹å‰ã«è¡¨ç¤ºã™ã‚‹ */
    }
    .priority-icon {
        position: absolute;
        bottom: -5px;
        left: -8px;
        z-index: 1;
        font-size: 1.2rem; /* ã‚¢ã‚¤ã‚³ãƒ³ã‚µã‚¤ã‚ºã‚’å°‘ã—å¤§ãã */
    }
</style>
<script>
    let infoModalInstance = null;
    let lastSelectedRowIndex = null;

    const commentTemplates = [
        {
            name: "ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ1 (åŸºæœ¬)",
            text: 'ğŸ‘¦ã€Œã„ã„ã­ï¼ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ğŸ˜Šã€\nğŸ‘¸ã€Œã¾ãŸéŠã³ã«æ¥ã¾ã™ğŸŒ¼ã€\nğŸ‘¦ğŸ‘¸ã€Œã€Œä»Šå¾Œã¨ã‚‚ã‚ˆã‚ã—ããŠé¡˜ã„ã—ã¾ã™ğŸ’ã€ã€'
        },
        {
            name: "ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ2 (è¨ªå•æ„Ÿè¬)",
            text: 'ğŸ‘¸ã€ŒéŠã³ã«æ¥ã¦ãã‚Œã¦å¬‰ã—ã„ã§ã™âœ¨ã€\nğŸ‘¦ã€Œã¾ãŸã„ã¤ã§ã‚‚æ¥ã¦ãã ã•ã„ã­ï¼ã€\nğŸ‘¦ğŸ‘¸ã€Œã€ŒãŠå¾…ã¡ã—ã¦ã¾ã™ã€œğŸ‘‹ã€ã€'
        },
        {
            name: "ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ3 (ã‚·ãƒ³ãƒ—ãƒ«æ„Ÿè¬)",
            text: 'ğŸ‘¸ã€Œã„ã¤ã‚‚è¦‹ã¦ãã‚Œã¦ã‚ã‚ŠãŒã¨ã†ğŸ’•ã€\nğŸ‘¦ã€Œå¿œæ´ã€åŠ±ã¿ã«ãªã‚Šã¾ã™ã£ï¼ã€\nğŸ‘¸ğŸ‘¦ã€Œã€Œã“ã‚Œã‹ã‚‰ã‚‚ä»²è‰¯ãã—ã¦ãã ã•ã„ã­ğŸ˜Šã€ã€'
        },
        {
            name: "ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ4 (å•†å“ãƒ•ã‚©ãƒ¼ã‚«ã‚¹)",
            text: 'ğŸ‘¦ã€Œç´ æ•µãªå•†å“ã€è¦‹ã¤ã‹ã‚Šã¾ã—ãŸã‹ï¼Ÿâœ¨ã€\nğŸ‘¸ã€Œã¾ãŸæ–°ã—ã„ã‚¢ã‚¤ãƒ†ãƒ ç´¹ä»‹ã—ã¾ã™ã­ï¼ã€\nğŸ‘¦ğŸ‘¸ã€Œã€Œæ¥½ã—ã‚“ã§ã„ã£ã¦ãã ã•ã„ã­ã€œğŸŒ¸ã€ã€'
        },
        {
            name: "ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ5 (æ±ç”¨)",
            text: 'ğŸ‘¸ã€Œã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ğŸ’ã€\nğŸ‘¦ã€Œã¨ã£ã¦ã‚‚å¬‰ã—ã„ã§ã™ã€œï¼ğŸ˜†ã€\nğŸ‘¦ğŸ‘¸ã€Œã€Œã¾ãŸã®ãŠè¶Šã—ã‚’ãŠå¾…ã¡ã—ã¦ã¾ã™ï¼ã€ã€'
        }
    ];

    function applyTemplate(templateIndex) {
        const template = commentTemplates[templateIndex];
        const textarea = document.getElementById('modal-comment-text');
        textarea.value = template.text;
    }

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒé–‰ã˜ãŸå¾Œã«å®Ÿè¡Œã™ã‚‹ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’ä¿æŒã™ã‚‹å¤‰æ•°
    let onModalHiddenCallback = null;

    function copyFullData(elementId) {
        const elementToSelect = document.getElementById(elementId);
        
        // ãƒ†ã‚­ã‚¹ãƒˆã‚’é¸æŠçŠ¶æ…‹ã«ã™ã‚‹
        const range = document.createRange();
        range.selectNodeContents(elementToSelect);
        
        const selection = window.getSelection();
        selection.removeAllRanges(); // æ—¢å­˜ã®é¸æŠç¯„å›²ã‚’ã‚¯ãƒªã‚¢
        selection.addRange(range);   // æ–°ã—ã„ç¯„å›²ã‚’é¸æŠ
        
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«æ‰‹å‹•ã‚³ãƒ”ãƒ¼ã‚’ä¿ƒã™
        if (typeof showToast === 'function') {
            showToast('ãƒ†ã‚­ã‚¹ãƒˆé¸æŠå®Œäº†', 'ãƒ†ã‚­ã‚¹ãƒˆã‚’é¸æŠã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ã€‚');
        } else {
            alert('ãƒ†ã‚­ã‚¹ãƒˆã‚’é¸æŠã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ã€‚');
        }
    }

    function showInfoModal(element) {
        event.stopPropagation();

        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãå‰ã«ã€ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ã‚’é–‰ã˜ãŸçŠ¶æ…‹ã«ãƒªã‚»ãƒƒãƒˆã™ã‚‹
        const collapseElement = document.getElementById('collapseFullData');
        if (collapseElement.classList.contains('show')) {
            collapseElement.classList.remove('show');
        }

        const user = JSON.parse(element.closest('tr').dataset.user);
        document.getElementById('modal-user-name').textContent = user.name;
        // <textarea> ã«å€¤ã‚’è¨­å®šã™ã‚‹ãŸã‚ã« .value ã‚’ä½¿ç”¨
        document.getElementById('modal-comment-text').value = user.comment_text || ''; // å€¤ã‚’ã‚»ãƒƒãƒˆ
        document.getElementById('modal-full-data').textContent = JSON.stringify(user, null, 2);
        // ä¿å­˜ãƒœã‚¿ãƒ³ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’ã‚»ãƒƒãƒˆ
        document.getElementById('modal-save-comment-btn').dataset.userId = user.id;

        // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒšãƒ¼ã‚¸ã¸ã®ãƒªãƒ³ã‚¯
        const profileLink = document.getElementById('modal-profile-link');
        if (user.profile_page_url && user.profile_page_url !== 'å–å¾—å¤±æ•—') {
            profileLink.href = user.profile_page_url;
            profileLink.style.display = 'inline-block';
        } else {
            profileLink.style.display = 'none';
        }

        // æœ€å¾Œã«ã‚³ãƒ¡ãƒ³ãƒˆã—ãŸæŠ•ç¨¿ã¸ã®ãƒªãƒ³ã‚¯
        const lastCommentLink = document.getElementById('modal-last-comment-link');
        if (user.last_commented_post_url) {
            lastCommentLink.href = user.last_commented_post_url;
            lastCommentLink.style.display = 'inline-block';
        } else {
            lastCommentLink.style.display = 'none';
        }

        infoModalInstance.show();
    }

    async function updateComment() {
        const saveBtn = document.getElementById('modal-save-comment-btn');
        const userId = saveBtn.dataset.userId;
        const newComment = document.getElementById('modal-comment-text').value;

        if (!userId) {
            alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚');
            return;
        }

        // ãƒœã‚¿ãƒ³ã‚’ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã«ã™ã‚‹
        const originalIcon = saveBtn.innerHTML;
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';

        try {
            const response = await fetch('/api/users/update-comment', {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_id: userId, comment_text: newComment })
            });

            const result = await response.json();
            if (!response.ok) {
                throw new Error(result.detail || 'ã‚³ãƒ¡ãƒ³ãƒˆã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            }

            // ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒå®Œå…¨ã«é–‰ã˜ãŸå¾Œã«ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æ›´æ–°ã™ã‚‹ãŸã‚ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°ã‚’è¨­å®š
            onModalHiddenCallback = () => {
                const row = document.getElementById(`user-row-${userId}`);
                if (row) {
                    let user = JSON.parse(row.dataset.user);
                    user.comment_text = newComment;
                    row.dataset.user = JSON.stringify(user);
                    row.querySelector('.text-muted.small').textContent = newComment;
                    row.querySelector('.text-muted.small').title = newComment;
                }
                // ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’ã“ã“ã§å…ƒã«æˆ»ã™
                saveBtn.disabled = false;
                saveBtn.innerHTML = originalIcon;
                onModalHiddenCallback = null; // ä¸€åº¦å®Ÿè¡Œã—ãŸã‚‰ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’ãƒªã‚»ãƒƒãƒˆ
            };
            infoModalInstance.hide();
        } catch (error) {
            alert(`ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            // ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’å…ƒã«æˆ»ã™
            saveBtn.disabled = false;
            saveBtn.innerHTML = originalIcon;
        }
    }

    function getSelectedUserIds() {
        return Array.from(document.querySelectorAll('#user-table-body tr.selected')).map(row => {
            return row.id.replace('user-row-', '');
        });
    }

    function updateBulkActionButtons() {
        const selectedIds = getSelectedUserIds();
        const disabled = selectedIds.length === 0;
        document.getElementById('bulk-execute-btn').disabled = disabled;
        document.getElementById('bulk-dryrun-btn').disabled = disabled;
        document.getElementById('bulk-skip-btn').disabled = disabled;
    }

    function toggleSelectAll() {
        const allRows = document.querySelectorAll('#user-table-body tr');
        const isAllSelected = getSelectedUserIds().length === allRows.length;

        allRows.forEach(row => {
            row.classList.toggle('selected', !isAllSelected);
        });
        updateBulkActionButtons();
    }

    function getSelectedUsers() {
        return Array.from(document.querySelectorAll('#user-table-body tr.selected')).map(row => {
            return JSON.parse(row.dataset.user.replace(/&quot;/g, '"').replace(/&apos;/g, "'"));
        });
    }

    async function bulkExecute() {
        const selectedUsers = getSelectedUsers();
        const selectedRows = Array.from(document.querySelectorAll('#user-table-body tr.selected'));
        if (selectedUsers.length === 0) return;
        if (!confirm(`${selectedUsers.length}ä»¶ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã€Œã„ã„ã­ãƒãƒƒã‚¯ï¼†ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿ã€ã‚’å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ`)) return;

        // å…ˆã«UIã‹ã‚‰è¡Œã‚’å‰Šé™¤ã—ã€ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
        selectedRows.forEach(row => row.remove());
        updateBulkActionButtons();

        try {
            const response = await fetch('/api/users/bulk-engage', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ users: selectedUsers, dry_run: false })
            });
            if (!response.ok) {
                const result = await response.json();
                throw new Error(result.detail || 'ã‚¨ãƒ³ã‚²ãƒ¼ã‚¸ãƒ¡ãƒ³ãƒˆã‚¿ã‚¹ã‚¯ã®é–‹å§‹ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            }
            // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§å‡¦ç†ã•ã‚Œã‚‹ãŸã‚ã€ã“ã“ã§ã¯è¡¨ç¤ºã—ãªã„ã‹ã€ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«å‡ºåŠ›ã™ã‚‹ç¨‹åº¦ã«ç•™ã‚ã‚‹
            console.log('ã‚¨ãƒ³ã‚²ãƒ¼ã‚¸ãƒ¡ãƒ³ãƒˆã‚¿ã‚¹ã‚¯ã‚’é–‹å§‹ã—ã¾ã—ãŸã€‚');
        } catch (error) {
            alert(`ã‚¨ãƒ©ãƒ¼: ${error.message}`);
        }
    }

    async function bulkDryRun() {
        const selectedUsers = getSelectedUsers();
        const selectedRows = Array.from(document.querySelectorAll('#user-table-body tr.selected'));
        if (selectedUsers.length === 0) return;
        if (!confirm(`${selectedUsers.length}ä»¶ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã€ŒæŠ•ç¨¿äºˆè¡Œï¼ˆãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³ï¼‰ã€ã‚’å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ\nå®Ÿéš›ã®æŠ•ç¨¿ã¯è¡Œã‚ã‚Œãšã€ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆãŒä¿å­˜ã•ã‚Œã¾ã™ã€‚`)) return;

        // ãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³ã§ã¯UIã‹ã‚‰è¡Œã‚’å‰Šé™¤ã—ãªã„
        // selectedRows.forEach(row => row.remove());
        // updateBulkActionButtons();

        try {
            const response = await fetch('/api/users/bulk-engage', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ users: selectedUsers, dry_run: true }) // dry_runãƒ•ãƒ©ã‚°ã‚’trueã«
            });
            if (!response.ok) {
                const result = await response.json();
                throw new Error(result.detail || 'ãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³ã‚¿ã‚¹ã‚¯ã®é–‹å§‹ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            }
            alert('æŠ•ç¨¿äºˆè¡Œï¼ˆãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³ï¼‰ã‚¿ã‚¹ã‚¯ã‚’é–‹å§‹ã—ã¾ã—ãŸã€‚è©³ç´°ã¯ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
        } catch (error) {
            alert(`ã‚¨ãƒ©ãƒ¼: ${error.message}`);
        }
    }

    async function bulkSkip() {
        const userIds = getSelectedUserIds();
        if (userIds.length === 0) return;
        if (!confirm(`${userIds.length}ä»¶ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã‹ï¼Ÿ`)) return;

        // å…ˆã«UIã‹ã‚‰è¡Œã‚’å‰Šé™¤ã—ã€ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
        const selectedRows = userIds.map(id => document.getElementById(`user-row-${id}`));
        selectedRows.forEach(row => { if(row) row.remove(); });
        updateBulkActionButtons();

        try {
            const response = await fetch('/api/users/bulk-skip', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_ids: userIds })
            });
            const result = await response.json();
            if (!response.ok) {
                throw new Error(result.detail || 'ã‚¹ã‚­ãƒƒãƒ—å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            }
            // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ä¸è¦ãªãŸã‚å‰Šé™¤
            console.log(result.message);
        } catch (error) {
            alert(`ã‚¨ãƒ©ãƒ¼: ${error.message}`);
        }
    }

    function updateViewOptions() {
        const showAll = document.getElementById('show-all-users-switch').checked;
        const filterContainer = document.getElementById('filter-container');
        const bulkActionsWrapper = document.getElementById('bulk-actions-wrapper');

        filterContainer.style.display = showAll ? 'block' : 'none';
        // Bootstrapã®ã‚¯ãƒ©ã‚¹ã‚’ä½¿ã£ã¦è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹
        bulkActionsWrapper.classList.toggle('d-none', showAll);
    }

    function fetchUsers() {
        const showAll = document.getElementById('show-all-users-switch').checked;
        let apiUrl = '/api/comment-targets';
        const searchKeyword = document.getElementById('user-search-input').value;

        if (showAll) {
            const sortBy = document.getElementById('sort-select').value;
            apiUrl = `/api/comment-targets?all=true&sort=${sortBy}&search=${encodeURIComponent(searchKeyword)}`;
        }

        // ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã«ã™ã‚‹
        const tableBody = document.getElementById('user-table-body');
        tableBody.innerHTML = '<tr><td colspan="4" class="text-center"><div class="spinner-border spinner-border-sm" role="status"><span class="visually-hidden">Loading...</span></div></td></tr>';

        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒãªã‘ã‚Œã°åˆæœŸåŒ–ã—ã€ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
        if (!infoModalInstance) {
            const modalElement = document.getElementById('infoModal');
            infoModalInstance = new bootstrap.Modal(modalElement);
            // ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒå®Œå…¨ã«é–‰ã˜ãŸå¾Œã«ç™ºç«ã™ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆã‚’æ•æ‰
            modalElement.addEventListener('hidden.bs.modal', function () {
                if (onModalHiddenCallback) onModalHiddenCallback();
            });
        }

        fetch(apiUrl)
            .then(response => {
                if (!response.ok) {
                    if (response.status === 404) return []; // 404ã®å ´åˆã¯ç©ºã®é…åˆ—ã‚’è¿”ã™
                    throw new Error('APIã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                }
                return response.json();
            })
            .then(data => {
                tableBody.innerHTML = '';
                if (data.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="4" class="text-center">ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿å¯¾è±¡ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã„ã¾ã›ã‚“ã€‚</td></tr>';
                    return;
                }
                let allRowsHtml = '';
                data.forEach(user => {
                    // HTMLå±æ€§ã«è¨­å®šã™ã‚‹ãŸã‚ã€JSONæ–‡å­—åˆ—å†…ã®ã‚·ãƒ³ã‚°ãƒ«ã‚¯ã‚©ãƒ¼ãƒˆã‚’ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã™ã‚‹
                    const escapedUserJson = JSON.stringify(user).replace(/'/g, '&#39;');

                    const lastCommented = user.last_commented_at ? new Date(user.last_commented_at).toLocaleDateString('ja-JP') : 'ãªã—';
                    
                    // ãƒ•ã‚©ãƒ­ãƒ¼çŠ¶æ…‹ã®ã‚¢ã‚¤ã‚³ãƒ³ã‚’æ±ºå®š
                    // è‡ªåˆ†ãŒãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ã„ã‚‹ã‹ (is_following)
                    const isFollowingIcon = user.is_following ? '<i class="bi bi-person-check-fill text-success" title="ã‚ãªãŸãŒãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ã„ã¾ã™"></i>' : '';
                    // ç›¸æ‰‹ãŒãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ãã‚ŒãŸã‹ (follow_count)
                    const followedByIcon = user.follow_count > 0 ? '<i class="bi bi-person-heart text-danger" title="ç›¸æ‰‹ã‹ã‚‰ãƒ•ã‚©ãƒ­ãƒ¼ã•ã‚Œã¾ã—ãŸ"></i>' : '';

                    // --- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³æ•°ã®è¡¨ç¤ºãƒ­ã‚¸ãƒƒã‚¯ ---
                    let likeDisplay;
                    if (showAll) {
                        // å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼è¡¨ç¤ºã®å ´åˆ: ç´¯è¨ˆ + ä»Šã‚»ãƒƒã‚·ãƒ§ãƒ³ã®åˆè¨ˆå€¤ã‚’è¡¨ç¤º
                        likeDisplay = (user.like_count || 0) + (user.recent_like_count || 0);
                    } else {
                        // é€šå¸¸è¡¨ç¤ºã®å ´åˆ: ä»Šã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ã„ã„ã­æ•°ã‚’è¡¨ç¤ºï¼ˆç´¯è¨ˆãŒã‚ã‚Œã° `+` ã‚’ä»˜ã‘ã‚‹ï¼‰
                        const recentLikes = user.recent_like_count || 0;
                        const totalLikes = user.like_count || 0;
                        likeDisplay = recentLikes < totalLikes ? `${recentLikes}+` : recentLikes;
                    }


                    // --- æœ€çµ‚ã‚¢ã‚¯ã‚·ãƒ§ãƒ³æ™‚åˆ»ã‚’ç›¸å¯¾è¡¨è¨˜ã«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ ---
                    let latestActionTime, timeIcon;
                    if (user.latest_action_timestamp) {
                        const now = new Date();
                        const actionDate = new Date(user.latest_action_timestamp);
                        const diffMinutes = Math.floor((now - actionDate) / (1000 * 60));
                        const diffHours = Math.floor(diffMinutes / 60);
                        const diffDays = Math.floor(diffHours / 24);

                        if (diffMinutes < 60) {
                            latestActionTime = `${diffMinutes}åˆ†å‰`;
                        } else if (diffHours < 24) {
                            latestActionTime = `${diffHours}æ™‚é–“å‰`;
                        } else {
                            latestActionTime = `${diffDays}æ—¥å‰`;
                        }
                        timeIcon = '<i class="bi bi-clock me-1"></i>';
                    } else {
                        latestActionTime = 'N/A';
                        timeIcon = '<i class="bi bi-clock me-1"></i>';
                    }
                    // ã‚¹ãƒãƒ›è¡¨ç¤ºã§ã¯ã‚¢ã‚¤ã‚³ãƒ³ã‚’éè¡¨ç¤ºã«ã™ã‚‹
                    if (window.innerWidth < 768) {
                        timeIcon = '';
                    }

                    // 3æ—¥ä»¥ä¸ŠçµŒé & 5ã„ã„ã­ä»¥ä¸Šã®å„ªå…ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚¢ã‚¤ã‚³ãƒ³ã‚’è¿½åŠ 
                    let priorityIcon = '';
                    const threeDaysAgo = new Date();
                    threeDaysAgo.setDate(threeDaysAgo.getDate() - 3);
                    if ((user.last_commented_at && new Date(user.last_commented_at) < threeDaysAgo && user.recent_like_count >= 5)) {
                        priorityIcon = '<div class="priority-icon" title="å†ã‚³ãƒ¡ãƒ³ãƒˆå¯¾è±¡ã®å„ªå…ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ã™ï¼ˆæœ€çµ‚ã‚³ãƒ¡ãƒ³ãƒˆã‹ã‚‰3æ—¥ä»¥ä¸ŠçµŒé ï¼† ä»Šå›5ã„ã„ã­ä»¥ä¸Šï¼‰">ğŸ”¥</div>';
                    }

                    // --- ã‚¨ãƒ³ã‚²ãƒ¼ã‚¸ãƒ¡ãƒ³ãƒˆã‚¿ã‚¤ãƒ—ã¨ã‚³ãƒ¡ãƒ³ãƒˆã®çŠ¶æ…‹ã«å¿œã˜ãŸè¡¨ç¤º ---
                    let engagementIcon = '';
                    let commentClass = 'text-muted small truncate-cell';
                    let commentTitle = user.comment_text || '';

                    if (user.engagement_type === 'comment') {
                        engagementIcon = '<span title="ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿å¯¾è±¡" class="me-1">ğŸ’¬</span>';
                    } else if (user.engagement_type === 'like_only') {
                        engagementIcon = '<span title="ã„ã„ã­è¿”ã—ã®ã¿å¯¾è±¡" class="me-1">â¤ï¸</span>';
                    }

                    // ã‚³ãƒ¡ãƒ³ãƒˆãŒæŠ•ç¨¿æ¸ˆã¿ï¼ˆå¤ã„ï¼‰ã‹ã©ã†ã‹ã‚’åˆ¤å®š
                    const isCommentOld = user.last_commented_at && user.comment_generated_at &&
                                         new Date(user.comment_generated_at) <= new Date(user.last_commented_at);

                    if (isCommentOld) {
                        commentClass += ' text-decoration-line-through'; // å¤ã„ã‚³ãƒ¡ãƒ³ãƒˆã«å–ã‚Šæ¶ˆã—ç·šã‚’è¿½åŠ 
                        commentTitle = `ï¼ˆæŠ•ç¨¿æ¸ˆã¿ï¼‰${commentTitle}`;
                    }

                    // --- ã‚¨ãƒ©ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³ã®è¡¨ç¤º ---
                    let errorIcon = '';
                    if (user.last_engagement_error) {
                        errorIcon = `<span title="${user.last_engagement_error}" class="me-1">ğŸš¨</span>`;
                    }

                    const row = `
                        <tr id="user-row-${user.id}" data-user='${escapedUserJson}'>
                            <td class="align-middle text-center">
                                <div class="icon-container">
                                    <a href="${user.profile_page_url || '#'}" target="_blank" rel="noopener noreferrer">
                                        <img src="${user.profile_image_url || 'https://via.placeholder.com/50'}" alt="${user.name}" class="user-icon img-thumbnail">
                                    </a>
                                    <div class="status-icons">${isFollowingIcon} ${followedByIcon}</div>${priorityIcon}
                                </div>
                            </td>
                            <td class="text-start" style="min-width: 0;">
                                <div class="fw-bold truncate-cell" title="${user.name || ''}">${errorIcon}${engagementIcon}${user.name || ''}</div>
                                <div class="${commentClass}" title="${commentTitle}">${user.comment_text || ''}</div>
                            </td>
                            <td class="small text-muted" style="min-width: 0;">
                                <div class="d-flex flex-wrap align-items-center gap-2">
                                    <span class="text-nowrap">â¤ï¸ ${likeDisplay}</span>
                                    <span title="æœ€çµ‚ã‚¢ã‚¯ã‚·ãƒ§ãƒ³æ—¥æ™‚">${timeIcon}${latestActionTime}</span>
                                </div>
                            </td>
                            <td class="text-center">
                                <div class="d-flex justify-content-center align-items-center h-100">
                                    <button type="button" class="btn btn-link p-0 text-secondary" onclick="showInfoModal(this.closest('tr'))" title="è©³ç´°æƒ…å ±ã‚’è¡¨ç¤º"><i class="bi bi-info-circle fs-4"></i></button>
                                </div>
                            </td>
                        </tr>
                    `;
                    allRowsHtml += row;
                });
                // ç”Ÿæˆã—ãŸã™ã¹ã¦ã®è¡ŒHTMLã‚’ä¸€åº¦ã«ãƒ†ãƒ¼ãƒ–ãƒ«ã«æŒ¿å…¥ã™ã‚‹
                tableBody.innerHTML = allRowsHtml;
            })
            .catch(error => {
                console.error('Error:', error);
                const tableBody = document.getElementById('user-table-body');
                tableBody.innerHTML = `<tr><td colspan="4" class="text-center text-danger">${error.message}</td></tr>`;
            });

    }

    document.addEventListener('DOMContentLoaded', function () {
        // Tooltipã®åˆæœŸåŒ– (ã“ã®ãƒšãƒ¼ã‚¸å†…ã®ã™ã¹ã¦ã®ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ã‚’æœ‰åŠ¹ã«ã™ã‚‹)
        const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
        [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl));

        // ã‚³ãƒ¡ãƒ³ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’ç”Ÿæˆ
        const templateList = document.getElementById('comment-template-list');
        commentTemplates.forEach((template, index) => {
            const li = document.createElement('li');
            const a = document.createElement('a');
            a.className = 'dropdown-item';
            a.href = '#';
            a.textContent = template.name;
            a.onclick = (e) => { e.preventDefault(); applyTemplate(index); };
            li.appendChild(a);
            templateList.appendChild(li);
        });

        updateViewOptions(); // åˆæœŸè¡¨ç¤ºæ™‚ã®UIçŠ¶æ…‹ã‚’è¨­å®š
        fetchUsers();
        const tableBody = document.getElementById('user-table-body');
        tableBody.addEventListener('click', function (e) {
            const rows = Array.from(tableBody.querySelectorAll('tr'));
            const row = e.target.closest('tr');
            if (!row) return;

            // è©³ç´°ãƒœã‚¿ãƒ³åˆ—(4ç•ªç›®)ã¾ãŸã¯ãƒªãƒ³ã‚¯ã®ã‚¯ãƒªãƒƒã‚¯ã¯ç„¡è¦–
            const cell = e.target.closest('td');
            if (e.target.closest('a') || (cell && cell.cellIndex === 3)) {
                return;
            }

            const currentIndex = rows.indexOf(row);

            if (e.shiftKey && lastSelectedRowIndex !== null) {
                // Shift + Click: ç¯„å›²é¸æŠ
                const start = Math.min(currentIndex, lastSelectedRowIndex);
                const end = Math.max(currentIndex, lastSelectedRowIndex);
                rows.forEach((r, index) => {
                    if (index >= start && index <= end) {
                        r.classList.add('selected');
                    }
                });
                lastSelectedRowIndex = currentIndex; // Shifté¸æŠå¾Œã‚‚lastSelectedã‚’æ›´æ–°
            } else if (e.ctrlKey || e.metaKey) {
                // Ctrl/Cmd + Click: å€‹åˆ¥é¸æŠ/é¸æŠè§£é™¤
                row.classList.toggle('selected');
                lastSelectedRowIndex = currentIndex;
            } else {
                // é€šå¸¸ã®ã‚¯ãƒªãƒƒã‚¯: ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®ã‚ˆã†ã«é¸æŠ/é¸æŠè§£é™¤ã‚’ãƒˆã‚°ãƒ«ã™ã‚‹
                row.classList.toggle('selected');
                lastSelectedRowIndex = currentIndex;
            }
            updateBulkActionButtons();
        });
    });

    // æ¤œç´¢ãƒœãƒƒã‚¯ã‚¹ã®å…¥åŠ›ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
    let searchTimeout;
    document.getElementById('user-search-input').addEventListener('input', function() {
        clearTimeout(searchTimeout);
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å…¥åŠ›ã‚’å¾…ã¤ï¼ˆ300ãƒŸãƒªç§’ï¼‰
        searchTimeout = setTimeout(() => {
            fetchUsers();
        }, 300);
    });
</script>
{% endblock %}
