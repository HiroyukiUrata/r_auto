{% extends "base.html" %}

{% block title %}キーワード管理 - {{ super() }}{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="accordion" id="profileAccordion">
        <div class="accordion-item">
            <h2 class="accordion-header" id="headingOne">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="false" aria-controls="collapseOne">
                    <i class="bi bi-collection-fill me-2"></i>キーワードプロファイル管理
                </button>
            </h2>
            <div id="collapseOne" class="accordion-collapse collapse" aria-labelledby="headingOne" data-bs-parent="#profileAccordion">
                <div class="accordion-body">
                    <div class="row g-2 align-items-center">
                        <div class="col-sm-4">
                            <label for="profile-select" class="form-label">プロファイルを選択</label>
                            <select id="profile-select" class="form-select"></select>
                        </div>
                        <div class="col-sm-8 d-flex align-items-end gap-2">
                            <button class="btn btn-primary" onclick="loadProfile()"><i class="bi bi-box-arrow-in-down me-1"></i>読み込み</button>
                            <button class="btn btn-danger" onclick="deleteProfile()"><i class="bi bi-trash me-1"></i>削除</button>
                        </div>
                    </div>
                    <hr>
                    <div class="row g-2 align-items-center">
                        <div class="col-sm-4">
                            <label for="new-profile-name" class="form-label">現在のキーワードを名前を付けて保存</label>
                            <input type="text" id="new-profile-name" class="form-control" placeholder="例: ファッション用">
                        </div>
                        <div class="col-sm-8 d-flex align-items-end"><button class="btn btn-success" onclick="saveProfile()"><i class="bi bi-save me-1"></i>保存</button></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-6 mb-4">
        <div class="card h-100">
            <div class="card-header">キーワードA群（商品カテゴリ）</div>
            <div class="card-body d-flex flex-column">
                <p class="text-muted small">検索対象とする商品カテゴリを選択してください。</p>
                <div class="accordion" id="genreAccordion">
                    <!-- カテゴリ別アコーディオンがここに挿入されます -->
                </div>
                <div id="keywords-a-container" class="d-none"></div>
            </div>
        </div>
    </div>
    <div class="col-md-6 mb-4">
        <div class="card h-100">
            <div class="card-header">キーワードB群（装飾・絞り込み用）</div>
            <div class="card-body d-flex flex-column">
                <div id="keywords-b-container" class="keyword-container mb-3"></div>
                <div class="input-group mt-auto">
                    <input type="text" id="new-keyword-b" class="form-control" placeholder="キーワードを追加">
                    <button class="btn btn-outline-secondary" type="button" onclick="addKeyword('b')">追加</button>
                </div>
            </div>
        </div>
    </div>
</div>
<button class="btn btn-primary" onclick="saveKeywords()"><i class="bi bi-check-circle me-1"></i>すべてのキーワードを保存</button>
{% endblock %}

{% block scripts %}
<script>
    const GENRE_CATEGORIES = {
        "ファッション": ["100371", "551177", "100433", "216131", "558885", "558929", "216129"],
        "食品・飲料": ["100227", "551167", "100316", "510915", "510901"],
        "家電・デジタル": ["562637", "211742", "100026", "564500", "565004"],
        "生活・インテリア": ["100804", "215783", "558944", "101213", "100005"],
        "美容・健康": ["100939", "100938", "551169"],
        "趣味・ホビー": ["566382", "101070", "200162", "101240", "101205", "101164", "112493"],
        "キッズ・ベビー": ["100533"],
        "車・バイク": ["101114", "503190"],
        "その他": ["101438", "111427", "101381", "100000"]
    };

    const RAKUTEN_GENRES = {
        "100371": "レディースファッション", "551177": "メンズファッション", "100433": "インナー・下着・ナイトウェア", "216131": "バッグ・小物・ブランド雑貨", "558885": "靴", "558929": "腕時計", "216129": "ジュエリー・アクセサリー",
        "100227": "食品", "551167": "スイーツ・お菓子", "100316": "水・ソフトドリンク", "510915": "ビール・洋酒", "510901": "日本酒・焼酎",
        "562637": "家電", "211742": "TV・オーディオ・カメラ", "100026": "パソコン・周辺機器", "564500": "スマートフォン・タブレット", "565004": "光回線・モバイル通信",
        "100804": "インテリア・寝具・収納", "215783": "日用品雑貨・文房具・手芸", "558944": "キッチン用品・食器・調理器具", "101213": "ペット・ペットグッズ", "100005": "花・ガーデン・DIY",
        "100939": "美容・コスメ・香水", "100938": "ダイエット・健康", "551169": "医薬品・コンタクト・介護",
        "566382": "おもちゃ", "101070": "スポーツ・アウトドア", "200162": "本・雑誌・コミック", "101240": "CD・DVD", "101205": "テレビゲーム", "101164": "ホビー", "112493": "楽器・音響機器",
        "100533": "キッズ・ベビー・マタニティ",
        "101114": "車・バイク", "503190": "車用品・バイク用品",
        "101438": "サービス・リフォーム", "111427": "住宅・不動産", "101381": "カタログギフト・チケット", "100000": "百貨店・総合通販・ギフト"
    };

    function renderGenreCheckboxes(savedKeywords = []) {
        const accordionContainer = document.getElementById('genreAccordion');
        accordionContainer.innerHTML = '';

        Object.entries(GENRE_CATEGORIES).forEach(([categoryName, genreIds], index) => {
            const categoryId = `category-${index}`;
            const selectedCount = genreIds.filter(id => savedKeywords.includes(id)).length;

            const accordionItem = document.createElement('div');
            accordionItem.className = 'accordion-item';
            accordionItem.innerHTML = `
                <h2 class="accordion-header" id="heading-${categoryId}">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-${categoryId}" aria-expanded="false" aria-controls="collapse-${categoryId}">
                        ${categoryName}
                        <span class="badge bg-primary rounded-pill ms-auto me-2" id="badge-${categoryId}">${selectedCount > 0 ? selectedCount : ''}</span>
                    </button>
                </h2>
                <div id="collapse-${categoryId}" class="accordion-collapse collapse" aria-labelledby="heading-${categoryId}">
                    <div class="accordion-body">
                        ${genreIds.map(id => {
                            const isChecked = savedKeywords.includes(id);
                            return `
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="${id}" id="genre-${id}" ${isChecked ? 'checked' : ''} onchange="updateBadgeCount('${categoryId}', ${genreIds.length})">
                                    <label class="form-check-label" for="genre-${id}">${RAKUTEN_GENRES[id]}</label>
                                </div>`;
                        }).join('')}
                    </div>
                </div>
            `;
            accordionContainer.appendChild(accordionItem);
        });
    }

    function updateBadgeCount(categoryId, totalCount) {
        const collapseElement = document.getElementById(`collapse-${categoryId}`);
        const selectedCount = collapseElement.querySelectorAll('.form-check-input:checked').length;
        const badge = document.getElementById(`badge-${categoryId}`);
        badge.textContent = selectedCount > 0 ? selectedCount : '';
    }

    function getSelectedGenres() {
        const container = document.getElementById('genreAccordion');
        return Array.from(container.querySelectorAll('.form-check-input:checked')).map(input => input.value);
    }

    async function fetchKeywords() {
        try {
            const response = await fetch('/api/keywords');
            const data = await response.json();
            renderGenreCheckboxes(data.keywords_a);
            renderKeywords('b', data.keywords_b);
        } catch (error) {
            console.error('Failed to fetch keywords:', error);
            alert('キーワードの読み込みに失敗しました。');
        }
    }

    function renderKeywords(group, keywords) {
        const container = document.getElementById(`keywords-${group}-container`);
        container.innerHTML = '';
        keywords.forEach(keyword => {
            const badge = document.createElement('span');
            badge.className = 'badge rounded-pill bg-primary me-2 mb-2 p-2 d-inline-flex align-items-center';
            badge.innerHTML = `
                ${keyword}
                <button type="button" class="btn-close btn-close-white ms-2" aria-label="Close" onclick="this.parentElement.remove()"></button>
            `;
            container.appendChild(badge);
        });
    }

    function addKeyword(group) {
        const input = document.getElementById(`new-keyword-${group}`);
        const keyword = input.value.trim();
        if (keyword) {
            renderKeywords(group, [keyword, ...getKeywordsFromDOM('b')]);
            input.value = '';
        }
    }

    async function saveKeywords(showMessages = true) {
        const keywords_a = getSelectedGenres();
        const keywords_b = getKeywordsFromDOM('b');

        try {
            if (showMessages) {
                if (!confirm('現在のキーワード設定を保存しますか？')) return false;
            }
            const response = await fetch('/api/keywords', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ keywords_a, keywords_b })
            });
            const result = await response.json();
            if (!response.ok) throw new Error(result.message || 'キーワードの保存に失敗しました。');
            if (showMessages) {
                alert(result.message);
            }
            return true; // 成功したことを示す
        } catch (error) {
            if (showMessages) alert(`エラー: ${error.message}`);
            return false; // 失敗したことを示す
        }
    }

    function getKeywordsFromDOM(group) {
        const container = document.getElementById(`keywords-${group}-container`);
        return Array.from(container.querySelectorAll('.badge')).map(badge => {
            // テキストノードのみを取得して、ボタンのテキスト（"Close"など）を含めないようにする
            return badge.childNodes[0].nodeValue.trim();
        });
    }

    async function fetchProfiles() {
        try {
            const response = await fetch('/api/keyword-profiles');
            const profiles = await response.json();
            const select = document.getElementById('profile-select');
            select.innerHTML = '<option value="">-- プロファイルを選択 --</option>';
            profiles.forEach(p => {
                const option = document.createElement('option');
                option.value = p;
                option.textContent = p;
                select.appendChild(option);
            });
        } catch (error) {
            console.error('Failed to fetch profiles:', error);
        }
    }

    async function loadProfile() {
        const select = document.getElementById('profile-select');
        const profileName = select.value;
        if (!profileName) {
            alert('読み込むプロファイルを選択してください。');
            return;
        }
        if (!confirm(`プロファイル「${profileName}」を読み込みますか？\n現在のキーワード設定は上書きされます。`)) return;

        try {
            const response = await fetch(`/api/keyword-profiles/${profileName}`, { method: 'PUT' });
            const result = await response.json();
            if (!response.ok) throw new Error(result.message);
            alert(result.message);
            await fetchKeywords(); // 画面を更新
        } catch (error) {
            alert(`エラー: ${error.message}`);
        }
    }

    async function saveProfile() {
        const input = document.getElementById('new-profile-name');
        const profileName = input.value.trim();
        if (!profileName) {
            alert('プロファイル名を入力してください。');
            return;
        }
        
        if (!confirm(`現在のキーワード設定を「${profileName}」として保存しますか？`)) {
            return;
        }

        // 1. まずUI上のキーワードをメッセージなしで保存
        const keywordsSaved = await saveKeywords(false);
        if (!keywordsSaved) return; // キーワード保存に失敗したら中断

        try {
            const response = await fetch('/api/keyword-profiles', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ profile_name: profileName })
            });
            const result = await response.json();
            if (!response.ok) throw new Error(result.message);
            alert(`キーワードを保存し、プロファイル「${profileName}」を作成しました。`);
            input.value = '';
            await fetchProfiles(); // プロファイル一覧を更新
        } catch (error) {
            alert(`エラー: ${error.message}`);
        }
    }

    async function deleteProfile() {
        const select = document.getElementById('profile-select');
        const profileName = select.value;
        if (!profileName) {
            alert('削除するプロファイルを選択してください。');
            return;
        }
        if (!confirm(`本当にプロファイル「${profileName}」を削除しますか？この操作は元に戻せません。`)) return;

        try {
            const response = await fetch(`/api/keyword-profiles/${profileName}`, { method: 'DELETE' });
            const result = await response.json();
            if (!response.ok) throw new Error(result.message);
            alert(result.message);
            await fetchProfiles(); // プロファイル一覧を更新
        } catch (error) {
            alert(`エラー: ${error.message}`);
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        fetchKeywords();
        fetchProfiles();
    });
</script>
{% endblock %}

{% block styles %}
<style>
    #keywords-b-container {
        min-height: 200px;
    }
</style>
{% endblock %}