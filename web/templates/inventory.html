{% extends "base.html" %}

{% block title %}在庫確認 - R-Auto Control Panel{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">在庫確認 (未投稿リスト)</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <button type="button" class="btn btn-sm btn-outline-warning" id="bulk-complete-btn" onclick="bulkComplete()" disabled>
                <i class="bi bi-check-circle-fill me-1"></i>選択した項目を強制済
            </button>
            <button type="button" class="btn btn-sm btn-outline-secondary" id="select-all-toggle-btn" onclick="toggleSelectAll()">
                <i class="bi bi-check-square me-1"></i>すべて選択
            </button>
            <button type="button" class="btn btn-sm btn-outline-info" id="shuffle-btn">
                <i class="bi bi-shuffle me-1"></i>シャッフル
            </button>
            <button type="button" class="btn btn-sm btn-outline-danger" id="bulk-delete-btn" onclick="bulkDelete()" disabled>
                <i class="bi bi-trash-fill me-1"></i>選択した項目を削除
            </button>
        </div>
    </div>
</div>

<div class="accordion mb-4" id="importAccordion">
    <div class="accordion-item">
        <h2 class="accordion-header" id="headingOne">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="false" aria-controls="collapseOne">
                <i class="bi bi-file-earmark-arrow-down-fill me-2"></i>JSONから商品を一括インポート（クリックして展開）
            </button>
        </h2>
        <div id="collapseOne" class="accordion-collapse collapse" aria-labelledby="headingOne" data-bs-parent="#importAccordion">
            <div class="accordion-body">
                <div class="mb-3">
                    <label for="json-import-textarea" class="form-label">ここにJSONデータを貼り付けてください</label>
                    <textarea class="form-control" id="json-import-textarea" rows="5" placeholder="[&#10;  {&#10;    &quot;item_description&quot;: &quot;すごいガジェット&quot;,&#10;    &quot;page_url&quot;: &quot;https://...&quot;,&#10;    &quot;image_url&quot;: &quot;https://...&quot;&#10;  },&#10;  ...&#10;]"></textarea>
                </div>
                <button class="btn btn-primary" onclick="importFromJson()">
                    <i class="bi bi-upload me-1"></i>インポートして後続タスクを実行
                </button>
                <p class="text-muted small mt-2">インポートが完了すると、自動的に「投稿URL取得」→「投稿文作成」のフローが開始されます。</p>
            </div>
        </div>
    </div>
</div>

<div class="row mb-3" id="status-summary">
    <!-- ステータスサマリーはここに挿入されます -->
</div>

<div class="table-responsive">
    <table class="table table-striped table-sm align-middle" style="table-layout: fixed; width: 100%;">
        <thead>
            <tr>
                <th scope="col" style="width: 5%;"></th>
                <th scope="col" style="width: 5%;"></th>
                <th scope="col" style="width: 7%;">サムネイル</th>
                <th scope="col" style="width: 60%;">商品情報</th>
                <th scope="col" style="width: 7%;">ステータス</th>
                <th scope="col" style="width: 8%;">作成日</th>
            </tr>
        </thead>
        <tbody id="inventory-table-body">
            <!-- データはJavaScriptでここに挿入されます -->
        </tbody>
    </table>
</div>

<!-- 商品情報詳細モーダル -->
<div class="modal fade" id="infoModal" tabindex="-1" aria-labelledby="infoModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="infoModalLabel">商品情報</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <h6 class="fw-bold">商品名</h6>
        <p id="modal-product-name" class="text-break"></p>
        <h6 class="fw-bold mt-3">投稿文</h6>
        <p id="modal-ai-caption" style="white-space: pre-wrap;"></p>
        <h6 class="fw-bold mt-3">調達キーワード</h6>
        <p><span id="modal-procurement-keyword" class="badge bg-info"></span></p>
      </div>
      <div class="modal-footer">
        <a href="#" id="modal-post-link" class="btn btn-primary" target="_blank" rel="noopener noreferrer" style="display: none;"><i class="bi bi-box-arrow-up-right me-1"></i>投稿ページを開く</a>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block styles %}
<style>
    .truncate-cell {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    tbody tr {
        cursor: pointer;
    }
    /* 行の背景色ハイライトは使わず、透明にする */
    tr.selected {
        background-color: transparent !important;
    }
    /* 選択された行のサムネイル枠線を強調 */
    tr.selected .img-thumbnail {
        border: 3px solid #0d6efd; /* Bootstrapのプライマリカラーで枠線を太く、色を濃くする */
        padding: 1px; /* 枠線の太さが増えた分、パディングを調整して画像のサイズ感を維持 */
    }
    .inventory-thumbnail {
        width: 80px;
        height: 80px;
        object-fit: cover;
    }
    /* スマートフォンなどの小さい画面向けのスタイル */
    @media (max-width: 767.98px) {
        /* 縦長画面ではヘッダーを非表示 */
        @media (orientation: portrait) {
            thead {
                display: none;
            }
            /* 作成日列を非表示 */
            th:last-child,
            td:last-child {
                display: none;
            }
            /* 各列の幅を再調整 */
            td:nth-child(5) { width: 10%; }  /* ステータス */
            td:nth-child(4) { width: 65%; }  /* 商品情報 */
            td:nth-child(3) { width: 15%; }  /* サムネイル */
            td:nth-child(2) { display: table-cell; width: 10%; } /* ハンドル列を表示 */
            .inventory-thumbnail {
                width: 40px;
                height: 40px;
            }
        }
    }

    /* 横長画面のサマリーカードの高さを調整 */
    @media (orientation: landscape) {
        #status-summary .card-body {
            padding-top: 0.25rem;
            padding-bottom: 0.25rem;
        }
        #status-summary .fs-4 {
            font-size: 1rem; /* fs-4 (1.5rem) からさらに小さくする */
        }
    }
    /* チェックボックスのサイズを大きくする */
    .table .form-check-input {
        width: 1.25em; /* デフォルトの1emから拡大 */
        height: 1.25em; /* デフォルトの1emから拡大 */
        vertical-align: middle; /* 垂直方向の中央揃えを維持 */
    }

    /* チェックボックス列のパディングを調整してクリック領域を広げる */
    .table th:first-child,
    .table td:first-child { 
        /* チェックボックス列を常に非表示にする */
        display: none;
    }
    /* ドラッグ中のゴースト要素のスタイル */
    .sortable-ghost {
        opacity: 0.4;
        background-color: #c8ebfb;
    }
    .move-buttons {
        position: absolute;
        display: flex;
        flex-direction: column;
        gap: 2px;
        background-color: white;
        border: 1px solid #dee2e6;
        border-radius: .25rem;
        padding: 2px;
    }
    .drag-handle {
        cursor: grab;
        color: #adb5bd;
    }
</style>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
<script>
    // グローバルスコープにモーダルインスタンスを保持
    let infoModalInstance = null;

    async function importFromJson() {
        const textarea = document.getElementById('json-import-textarea');
        const jsonText = textarea.value;
        if (!jsonText.trim()) {
            alert('JSONデータを入力してください。');
            return;
        }

        try {
            const products = JSON.parse(jsonText);
            const response = await fetch('/api/import/json', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ products: products })
            });
            const result = await response.json();
            if (!response.ok) {
                throw new Error(result.message || 'インポートに失敗しました。');
            }
            alert(result.message);
            textarea.value = ''; // 成功したらテキストエリアをクリア
            location.reload(); // ページをリロードして在庫リストを更新
        } catch (error) {
            alert(`エラー: ${error.message}\n\n入力されたJSONの形式が正しいか確認してください。`);
        }
    }

    function showInfoModal(element) {
        // 行選択のイベントが発火しないようにする
        event.stopPropagation();

        const name = element.dataset.name;
        const caption = element.dataset.caption;
        const procurementKeyword = element.dataset.procurementKeyword;
        const postUrl = element.dataset.postUrl;

        document.getElementById('modal-product-name').textContent = name;
        document.getElementById('modal-ai-caption').textContent = caption;
        document.getElementById('modal-procurement-keyword').textContent = procurementKeyword || 'N/A';

        const postLink = document.getElementById('modal-post-link');
        if (postUrl) {
            postLink.href = postUrl;
            postLink.style.display = 'inline-block';
        } else {
            postLink.style.display = 'none';
        }

        infoModalInstance.show();
    }
    async function deleteItem(productId) {
        if (!confirm(`商品ID: ${productId} を本当に削除しますか？この操作は元に戻せません。`)) {
            return;
        }
        try {
            const response = await fetch(`/api/inventory/${productId}`, {
                method: 'DELETE'
            });
            const result = await response.json();
            if (!response.ok) {
                throw new Error(result.message || '削除に失敗しました。');
            }
            // 成功したらテーブルから行を削除
            document.getElementById(`product-row-${productId}`).remove();
            alert(result.message);
        } catch (error) {
            console.error('Error:', error);
            alert(error.message);
        }
    }
    async function forceComplete(productId) {
        if (!confirm(`商品ID: ${productId} を本当に「投稿済」にしますか？この操作は元に戻せません。`)) {
            return;
        }
        try {
            const response = await fetch(`/api/inventory/${productId}/complete`, {
                method: 'POST'
            });
            const result = await response.json();
            if (!response.ok) {
                throw new Error(result.message || 'ステータスの更新に失敗しました。');
            }
            // 成功したらテーブルから行を削除
            document.getElementById(`product-row-${productId}`).remove();
            alert(result.message);
        } catch (error) {
            console.error('Error:', error);
            alert(error.message);
        }
    }

    function getSelectedProductIds() {
        return Array.from(document.querySelectorAll('.product-checkbox:checked')).map(cb => cb.value);
    }

    function updateBulkActionButtons() {
        const selectedIds = getSelectedProductIds();
        const disabled = selectedIds.length === 0;
        document.getElementById('bulk-complete-btn').disabled = disabled;
        document.getElementById('bulk-delete-btn').disabled = disabled;
    }

    function toggleSelectAll() {
        const allCheckboxes = document.querySelectorAll('.product-checkbox');
        const allSelected = getSelectedProductIds().length === allCheckboxes.length;
        allCheckboxes.forEach(checkbox => {
            checkbox.checked = !allSelected;
            checkbox.closest('tr').classList.toggle('selected', !allSelected);
        });
        updateBulkActionButtons();
    }

    async function bulkComplete() {
        const productIds = getSelectedProductIds();
        if (productIds.length === 0) return;
        if (!confirm(`${productIds.length}件の商品を本当に「投稿済」にしますか？`)) return;

        try {
            const response = await fetch('/api/inventory/bulk-complete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ product_ids: productIds })
            });
            const result = await response.json();
            if (!response.ok) throw new Error(result.message);
            
            productIds.forEach(id => document.getElementById(`product-row-${id}`).remove());
            alert(result.message);
            updateBulkActionButtons();
        } catch (error) {
            alert(`一括更新に失敗しました: ${error.message}`);
        }
    }

    async function bulkDelete() {
        const productIds = getSelectedProductIds();
        if (productIds.length === 0) return;
        if (!confirm(`${productIds.length}件の商品を本当に削除しますか？`)) return;

        try {
            const response = await fetch('/api/inventory/bulk-delete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ product_ids: productIds })
            });
            const result = await response.json();
            if (!response.ok) throw new Error(result.message);

            productIds.forEach(id => document.getElementById(`product-row-${id}`).remove());
            alert(result.message);
            updateBulkActionButtons();
        } catch (error) {
            alert(`一括削除に失敗しました: ${error.message}`);
        }
    }

    const statusMap = {
        '生情報取得': { emoji: '☁️', color: 'secondary' },
        'URL取得済': { emoji: '⛅️', color: 'info' },
        '投稿準備完了': { emoji: '☀️', color: 'primary' },
        '投稿済': { emoji: '🎉', color: 'success' },
        'エラー': { emoji: '⚠️', color: 'danger' }
    };

    function renderStatusSummary(summary) {
        const summaryContainer = document.getElementById('status-summary');
        summaryContainer.innerHTML = '';
        const orderedStatuses = ['生情報取得', 'URL取得済', '投稿準備完了']; // サマリーに表示するステータス
        
        orderedStatuses.forEach(status => {
            const count = summary[status] || 0;
            const statusInfo = statusMap[status] || { emoji: '❓', color: 'light' };
            const cardHtml = `
                <div class="col" title="${status}" style="cursor: default;">
                    <div class="card card-body text-center h-100">
                        <div class="d-flex justify-content-center align-items-center h-100 gap-2">
                            <span class="fs-4">${statusInfo.emoji}</span><span class="fs-4 fw-bold">${count}</span>
                        </div>
                    </div>
                </div>
            `;
            summaryContainer.innerHTML += cardHtml;
        });
    }

    // ページ読み込み時に在庫リストを取得して表示する関数
    document.addEventListener('DOMContentLoaded', function () {
        // モーダルを初期化
        const infoModalEl = document.getElementById('infoModal');
        infoModalInstance = new bootstrap.Modal(infoModalEl);
        // ステータスサマリーを取得
        fetch('/api/inventory/summary')
            .then(response => response.json())
            .then(summary => {
                renderStatusSummary(summary);
            })
            .catch(error => console.error('Error fetching status summary:', error));

        // 在庫リストを取得
        fetch('/api/inventory')
            .then(response => response.json())
            .then(data => {
                const tableBody = document.getElementById('inventory-table-body');
                tableBody.innerHTML = ''; // 既存の内容をクリア
                if (data.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="5" class="text-center">在庫商品はありません。</td></tr>';
                    return;
                }
                data.forEach(product => {
                    const statusInfo = statusMap[product.status] || { emoji: '❓', color: 'light' };
                    
                    let statusHtml;
                    if (product.status === '投稿準備完了') {
                        statusHtml = `<span title="${product.status}" class="fs-5">${statusInfo.emoji}</span>`;
                    } else {
                        statusHtml = `<span title="${product.status}">${statusInfo.emoji}</span>`;
                    }

                    const createdAt = product.created_at ? new Date(product.created_at).toLocaleDateString('ja-JP') : 'N/A';
                    const row = `
                        <tr id="product-row-${product.id}">
                            <td>
                                <input class="form-check-input product-checkbox" type="checkbox" value="${product.id}">
                            </td>
                            <td class="text-center drag-handle">
                                <i class="bi bi-grip-vertical"></i>
                            </td>
                            <td>
                                <a href="${product.url}" target="_blank" rel="noopener noreferrer">
                                    <img src="${product.image_url || 'https://via.placeholder.com/80'}" alt="${product.name}" class="img-thumbnail inventory-thumbnail">
                                </a>
                            </td>
                            <td class="text-start">
                                <div class="fw-bold truncate-cell" title="${product.name || ''}">${product.name || ''}</div>
                                <div class="text-muted small truncate-cell" title="${product.ai_caption || ''}">${product.ai_caption || ''}</div>
                            </td>
                            <td class="text-center" onclick="showInfoModal(this)" data-name="${product.name || ''}" data-caption="${product.ai_caption || ''}" data-post-url="${product.post_url || ''}" data-procurement-keyword="${product.procurement_keyword || ''}">${statusHtml}</td>
                            <td>
                                ${createdAt}
                            </td>
                        </tr>
                    `;
                    tableBody.innerHTML += row;
                });

                // SortableJSの初期化
                new Sortable(tableBody, {
                    animation: 150,
                    ghostClass: 'sortable-ghost',
                    handle: '.drag-handle', // ドラッグハンドルを専用のクラスに限定
                    onEnd: async function (evt) {
                        const productIds = Array.from(tableBody.querySelectorAll('tr')).map(tr => tr.id.replace('product-row-', ''));
                        try {
                            const response = await fetch('/api/inventory/update-order', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ product_ids: productIds })
                            });
                            if (!response.ok) {
                                const result = await response.json();
                                throw new Error(result.message || '順序の更新に失敗しました。');
                            }
                        } catch (error) {
                            alert(`エラー: ${error.message}`);
                            location.reload(); // エラー時はUIを元に戻すためにリロード
                        }
                    }
                });
            });

        // 個別チェックボックスのイベントリスナー
        document.getElementById('inventory-table-body').addEventListener('change', function (e) {
            const checkbox = e.target;
            if (checkbox.classList.contains('product-checkbox')) {
                checkbox.closest('tr').classList.toggle('selected', checkbox.checked);
                updateBulkActionButtons();
            }
        });

        // テーブル行のクリックイベントリスナー
        document.getElementById('inventory-table-body').addEventListener('click', function (e) {
            // ボタン、リンク、チェックボックス、ドラッグハンドル自体をクリックした場合は行選択を無効にする
            if (e.target.closest('a, button, .form-check-input, .drag-handle')) return;

            const row = e.target.closest('tr');
            const checkbox = row.querySelector('.product-checkbox');
            if (checkbox) {
                checkbox.click(); // チェックボックスのクリックイベントを発火させる
            }
        });

        // 長押しで移動ボタンを表示するためのイベントリスナー
        let longPressTimer = null;
        document.getElementById('inventory-table-body').addEventListener('touchstart', function(e) {
            const handle = e.target.closest('.drag-handle');
            if (handle) {
                // 既にボタンが表示されている場合は、何もしない
                if (handle.querySelector('.move-buttons')) {
                    return;
                }

                // 長押しタイマーを開始
                longPressTimer = setTimeout(() => {
                    showMoveButtons(handle, e);
                    longPressTimer = null; // タイマーをリセット
                }, 500); // 500ミリ秒（0.5秒）で長押しと判定
            }
        });

        document.getElementById('inventory-table-body').addEventListener('touchend', function(e) {
            // 指が離れたらタイマーをキャンセル
            clearTimeout(longPressTimer);
        });

        document.getElementById('inventory-table-body').addEventListener('touchmove', function(e) {
            // 指が動いたら（スクロールやドラッグ開始）タイマーをキャンセル
            clearTimeout(longPressTimer);
        });

        // 移動ボタン表示関数
        function showMoveButtons(handleCell, event) {
            event.stopPropagation();
            // 既存のボタンをすべて削除
            removeMoveButtons();

            const row = handleCell.closest('tr');
            const tableBody = row.parentElement;

            const buttonContainer = document.createElement('div');
            buttonContainer.className = 'move-buttons';
            buttonContainer.innerHTML = `
                <button class="btn btn-sm btn-light p-0" data-action="move-top" title="一番上に移動"><i class="bi bi-chevron-double-up"></i></button>
                <button class="btn btn-sm btn-light p-0" data-action="move-bottom" title="一番下に移動"><i class="bi bi-chevron-double-down"></i></button>
            `;

            // ボタンのクリックイベントをここで登録
            buttonContainer.addEventListener('click', function(e) {
                const button = e.target.closest('button');
                if (button && button.dataset.action === 'move-top') moveRowTop(button, e);
                if (button && button.dataset.action === 'move-bottom') moveRowBottom(button, e);
            });

            handleCell.appendChild(buttonContainer);
        }

        function moveRowTop(button, event) {
            event.stopPropagation();
            event.preventDefault();
            const row = button.closest('tr');
            const tableBody = row.parentElement;
            tableBody.prepend(row);
            removeMoveButtons();
            saveOrder();
        }

        function moveRowBottom(button, event) {
            event.stopPropagation();
            event.preventDefault();
            const row = button.closest('tr');
            const tableBody = row.parentElement;
            tableBody.append(row);
            removeMoveButtons();
            saveOrder();
        }

        function removeMoveButtons() {
            document.querySelectorAll('.move-buttons').forEach(el => el.remove());
        }

        async function saveOrder() {
            const tableBody = document.getElementById('inventory-table-body');
            const productIds = Array.from(tableBody.querySelectorAll('tr')).map(tr => tr.id.replace('product-row-', ''));
            try {
                await fetch('/api/inventory/update-order', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ product_ids: productIds })
                });
            } catch (error) {
                alert(`エラー: 順序の保存に失敗しました。`);
            }
        }

        // ボタン以外の場所をクリックしたらボタンを消す
        document.addEventListener('click', function(event) {
            // クリックされたのが移動ボタンのコンテナでなければ、ボタンを削除
            if (!event.target.closest('.move-buttons')) {
                removeMoveButtons();
            }
        });

        // シャッフルボタンのイベントリスナー
        document.getElementById('shuffle-btn').addEventListener('click', () => {
            const tableBody = document.getElementById('inventory-table-body');
            const rows = Array.from(tableBody.children);

            // 1行以下の場合は何もしない
            if (rows.length <= 1) return;

            // Fisher-Yatesアルゴリズムで配列をシャッフル
            for (let i = rows.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [rows[i], rows[j]] = [rows[j], rows[i]];
            }

            // シャッフルされた行をテーブルに再追加してDOMを更新
            rows.forEach(row => tableBody.appendChild(row));

            // 既存の順序保存関数を呼び出して変更をDBに保存
            saveOrder();
        });

    });
</script>
{% endblock %}