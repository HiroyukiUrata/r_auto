{% extends "base.html" %}

{% block title %}在庫確認 - R-Auto Control Panel{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">在庫確認 (未投稿リスト)</h1>
</div>

<div class="table-responsive">
    <table class="table table-striped table-sm align-middle" style="table-layout: fixed; width: 100%;">
        <thead>
            <tr>
                <th scope="col" style="width: 10%;">サムネイル</th>
                <th scope="col" style="width: 20%;">商品名</th>
                <th scope="col" style="width: 20%;">投稿文</th>
                <th scope="col">ステータス</th>
                <th scope="col" style="width: 15%;">操作</th>
            </tr>
        </thead>
        <tbody id="inventory-table-body">
            <!-- データはJavaScriptでここに挿入されます -->
        </tbody>
    </table>
</div>
{% endblock %}

{% block styles %}
<style>
    .truncate-cell {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    async function deleteItem(productId) {
        if (!confirm(`商品ID: ${productId} を本当に削除しますか？この操作は元に戻せません。`)) {
            return;
        }
        try {
            const response = await fetch(`/api/inventory/${productId}`, {
                method: 'DELETE'
            });
            const result = await response.json();
            if (!response.ok) {
                throw new Error(result.message || '削除に失敗しました。');
            }
            // 成功したらテーブルから行を削除
            document.getElementById(`product-row-${productId}`).remove();
            alert(result.message);
        } catch (error) {
            console.error('Error:', error);
            alert(error.message);
        }
    }
    async function forceComplete(productId) {
        if (!confirm(`商品ID: ${productId} を本当に「済」にしますか？この操作は元に戻せません。`)) {
            return;
        }
        try {
            const response = await fetch(`/api/inventory/${productId}/complete`, {
                method: 'POST'
            });
            const result = await response.json();
            if (!response.ok) {
                throw new Error(result.message || 'ステータスの更新に失敗しました。');
            }
            // 成功したらテーブルから行を削除
            document.getElementById(`product-row-${productId}`).remove();
            alert(result.message);
        } catch (error) {
            console.error('Error:', error);
            alert(error.message);
        }
    }

    // ページ読み込み時に在庫リストを取得して表示する関数
    document.addEventListener('DOMContentLoaded', function () {
        fetch('/api/inventory')
            .then(response => response.json())
            .then(data => {
                const tableBody = document.getElementById('inventory-table-body');
                if (data.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="5" class="text-center">在庫商品はありません。</td></tr>';
                    return;
                }
                data.forEach(product => {
                    // 投稿ボタンのHTMLを生成。post_urlがなければボタンは非表示
                    const postButtonHtml = product.post_url ? `
                        <button class="btn btn-sm btn-primary" onclick="window.open('${product.post_url}', '_blank')">
                            <i class="bi bi-box-arrow-up-right me-1"></i>投稿
                        </button>` : '';
                    const row = `
                        <tr id="product-row-${product.id}">
                            <td>
                                <a href="${product.url}" target="_blank" rel="noopener noreferrer">
                                    <img src="${product.image_url || 'https://via.placeholder.com/80'}" alt="${product.name}" class="img-thumbnail" style="width: 80px; height: 80px; object-fit: cover;">
                                </a>
                            </td>
                            <td title="${product.name || ''}">
                                <div class="truncate-cell">${product.name || ''}</div>
                            </td>
                            <td title="${product.ai_caption || ''}">
                                <div class="truncate-cell">${product.ai_caption || ''}</div>
                            </td>
                            <td><span class="badge bg-secondary">${product.status}</span></td>
                            <td class="text-nowrap">
                                ${postButtonHtml}
                                <button class="btn btn-sm btn-warning" onclick="forceComplete(${product.id})">
                                    <i class="bi bi-check-circle-fill me-1"></i>強制済
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteItem(${product.id})">
                                    <i class="bi bi-trash-fill me-1"></i>削除
                                </button>
                            </td>
                        </tr>
                    `;
                    tableBody.innerHTML += row;
                });
            });
    });
</script>
{% endblock %}