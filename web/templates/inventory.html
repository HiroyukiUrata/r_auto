{% extends "base.html" %}

{% block title %}åœ¨åº«ç¢ºèª - R-Auto Control Panel{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">åœ¨åº«ç¢ºèª (æœªæŠ•ç¨¿ãƒªã‚¹ãƒˆ)</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="d-flex flex-wrap gap-2 me-2">
            <button type="button" class="btn btn-sm btn-outline-secondary" id="select-all-toggle-btn" onclick="toggleSelectAll()" title="ã™ã¹ã¦é¸æŠ/è§£é™¤">
                <i class="bi bi-check-square"></i><span class="d-none d-md-inline ms-1">å…¨é¸æŠ</span>
            </button>
            <button type="button" class="btn btn-sm btn-outline-secondary" id="sort-by-shop-btn" title="ã‚·ãƒ§ãƒƒãƒ—åˆ¥ï¼ˆå•†å“æ•°ãŒå¤šã„é †ï¼‰ã«ä¸¦ã³æ›¿ãˆ">
                <i class="bi bi-shop"></i><span class="d-none d-md-inline ms-1">ã‚·ãƒ§ãƒƒãƒ—åˆ¥</span>
            </button>
            <button type="button" class="btn btn-sm btn-outline-info" id="shuffle-btn" title="ãƒªã‚¹ãƒˆã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«">
                <i class="bi bi-shuffle"></i><span class="d-none d-md-inline ms-1">ã‚·ãƒ£ãƒƒãƒ•ãƒ«</span>
            </button>
            <button type="button" class="btn btn-sm btn-outline-warning" id="bulk-complete-btn" onclick="bulkComplete()" disabled title="é¸æŠã—ãŸé …ç›®ã‚’å¼·åˆ¶çš„ã«æŠ•ç¨¿æ¸ˆã¿ã«ã™ã‚‹">
                <i class="bi bi-check-circle-fill"></i><span class="d-none d-md-inline ms-1">å¼·åˆ¶æ¸ˆ</span>
            </button>
            <button type="button" class="btn btn-sm btn-outline-danger" id="bulk-delete-btn" onclick="bulkDelete()" disabled title="é¸æŠã—ãŸé …ç›®ã‚’å‰Šé™¤">
                <i class="bi bi-trash-fill"></i><span class="d-none d-md-inline ms-1">å‰Šé™¤</span>
            </button>
        </div>
        <!-- ã‚¹ãƒãƒ›è¡¨ç¤ºæ™‚ã®ã¿å‡¡ä¾‹ã‚¢ã‚¤ã‚³ãƒ³ã‚’è¡¨ç¤º -->
        <i class="bi bi-info-circle d-inline-block d-md-none text-secondary ms-2" 
           style="cursor: pointer; font-size: 1.2rem;"
           data-bs-toggle="tooltip" 
           data-bs-html="true"
           data-bs-title="<div class='text-start'>ãƒ»<i class='bi bi-check-square'></i>: å…¨é¸æŠ<br>ãƒ»<i class='bi bi-shop'></i>: ã‚·ãƒ§ãƒƒãƒ—åˆ¥ã‚½ãƒ¼ãƒˆ<br>ãƒ»<i class='bi bi-shuffle'></i>: ã‚·ãƒ£ãƒƒãƒ•ãƒ«<br>ãƒ»<i class='bi bi-check-circle-fill'></i>: å¼·åˆ¶æ¸ˆ<br>ãƒ»<i class='bi bi-trash-fill'></i>: å‰Šé™¤</div>">
        </i>
    </div>
</div>

<!-- ã‚¹ãƒãƒ›è¡¨ç¤ºç”¨ã®æ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é–‹é–‰ãƒœã‚¿ãƒ³ -->
<div class="d-grid d-md-none mb-3">
    <button class="btn btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#search-filters" aria-expanded="false" aria-controls="search-filters">
        <i class="bi bi-funnel-fill me-2"></i>æ¤œç´¢æ¡ä»¶
    </button>
</div>

<!-- æ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
<div class="row g-2 mb-3 align-items-end collapse" id="search-filters">
    <div class="col-lg-6 col-md-12">
        <label for="search-input" class="form-label small mb-1 d-none d-md-block">ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ / ã‚·ãƒ§ãƒƒãƒ—å</label>
        <input type="search" id="search-input" class="form-control form-control-sm" placeholder="å•†å“åã€ã‚·ãƒ§ãƒƒãƒ—åã€AIã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ã§æ¤œç´¢...">
    </div>
    <div class="col-lg-6 col-md-12 d-flex gap-2 mt-2 mt-lg-0">
        <button class="btn btn-primary btn-sm w-100" type="button" id="search-btn"><i class="bi bi-search"></i> æ¤œç´¢</button>
        <button class="btn btn-outline-secondary btn-sm" type="button" id="clear-btn" title="æ¡ä»¶ã‚’ã‚¯ãƒªã‚¢"><i class="bi bi-x-lg"></i></button>
    </div>
</div>

<div class="accordion mb-4" id="importAccordion">
    <div class="accordion-item">
        <h2 class="accordion-header" id="headingOne">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="false" aria-controls="collapseOne">
                <i class="bi bi-file-earmark-arrow-down-fill me-2"></i>JSONã‹ã‚‰å•†å“ã‚’ä¸€æ‹¬ã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼ˆã‚¯ãƒªãƒƒã‚¯ã—ã¦å±•é–‹ï¼‰
            </button>
        </h2>
        <div id="collapseOne" class="accordion-collapse collapse" aria-labelledby="headingOne" data-bs-parent="#importAccordion">
            <div class="accordion-body">
                <div class="mb-3">
                    <label for="json-import-textarea" class="form-label">ã“ã“ã«JSONãƒ‡ãƒ¼ã‚¿ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„</label>
                    <textarea class="form-control" id="json-import-textarea" rows="5" placeholder="[&#10;  {&#10;    &quot;item_description&quot;: &quot;ã™ã”ã„ã‚¬ã‚¸ã‚§ãƒƒãƒˆ&quot;,&#10;    &quot;page_url&quot;: &quot;https://...&quot;,&#10;    &quot;image_url&quot;: &quot;https://...&quot;&#10;  },&#10;  ...&#10;]"></textarea>
                </div>
                <button class="btn btn-primary" onclick="importFromJson()">
                    <i class="bi bi-upload me-1"></i>ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¦å¾Œç¶šã‚¿ã‚¹ã‚¯ã‚’å®Ÿè¡Œ
                </button>
                <p class="text-muted small mt-2">ã‚¤ãƒ³ãƒãƒ¼ãƒˆãŒå®Œäº†ã™ã‚‹ã¨ã€è‡ªå‹•çš„ã«ã€ŒæŠ•ç¨¿URLå–å¾—ã€â†’ã€ŒæŠ•ç¨¿æ–‡ä½œæˆã€ã®ãƒ•ãƒ­ãƒ¼ãŒé–‹å§‹ã•ã‚Œã¾ã™ã€‚</p>
            </div>
        </div>
    </div>
</div>

<div class="row mb-3" id="status-summary">
    <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚µãƒãƒªãƒ¼ã¯ã“ã“ã«æŒ¿å…¥ã•ã‚Œã¾ã™ -->
</div>

<div class="table-responsive">
    <table class="table table-striped table-sm align-middle" style="table-layout: fixed; width: 100%;">
        <thead>
            <tr>
                <th scope="col" style="width: 5%;"></th>
                <th scope="col" style="width: 5%;"></th>
                <th scope="col" style="width: 7%;">ã‚µãƒ ãƒã‚¤ãƒ«</th>
                <th scope="col" style="width: 60%;">å•†å“æƒ…å ±</th>
                <th scope="col" style="width: 7%;">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                <th scope="col" style="width: 8%;">ä½œæˆæ—¥</th>
            </tr>
        </thead>
        <tbody id="inventory-table-body">
            <!-- ãƒ‡ãƒ¼ã‚¿ã¯JavaScriptã§ã“ã“ã«æŒ¿å…¥ã•ã‚Œã¾ã™ -->
        </tbody>
    </table>
</div>

<!-- ç„¡é™ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç”¨ã®ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ -->
<div id="loading-indicator" class="text-center my-3" style="display: none;">
    <div class="spinner-border spinner-border-sm" role="status"></div>
    <span class="ms-2">èª­ã¿è¾¼ã¿ä¸­...</span>
</div>

<!-- å•†å“æƒ…å ±è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="infoModal" tabindex="-1" aria-labelledby="infoModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="infoModalLabel">å•†å“æƒ…å ±</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <h6 class="fw-bold">å•†å“å</h6>
        <p id="modal-product-name" class="text-break"></p>
        <h6 class="fw-bold mt-3">ã‚·ãƒ§ãƒƒãƒ—å</h6>
        <p id="modal-shop-name"></p>
        <h6 class="fw-bold mt-3">æŠ•ç¨¿æ–‡</h6>
        <p id="modal-ai-caption" style="white-space: pre-wrap;"></p>
        <h6 class="fw-bold mt-3">èª¿é”ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰</h6>
        <p><span id="modal-procurement-keyword" class="badge bg-info"></span></p>
      </div>
      <div class="modal-footer">
        <a href="#" id="modal-post-link" class="btn btn-primary" target="_blank" rel="noopener noreferrer" style="display: none;"><i class="bi bi-box-arrow-up-right me-1"></i>æŠ•ç¨¿ãƒšãƒ¼ã‚¸ã‚’é–‹ã</a>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </div>
</div>

<!-- Shop Name Search Modal (posted_products.htmlã‹ã‚‰ç§»æ¤) -->
<div class="modal fade" id="shopSearchModal" tabindex="-1" aria-labelledby="shopSearchModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable">
      <div class="modal-content">
          <div class="modal-header">
              <h5 class="modal-title" id="shopSearchModalLabel"><i class="bi bi-shop me-2"></i>ã‚·ãƒ§ãƒƒãƒ—åã§æ¤œç´¢</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
              <div class="mb-3">
                  <input type="search" id="shop-filter-input" class="form-control" placeholder="ã‚·ãƒ§ãƒƒãƒ—åã‚’çµã‚Šè¾¼ã¿...">
              </div>
              <div id="shop-list-container" class="list-group"></div>
          </div>
          <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é–‰ã˜ã‚‹</button>
          </div>
      </div>
  </div>
</div>
{% endblock %}

{% block styles %}
<style>
    .truncate-cell {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    tbody tr {
        cursor: pointer;
    }
    /* è¡Œã®èƒŒæ™¯è‰²ãƒã‚¤ãƒ©ã‚¤ãƒˆã¯ä½¿ã‚ãšã€é€æ˜ã«ã™ã‚‹ */
    tr.selected {
        background-color: transparent !important;
    }
    /* é¸æŠã•ã‚ŒãŸè¡Œã®ã‚µãƒ ãƒã‚¤ãƒ«æ ç·šã‚’å¼·èª¿ */
    tr.selected .img-thumbnail {
        border: 3px solid #0d6efd; /* Bootstrapã®ãƒ—ãƒ©ã‚¤ãƒãƒªã‚«ãƒ©ãƒ¼ã§æ ç·šã‚’å¤ªãã€è‰²ã‚’æ¿ƒãã™ã‚‹ */
        padding: 1px; /* æ ç·šã®å¤ªã•ãŒå¢—ãˆãŸåˆ†ã€ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’èª¿æ•´ã—ã¦ç”»åƒã®ã‚µã‚¤ã‚ºæ„Ÿã‚’ç¶­æŒ */
    }
    .inventory-thumbnail {
        width: 80px;
        height: 80px;
        object-fit: cover;
    }
    /* ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ãªã©ã®å°ã•ã„ç”»é¢å‘ã‘ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    @media (max-width: 767.98px) {
        /* ç¸¦é•·ç”»é¢ã§ã¯ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’éè¡¨ç¤º */
        @media (orientation: portrait) {
            thead {
                display: none;
            }
            /* ä½œæˆæ—¥åˆ—ã‚’éè¡¨ç¤º */
            th:last-child,
            td:last-child {
                display: none;
            }
            /* å„åˆ—ã®å¹…ã‚’å†èª¿æ•´ */
            td:nth-child(5) { width: 10%; }  /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ */
            td:nth-child(4) { width: 65%; }  /* å•†å“æƒ…å ± */
            td:nth-child(3) { width: 15%; }  /* ã‚µãƒ ãƒã‚¤ãƒ« */
            td:nth-child(2) { display: table-cell; width: 10%; } /* ãƒãƒ³ãƒ‰ãƒ«åˆ—ã‚’è¡¨ç¤º */
            .inventory-thumbnail {
                width: 40px;
                height: 40px;
            }
        }
    }

    /* æ¨ªé•·ç”»é¢ã®ã‚µãƒãƒªãƒ¼ã‚«ãƒ¼ãƒ‰ã®é«˜ã•ã‚’èª¿æ•´ */
    @media (orientation: landscape) {
        #status-summary .card-body {
            padding-top: 0.25rem;
            padding-bottom: 0.25rem;
        }
        #status-summary .fs-4 {
            font-size: 1rem; /* fs-4 (1.5rem) ã‹ã‚‰ã•ã‚‰ã«å°ã•ãã™ã‚‹ */
        }
    }
    /* ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®ã‚µã‚¤ã‚ºã‚’å¤§ããã™ã‚‹ */
    .table .form-check-input {
        width: 1.25em; /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®1emã‹ã‚‰æ‹¡å¤§ */
        height: 1.25em; /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®1emã‹ã‚‰æ‹¡å¤§ */
        vertical-align: middle; /* å‚ç›´æ–¹å‘ã®ä¸­å¤®æƒãˆã‚’ç¶­æŒ */
    }

    /* ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹åˆ—ã®ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’èª¿æ•´ã—ã¦ã‚¯ãƒªãƒƒã‚¯é ˜åŸŸã‚’åºƒã’ã‚‹ */
    .table th:first-child,
    .table td:first-child { 
        /* ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹åˆ—ã‚’å¸¸ã«éè¡¨ç¤ºã«ã™ã‚‹ */
        display: none;
    }
    /* ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®ã‚´ãƒ¼ã‚¹ãƒˆè¦ç´ ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .sortable-ghost {
        opacity: 0.4;
        background-color: #c8ebfb;
    }
    .move-buttons {
        position: absolute;
        display: flex;
        flex-direction: column;
        gap: 2px;
        background-color: white;
        border: 1px solid #dee2e6;
        border-radius: .25rem;
        padding: 2px;
    }
    .drag-handle {
        cursor: grab;
        color: #adb5bd;
    }
    .sort-active {
        color: #fff;
        background-color: #0d6efd;
    }
    /* ã‚·ãƒ§ãƒƒãƒ—åãƒãƒƒã‚¸ã®åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ« */
    .shop-name-badge {
        flex-shrink: 0;
        width: 120px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        font-weight: normal;
        text-align: left;
    }
    /* posted_products.htmlã‹ã‚‰ç§»æ¤ */
    @media (min-width: 768px) {
        #search-filters.collapse {
            display: flex;
        }
    }
    /* posted_products.htmlã‹ã‚‰ç§»æ¤ */
    .shop-name-badge {
        flex-shrink: 0;
        width: 120px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    /* ã‚¹ãƒãƒ›è¡¨ç¤ºã§ã¯å¹…ã‚’ç‹­ãã™ã‚‹ */
    @media (max-width: 767.98px) {
        .shop-name-badge { width: 80px; }
    }
</style>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
<script>
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã«ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä¿æŒ
    let allProductsData = []; // å…¨å•†å“ãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒ
    let displayedCount = 0;   // è¡¨ç¤ºæ¸ˆã¿ã®ä»¶æ•°
    const ITEMS_PER_LOAD = 50; // ä¸€åº¦ã«èª­ã¿è¾¼ã‚€ä»¶æ•°
    let isLoading = false;    // èª­ã¿è¾¼ã¿ä¸­ãƒ•ãƒ©ã‚°
    let sortableInstance = null; // SortableJSã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
    let infoModalInstance = null;
    let currentFilters = { searchTerm: '' }; // æ¤œç´¢æ¡ä»¶ã‚’ä¿æŒ

    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚¢ã‚¤ã‚³ãƒ³ã‚’åˆ¤å®šã™ã‚‹é–¢æ•° (error_management.htmlã‹ã‚‰ç§»æ¤)
    function getStatusIcon(product) {
        const hasCreationTs = !!product.created_at;
        const hasUrlTs = !!product.post_url_updated_at;
        const hasCaptionTs = !!product.ai_caption_created_at;
        const hasUrlData = !!product.post_url;
        const hasCaptionData = !!product.ai_caption;

        // ãƒ‡ãƒ¼ã‚¿ã¨ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã®ä¸æ•´åˆãƒã‚§ãƒƒã‚¯
        if (hasUrlTs !== hasUrlData) {
            return `<span class="fs-5" title="ãƒ‡ãƒ¼ã‚¿ä¸æ•´åˆ: æŠ•ç¨¿URLã®æœ‰ç„¡ã¨æ—¥æ™‚ã®çŠ¶æ…‹ãŒä¸€è‡´ã—ã¾ã›ã‚“">â˜”</span>`;
        }
        if (hasCaptionTs !== hasCaptionData) {
            return `<span class="fs-5" title="ãƒ‡ãƒ¼ã‚¿ä¸æ•´åˆ: AIæ–‡ç« ã®æœ‰ç„¡ã¨æ—¥æ™‚ã®çŠ¶æ…‹ãŒä¸€è‡´ã—ã¾ã›ã‚“">â˜”</span>`;
        }
        // ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã®é †åºãŒä¸æ­£ãªã‚±ãƒ¼ã‚¹
        if (hasCaptionTs && !hasUrlTs) {
            return '<span class="fs-5" title="ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—é †åºä¸æ­£: URLå–å¾—ã‚ˆã‚Šå…ˆã«AIæ–‡ç« ãŒä½œæˆã•ã‚Œã¦ã„ã¾ã™">â˜”</span>';
        }

        // æ­£å¸¸ç³»ã®é€²æ—ã‚’åˆ¤å®š
        if (hasCreationTs && hasUrlTs && hasCaptionData) { // æŠ•ç¨¿æ–‡ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Œã°æ™´ã‚Œ
            return '<span class="fs-5" title="æŠ•ç¨¿æº–å‚™å®Œäº†ã§ã™">â˜€ï¸</span>';
        } else if (hasCreationTs && hasUrlTs) {
            return '<span class="fs-5" title="URLå–å¾—ã¾ã§å®Œäº†ã—ã¦ã„ã¾ã™">â›…ï¸</span>';
        } else if (hasCreationTs) {
            return '<span class="fs-5" title="å•†å“æƒ…å ±ã®å–å¾—ã®ã¿å®Œäº†ã—ã¦ã„ã¾ã™">â˜ï¸</span>';
        }
        return '<span class="fs-5" title="ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ãŒä¸è¶³ã—ã¦ã„ã¾ã™">â˜”</span>'; // ä¸Šè¨˜ä»¥å¤–ã¯é›¨
    }

    async function importFromJson() {
        const textarea = document.getElementById('json-import-textarea');
        const jsonText = textarea.value;
        if (!jsonText.trim()) {
            alert('JSONãƒ‡ãƒ¼ã‚¿ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
            return;
        }

        try {
            const products = JSON.parse(jsonText);
            const response = await fetch('/api/import/json', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ products: products })
            });
            const result = await response.json();
            if (!response.ok) {
                throw new Error(result.message || 'ã‚¤ãƒ³ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            }
            alert(result.message);
            textarea.value = ''; // æˆåŠŸã—ãŸã‚‰ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã‚’ã‚¯ãƒªã‚¢
            location.reload(); // ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦åœ¨åº«ãƒªã‚¹ãƒˆã‚’æ›´æ–°
        } catch (error) {
            alert(`ã‚¨ãƒ©ãƒ¼: ${error.message}\n\nå…¥åŠ›ã•ã‚ŒãŸJSONã®å½¢å¼ãŒæ­£ã—ã„ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚`);
        }
    }

    function showInfoModal(element) {
        // è¡Œé¸æŠã®ã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºç«ã—ãªã„ã‚ˆã†ã«ã™ã‚‹
        event.stopPropagation();

        const name = element.dataset.name;
        const caption = element.dataset.caption;
        const procurementKeyword = element.dataset.procurementKeyword;
        const shopName = element.dataset.shopName;
        const postUrl = element.dataset.postUrl;

        document.getElementById('modal-product-name').textContent = name;
        document.getElementById('modal-ai-caption').textContent = caption;
        document.getElementById('modal-procurement-keyword').textContent = procurementKeyword || 'N/A';
        document.getElementById('modal-shop-name').textContent = shopName || 'N/A';

        const postLink = document.getElementById('modal-post-link');
        if (postUrl) {
            postLink.href = postUrl;
            postLink.style.display = 'inline-block';
        } else {
            postLink.style.display = 'none';
        }

        infoModalInstance.show();
    }
    async function deleteItem(productId) {
        if (!confirm(`å•†å“ID: ${productId} ã‚’æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚`)) {
            return;
        }
        try {
            const response = await fetch(`/api/inventory/${productId}`, {
                method: 'DELETE'
            });
            const result = await response.json();
            if (!response.ok) {
                throw new Error(result.message || 'å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            }
            // æˆåŠŸã—ãŸã‚‰ãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰è¡Œã‚’å‰Šé™¤
            document.getElementById(`product-row-${productId}`).remove();
            alert(result.message);
        } catch (error) {
            console.error('Error:', error);
            alert(error.message);
        }
    }
    async function forceComplete(productId) {
        if (!confirm(`å•†å“ID: ${productId} ã‚’æœ¬å½“ã«ã€ŒæŠ•ç¨¿æ¸ˆã€ã«ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚`)) {
            return;
        }
        try {
            const response = await fetch(`/api/inventory/${productId}/complete`, {
                method: 'POST'
            });
            const result = await response.json();
            if (!response.ok) {
                throw new Error(result.message || 'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            }
            // æˆåŠŸã—ãŸã‚‰ãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰è¡Œã‚’å‰Šé™¤
            document.getElementById(`product-row-${productId}`).remove();
            alert(result.message);
        } catch (error) {
            console.error('Error:', error);
            alert(error.message);
        }
    }

    function getSelectedProductIds() {
        return Array.from(document.querySelectorAll('.product-checkbox:checked')).map(cb => cb.value);
    }

    function updateBulkActionButtons() {
        const selectedIds = getSelectedProductIds();
        const disabled = selectedIds.length === 0;
        document.getElementById('bulk-complete-btn').disabled = disabled;
        document.getElementById('bulk-delete-btn').disabled = disabled;
    }

    function toggleSelectAll() {
        const allCheckboxes = document.querySelectorAll('.product-checkbox');
        const allSelected = getSelectedProductIds().length === allCheckboxes.length;
        allCheckboxes.forEach(checkbox => {
            checkbox.checked = !allSelected;
            checkbox.closest('tr').classList.toggle('selected', !allSelected);
        });
        updateBulkActionButtons();
    }

    async function bulkComplete() {
        const productIds = getSelectedProductIds();
        if (productIds.length === 0) return;
        if (!confirm(`${productIds.length}ä»¶ã®å•†å“ã‚’æœ¬å½“ã«ã€ŒæŠ•ç¨¿æ¸ˆã€ã«ã—ã¾ã™ã‹ï¼Ÿ`)) return;

        try {
            const response = await fetch('/api/inventory/bulk-complete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ product_ids: productIds })
            });
            const result = await response.json();
            if (!response.ok) throw new Error(result.message);
            
            productIds.forEach(id => document.getElementById(`product-row-${id}`).remove());
            alert(result.message);
            updateBulkActionButtons();
        } catch (error) {
            alert(`ä¸€æ‹¬æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`);
        }
    }

    async function bulkDelete() {
        const productIds = getSelectedProductIds();
        if (productIds.length === 0) return;
        if (!confirm(`${productIds.length}ä»¶ã®å•†å“ã‚’æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;

        try {
            const response = await fetch('/api/inventory/bulk-delete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ product_ids: productIds })
            });
            const result = await response.json();
            if (!response.ok) throw new Error(result.message);

            productIds.forEach(id => document.getElementById(`product-row-${id}`).remove());
            alert(result.message);
            updateBulkActionButtons();
        } catch (error) {
            alert(`ä¸€æ‹¬å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`);
        }
    }

    const statusMap = {
        'ç”Ÿæƒ…å ±å–å¾—': { emoji: 'â˜ï¸', color: 'secondary' },
        'URLå–å¾—æ¸ˆ': { emoji: 'â›…ï¸', color: 'info' },
        'æŠ•ç¨¿æº–å‚™å®Œäº†': { emoji: 'â˜€ï¸', color: 'primary' },
        'æŠ•ç¨¿æ¸ˆ': { emoji: 'ğŸ‰', color: 'success' },
        'ã‚¨ãƒ©ãƒ¼': { emoji: 'âš ï¸', color: 'danger' }
    };

    function renderStatusSummary(summary) {
        const summaryContainer = document.getElementById('status-summary');
        summaryContainer.innerHTML = '';
        const orderedStatuses = ['ç”Ÿæƒ…å ±å–å¾—', 'URLå–å¾—æ¸ˆ', 'æŠ•ç¨¿æº–å‚™å®Œäº†']; // ã‚µãƒãƒªãƒ¼ã«è¡¨ç¤ºã™ã‚‹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
        
        orderedStatuses.forEach(status => {
            const count = summary[status] || 0;
            const statusInfo = statusMap[status] || { emoji: 'â“', color: 'light' };
            const cardHtml = `
                <div class="col" title="${status}" style="cursor: default;">
                    <div class="card card-body text-center h-100">
                        <div class="d-flex justify-content-center align-items-center h-100 gap-2">
                            <span class="fs-4">${statusInfo.emoji}</span><span class="fs-4 fw-bold">${count}</span>
                        </div>
                    </div>
                </div>
            `;
            summaryContainer.innerHTML += cardHtml;
        });

        // æ–°ã—ãè¿½åŠ ã—ãŸTooltipã‚’åˆæœŸåŒ–
        const tooltipTriggerList = summaryContainer.querySelectorAll('[data-bs-toggle="tooltip"]');
        [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl));
    }

    function renderProducts(startIndex, count) {
        const tableBody = document.getElementById('inventory-table-body');
        
        // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã•ã‚ŒãŸå•†å“ãƒªã‚¹ãƒˆã‚’å–å¾—
        const filteredProducts = allProductsData.filter(product => {
            const searchTerm = currentFilters.searchTerm.toLowerCase();
            if (!searchTerm) return true; // æ¤œç´¢èªãŒãªã‘ã‚Œã°ã™ã¹ã¦è¡¨ç¤º
            return (
                (product.name && product.name.toLowerCase().includes(searchTerm)) ||
                (product.shop_name && product.shop_name.toLowerCase().includes(searchTerm)) ||
                (product.ai_caption && product.ai_caption.toLowerCase().includes(searchTerm))
            );
        });

        if (startIndex === 0 && filteredProducts.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="6" class="text-center">åœ¨åº«å•†å“ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</td></tr>';
            return;
        }

        const productsToRender = filteredProducts.slice(startIndex, startIndex + count);

        let inconsistentCount = 0;
        let rowsHtml = '';
        productsToRender.forEach(product => {
            const statusHtml = getStatusIcon(product); // ã“ã®è¡Œã¯å¤‰æ›´ã‚ã‚Šã¾ã›ã‚“ãŒã€å‘¨è¾ºã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã¨ã—ã¦è¡¨ç¤ºã—ã¦ã„ã¾ã™

            const createdAt = product.created_at ? new Date(product.created_at).toLocaleDateString('ja-JP') : 'N/A';
            rowsHtml += `
                <tr id="product-row-${product.id}">
                    <td><input class="form-check-input product-checkbox" type="checkbox" value="${product.id}"></td>
                    <td class="text-center drag-handle" style="vertical-align: middle;"><i class="bi bi-grip-vertical"></i></td>
                    <td><a href="${product.url}" target="_blank" rel="noopener noreferrer"><img src="${product.image_url || 'https://via.placeholder.com/80'}" alt="${product.name}" class="img-thumbnail inventory-thumbnail"></a></td>
                    <td class="text-start" style="min-width: 0;">
                        <div class="d-flex align-items-baseline">
                            <span class="shop-name-badge badge bg-light text-dark border me-2" title="${product.shop_name || ''}">
                                ${product.shop_name || ''}
                            </span>
                            <div class="fw-bold truncate-cell" title="${product.name || ''}">${product.name || ''}</div>
                        </div>
                        <div class="text-muted small truncate-cell" title="${product.ai_caption || ''}">${product.ai_caption || ''}</div>
                    </td>
                    <td class="text-center" onclick="showInfoModal(this)" data-name="${product.name || ''}" data-caption="${product.ai_caption || ''}" data-post-url="${product.post_url || ''}" data-procurement-keyword="${product.procurement_keyword || ''}" data-shop-name="${product.shop_name || ''}">${statusHtml}</td>
                    <td>${createdAt}</td>
                </tr>
            `;
        });

        if (startIndex === 0) tableBody.innerHTML = rowsHtml;
        else tableBody.innerHTML += rowsHtml;
        displayedCount = tableBody.children.length;

    }

    function loadMoreProducts() {
        if (isLoading || displayedCount >= allProductsData.length) {
            return;
        }
        isLoading = true;
        const loadingIndicator = document.getElementById('loading-indicator');
        loadingIndicator.style.display = 'block';

        // æ“¬ä¼¼çš„ãªé…å»¶ã‚’å…¥ã‚Œã¦ã€èª­ã¿è¾¼ã¿ä¸­ã§ã‚ã‚‹ã“ã¨ã‚’è¦–è¦šçš„ã«ç¤ºã™
        setTimeout(() => {
            renderProducts(displayedCount, ITEMS_PER_LOAD);
            isLoading = false;
            loadingIndicator.style.display = 'none';
        }, 300);
    }

    // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚¤ãƒ™ãƒ³ãƒˆã®ãƒªã‚¹ãƒŠãƒ¼
    window.addEventListener('scroll', () => {
        // ç”»é¢ã®é«˜ã• + ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é‡ ãŒ ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå…¨ä½“ã®é«˜ã• - 300pxï¼ˆä½™è£•ï¼‰ã‚’è¶…ãˆãŸã‚‰æ¬¡ã®ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
        if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 300) {
            loadMoreProducts();
        }
    });

    document.addEventListener('DOMContentLoaded', function () {
        const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
        [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl));
        infoModalInstance = new bootstrap.Modal(document.getElementById('infoModal'));
        const shopSearchModal = new bootstrap.Modal(document.getElementById('shopSearchModal'));

        // æ¤œç´¢ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        document.getElementById('search-btn').addEventListener('click', applyFiltersAndRender);
        document.getElementById('search-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') applyFiltersAndRender();
        });
        // ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        document.getElementById('clear-btn').addEventListener('click', clearFiltersAndRender);

        fetch('/api/inventory/summary').then(response => response.json()).then(renderStatusSummary);

        fetch('/api/inventory')
            .then(response => response.json())
            .then(data => {
                allProductsData = data;
                const tableBody = document.getElementById('inventory-table-body');
                tableBody.innerHTML = '';
                renderProducts(0, ITEMS_PER_LOAD); // æœ€åˆã®Nä»¶ã‚’æç”»

                if (sortableInstance) sortableInstance.destroy();
                sortableInstance = new Sortable(tableBody, {
                    animation: 150,
                    ghostClass: 'sortable-ghost',
                    handle: '.drag-handle',
                    onEnd: async function (evt) {
                        const productIds = Array.from(tableBody.querySelectorAll('tr')).map(tr => tr.id.replace('product-row-', ''));
                        try {
                            await fetch('/api/inventory/update-order', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ product_ids: productIds })
                            });
                        } catch (error) {
                            alert(`ã‚¨ãƒ©ãƒ¼: é †åºã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸã€‚`);
                            location.reload();
                        }
                    }
                });
            });
        
        // å€‹åˆ¥ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        document.getElementById('inventory-table-body').addEventListener('change', function (e) {
            const checkbox = e.target;
            if (checkbox.classList.contains('product-checkbox')) {
                checkbox.closest('tr').classList.toggle('selected', checkbox.checked);
                updateBulkActionButtons();
            }
        });

        // ãƒ†ãƒ¼ãƒ–ãƒ«è¡Œã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        document.getElementById('inventory-table-body').addEventListener('click', function (e) {
            // ãƒœã‚¿ãƒ³ã€ãƒªãƒ³ã‚¯ã€ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã€ãƒ‰ãƒ©ãƒƒã‚°ãƒãƒ³ãƒ‰ãƒ«è‡ªä½“ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸå ´åˆã¯è¡Œé¸æŠã‚’ç„¡åŠ¹ã«ã™ã‚‹
            if (e.target.closest('a, button, .form-check-input, .drag-handle')) return;

            const row = e.target.closest('tr');
            const checkbox = row.querySelector('.product-checkbox');
            if (checkbox) {
                checkbox.click(); // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºç«ã•ã›ã‚‹
            }
        });

        // é•·æŠ¼ã—ã§ç§»å‹•ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤ºã™ã‚‹ãŸã‚ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        let longPressTimer = null;
        document.getElementById('inventory-table-body').addEventListener('touchstart', function(e) {
            const handle = e.target.closest('.drag-handle');
            if (handle) {
                // æ—¢ã«ãƒœã‚¿ãƒ³ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã€ä½•ã‚‚ã—ãªã„
                if (handle.querySelector('.move-buttons')) {
                    return;
                }

                // é•·æŠ¼ã—ã‚¿ã‚¤ãƒãƒ¼ã‚’é–‹å§‹
                longPressTimer = setTimeout(() => {
                    showMoveButtons(handle, e);
                    longPressTimer = null; // ã‚¿ã‚¤ãƒãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆ
                }, 500); // 500ãƒŸãƒªç§’ï¼ˆ0.5ç§’ï¼‰ã§é•·æŠ¼ã—ã¨åˆ¤å®š
            }
        });

        document.getElementById('inventory-table-body').addEventListener('touchend', function(e) {
            // æŒ‡ãŒé›¢ã‚ŒãŸã‚‰ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
            clearTimeout(longPressTimer);
        });

        document.getElementById('inventory-table-body').addEventListener('touchmove', function(e) {
            // æŒ‡ãŒå‹•ã„ãŸã‚‰ï¼ˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚„ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹ï¼‰ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
            clearTimeout(longPressTimer);
        });

        // ç§»å‹•ãƒœã‚¿ãƒ³è¡¨ç¤ºé–¢æ•°
        function showMoveButtons(handleCell, event) {
            event.stopPropagation();
            // æ—¢å­˜ã®ãƒœã‚¿ãƒ³ã‚’ã™ã¹ã¦å‰Šé™¤
            removeMoveButtons();

            const row = handleCell.closest('tr');
            const tableBody = row.parentElement;

            const buttonContainer = document.createElement('div');
            buttonContainer.className = 'move-buttons';
            buttonContainer.innerHTML = `
                <button class="btn btn-sm btn-light p-0" data-action="move-top" title="ä¸€ç•ªä¸Šã«ç§»å‹•"><i class="bi bi-chevron-double-up"></i></button>
                <button class="btn btn-sm btn-light p-0" data-action="move-bottom" title="ä¸€ç•ªä¸‹ã«ç§»å‹•"><i class="bi bi-chevron-double-down"></i></button>
            `;

            // ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’ã“ã“ã§ç™»éŒ²
            buttonContainer.addEventListener('click', function(e) {
                const button = e.target.closest('button');
                if (button && button.dataset.action === 'move-top') moveRowTop(button, e);
                if (button && button.dataset.action === 'move-bottom') moveRowBottom(button, e);
            });

            handleCell.appendChild(buttonContainer);
        }

        function moveRowTop(button, event) {
            event.stopPropagation();
            event.preventDefault();
            const row = button.closest('tr');
            const tableBody = row.parentElement;
            tableBody.prepend(row);
            removeMoveButtons();
            saveOrder();
        }

        function moveRowBottom(button, event) {
            event.stopPropagation();
            event.preventDefault();
            const row = button.closest('tr');
            const tableBody = row.parentElement;
            tableBody.append(row);
            removeMoveButtons();
            saveOrder();
        }



        function removeMoveButtons() {
            document.querySelectorAll('.move-buttons').forEach(el => el.remove());
        }

        async function saveOrder() {
            const tableBody = document.getElementById('inventory-table-body');
            const productIds = Array.from(tableBody.querySelectorAll('tr')).map(tr => tr.id.replace('product-row-', ''));
            try {
                await fetch('/api/inventory/update-order', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ product_ids: productIds })
                });
            } catch (error) {
                alert(`ã‚¨ãƒ©ãƒ¼: é †åºã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚`);
            }
        }

        // ãƒœã‚¿ãƒ³ä»¥å¤–ã®å ´æ‰€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã‚‰ãƒœã‚¿ãƒ³ã‚’æ¶ˆã™
        document.addEventListener('click', function(event) {
            // ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã®ãŒç§»å‹•ãƒœã‚¿ãƒ³ã®ã‚³ãƒ³ãƒ†ãƒŠã§ãªã‘ã‚Œã°ã€ãƒœã‚¿ãƒ³ã‚’å‰Šé™¤
            if (!event.target.closest('.move-buttons')) {
                removeMoveButtons();
            }
        });

        // ã‚·ãƒ£ãƒƒãƒ•ãƒ«ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        document.getElementById('shuffle-btn').addEventListener('click', () => {
            const tableBody = document.getElementById('inventory-table-body');
            const rows = Array.from(tableBody.children);

            // 1è¡Œä»¥ä¸‹ã®å ´åˆã¯ä½•ã‚‚ã—ãªã„
            if (rows.length <= 1) return;

            // Fisher-Yatesã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã§é…åˆ—ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«
            for (let i = rows.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [rows[i], rows[j]] = [rows[j], rows[i]];
            }

            // ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã•ã‚ŒãŸè¡Œã‚’ãƒ†ãƒ¼ãƒ–ãƒ«ã«å†è¿½åŠ ã—ã¦DOMã‚’æ›´æ–°
            rows.forEach(row => tableBody.appendChild(row));

            // æ—¢å­˜ã®é †åºä¿å­˜é–¢æ•°ã‚’å‘¼ã³å‡ºã—ã¦å¤‰æ›´ã‚’DBã«ä¿å­˜
            saveOrder();
        });

        // ã‚·ãƒ§ãƒƒãƒ—åã§ã®ã‚½ãƒ¼ãƒˆãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        document.getElementById('sort-by-shop-btn').addEventListener('click', () => {
            // 1. ã‚·ãƒ§ãƒƒãƒ—ã”ã¨ã®å•†å“æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
            const shopCounts = allProductsData.reduce((acc, product) => {
                const shopName = product.shop_name || 'ï¼ˆã‚·ãƒ§ãƒƒãƒ—åãªã—ï¼‰';
                acc[shopName] = (acc[shopName] || 0) + 1;
                return acc;
            }, {});

            // 2. å•†å“ãƒªã‚¹ãƒˆã‚’ã‚½ãƒ¼ãƒˆ
            allProductsData.sort((a, b) => {
                const shopNameA = a.shop_name || 'ï¼ˆã‚·ãƒ§ãƒƒãƒ—åãªã—ï¼‰';
                const shopNameB = b.shop_name || 'ï¼ˆã‚·ãƒ§ãƒƒãƒ—åãªã—ï¼‰';
                
                const countA = shopCounts[shopNameA];
                const countB = shopCounts[shopNameB];

                // ã‚«ã‚¦ãƒ³ãƒˆãŒå¤šã„é †ã«ã‚½ãƒ¼ãƒˆ
                if (countB !== countA) {
                    return countB - countA;
                }
                
                // ã‚«ã‚¦ãƒ³ãƒˆãŒåŒã˜å ´åˆã¯ã€ã‚·ãƒ§ãƒƒãƒ—åã§ã‚½ãƒ¼ãƒˆ
                if (shopNameA < shopNameB) return -1;
                if (shopNameA > shopNameB) return 1;

                // ã‚·ãƒ§ãƒƒãƒ—åã‚‚åŒã˜å ´åˆã¯ã€å…ƒã®é †åºï¼ˆä½œæˆæ—¥ãªã©ï¼‰ã‚’ç¶­æŒ
                return 0;
            });

            // 3. ç”»é¢ã‚’å†æç”»
            const tableBody = document.getElementById('inventory-table-body');
            tableBody.innerHTML = ''; // æ—¢å­˜ã®ãƒªã‚¹ãƒˆã‚’ã‚¯ãƒªã‚¢
            displayedCount = 0; // è¡¨ç¤ºä»¶æ•°ã‚’ãƒªã‚»ãƒƒãƒˆ
            renderProducts(0, ITEMS_PER_LOAD); // ã‚½ãƒ¼ãƒˆå¾Œã®ãƒªã‚¹ãƒˆã§å†æç”»
            window.scrollTo(0, 0); // ä¸€ç•ªä¸Šã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
            showToast('ã‚½ãƒ¼ãƒˆå®Œäº†', 'ã‚·ãƒ§ãƒƒãƒ—ã®å•†å“æ•°ãŒå¤šã„é †ã«ä¸¦ã³æ›¿ãˆã¾ã—ãŸã€‚', 'success');
        });

        // --- æ¤œç´¢é–¢é€£ã®é–¢æ•° ---
        function applyFiltersAndRender() {
            currentFilters.searchTerm = document.getElementById('search-input').value;
            
            const tableBody = document.getElementById('inventory-table-body');
            tableBody.innerHTML = ''; // ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ã‚¯ãƒªã‚¢
            displayedCount = 0; // è¡¨ç¤ºä»¶æ•°ã‚’ãƒªã‚»ãƒƒãƒˆ
            renderProducts(0, ITEMS_PER_LOAD); // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã—ã¦å†æç”»
            window.scrollTo(0, 0); // ä¸€ç•ªä¸Šã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
        }

        function clearFiltersAndRender() {
            document.getElementById('search-input').value = '';
            applyFiltersAndRender();
        }

        // --- ã‚·ãƒ§ãƒƒãƒ—åã‚½ãƒ¼ãƒˆãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’æ¤œç´¢ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãã‚ˆã†ã«å¤‰æ›´ ---
        document.getElementById('sort-by-shop-btn').addEventListener('click', async () => {
            const shopListContainer = document.getElementById('shop-list-container');
            shopListContainer.innerHTML = '<div class="text-center"><div class="spinner-border spinner-border-sm"></div></div>';
            shopSearchModal.show();

            // ã‚·ãƒ§ãƒƒãƒ—ãƒªã‚¹ãƒˆã‚’ç”Ÿæˆ
            const shopCounts = allProductsData.reduce((acc, product) => {
                const shopName = product.shop_name || 'ï¼ˆã‚·ãƒ§ãƒƒãƒ—åãªã—ï¼‰';
                acc[shopName] = (acc[shopName] || 0) + 1;
                return acc;
            }, {});

            const sortedShops = Object.entries(shopCounts)
                .map(([shop_name, product_count]) => ({ shop_name, product_count }))
                .sort((a, b) => b.product_count - a.product_count);

            renderShopList(sortedShops);
        });

        function renderShopList(shops) {
            const shopListContainer = document.getElementById('shop-list-container');
            shopListContainer.innerHTML = '';
            if (shops.length === 0) {
                shopListContainer.innerHTML = '<p class="text-muted text-center">ã‚·ãƒ§ãƒƒãƒ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚</p>';
                return;
            }
            shops.forEach(shopInfo => {
                const item = document.createElement('button');
                item.type = 'button';
                item.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center';
                item.innerHTML = `<span>${shopInfo.shop_name}</span><span class="badge bg-primary rounded-pill">${shopInfo.product_count}</span>`;
                item.onclick = () => {
                    document.getElementById('search-input').value = shopInfo.shop_name;
                    applyFiltersAndRender();
                    shopSearchModal.hide();
                };
                shopListContainer.appendChild(item);
            });
        }
    });
</script>
{% endblock %}
