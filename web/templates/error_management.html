{% extends "base.html" %}

{% block title %}ã‚¨ãƒ©ãƒ¼ç®¡ç† - R-Auto Control Panel{% endblock %}

{% block styles %}
<style>
    .truncate-cell {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .truncate-2-lines {
        display: -webkit-box;
        -webkit-box-orient: vertical;
        -webkit-line-clamp: 2;
        overflow: hidden;
        text-overflow: ellipsis;
        line-height: 1.4; /* 1è¡Œã®é«˜ã•ã‚’æŒ‡å®š */
        height: 2.8em;    /* 2è¡Œåˆ†ã®é«˜ã•ã‚’ç¢ºä¿ (line-height * 2) */
    }
    tbody tr {
        cursor: pointer;
    }
    tr.selected .img-thumbnail {
        border: 3px solid #0d6efd;
        padding: 1px;
    }
    .table .form-check-input {
        width: 1.25em;
        height: 1.25em;
        vertical-align: middle;
    }
    /* ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ãªã©ã®å°ã•ã„ç”»é¢å‘ã‘ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    @media (max-width: 767.98px) {
        thead {
            display: none; /* ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’éè¡¨ç¤º */
        }
        tr {
            display: grid;
            grid-template-columns: 50px 1fr; /* ã‚µãƒ ãƒã‚¤ãƒ« | æƒ…å ± */
            grid-template-areas:
                "thumb info";
            gap: 0.5rem;
            border: 1px solid #dee2e6;
            border-top: none; /* ä¸Šã®å¢ƒç•Œç·šã‚’æ¶ˆã™ */
            border-radius: .25rem;
            margin-bottom: 0; /* ä¸‹ã®ãƒãƒ¼ã‚¸ãƒ³ã‚’ãªãã™ */
            padding: 0.75rem;
            position: relative;
        }
        td {
            display: block;
            text-align: left !important; /* å…¨ã¦ã®ã‚»ãƒ«ã‚’å·¦å¯„ã›ã« */
            width: 100% !important; /* å¹…ã‚’100%ã« */
            border: none;
            padding: 0;
        }
        /* å„ã‚»ãƒ«ã«ãƒ©ãƒ™ãƒ«ã‚’è¿½åŠ  */
        td:before {
            content: attr(data-label);
            font-weight: bold;
            display: block;
            color: #6c757d;
        }
        /* grid-areaã§é…ç½® */
        td[data-label="ã‚µãƒ ãƒã‚¤ãƒ«"] { grid-area: thumb; }
        td[data-label="å•†å“æƒ…å ±"] {
            grid-area: info; 
            display: flex; /* Flexboxã«å¤‰æ›´ */
            justify-content: space-between; /* ä¸¡ç«¯æƒãˆ */
            align-items: center; /* ä¸­å¤®æƒãˆ */
            gap: 0.5rem; /* è¦ç´ é–“ã®éš™é–“ */
            min-width: 0; /* flexã‚¢ã‚¤ãƒ†ãƒ ã®ç¸®å°ã‚’è¨±å¯ */
        }

        /* ã‚¹ãƒãƒ›ã§ã¯éè¡¨ç¤ºã«ã™ã‚‹åˆ— */
        td[data-label="å„ç¨®ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—"],
        td[data-label="ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹"] {
            display: none;
        }
        td[data-label="ID"] {
            position: absolute;
            top: 0.25rem;
            left: 0.25rem;
            background-color: transparent;
            color: #000;
            padding: 0.1rem 0.4rem;
            border-radius: .25rem;
            font-size: 0.7rem;
            line-height: 1.2;
            z-index: 10;
        }

        /* ãƒ©ãƒ™ãƒ«ãŒä¸è¦ãªã‚»ãƒ« */
        td[data-label="ã‚µãƒ ãƒã‚¤ãƒ«"]:before,
        td[data-label="å•†å“æƒ…å ±"]:before,
        td[data-label="ID"]:before {
            content: "";
            display: none;
        }
        /* æœ€åˆã®è¡Œã ã‘ä¸Šã®å¢ƒç•Œç·šã‚’è¡¨ç¤º */
        tr:first-child {
            border-top: 1px solid #dee2e6;
        }

        /* PCè¡¨ç¤ºã‚’éè¡¨ç¤ºã« */
        .desktop-only {
            display: none;
        }
    }
    /* PCå¹…ã§ã¯ãƒ¢ãƒã‚¤ãƒ«è¡¨ç¤ºã‚’éè¡¨ç¤ºã« */
    @media (min-width: 767.99px) {
        .mobile-only {
            display: none;
        }
    }
    /* ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹åˆ—ã‚’å¸¸ã«éè¡¨ç¤ºã«ã™ã‚‹ */
    .table th:first-child,
    .table td:first-child {
        display: none;
    }
    /* ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆãƒªã‚¹ãƒˆã®é¸æŠçŠ¶æ…‹ */
    .list-group-item.selected {
        background-color: #e9ecef; /* é¸æŠæ™‚ã®èƒŒæ™¯è‰² */
    }
    /* ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®ç”»åƒã‚¹ã‚¿ã‚¤ãƒ« */
    #preview-image-wrapper {
        height: 30vh; /* ãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆã®é«˜ã•ã®30%ã‚’æœ€å¤§é«˜ã¨ã™ã‚‹ */
        display: flex;
        justify-content: center;
        align-items: center;
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">ğŸš¨ ã‚¨ãƒ©ãƒ¼å•†å“ç®¡ç†</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2" id="bulk-action-group">
            <button type="button" class="btn btn-sm btn-outline-primary" onclick="bulkUpdateStatus('æŠ•ç¨¿æº–å‚™å®Œäº†')" disabled title="é¸æŠã—ãŸå•†å“ã‚’ã€ŒæŠ•ç¨¿æº–å‚™å®Œäº†ã€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã«å¤‰æ›´ã—ã¾ã™">
                <i class="bi bi-arrow-clockwise me-1"></i>â˜€ï¸ å†æŠ•ç¨¿æº–å‚™
            </button>
            <button type="button" class="btn btn-sm btn-outline-primary dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown" aria-expanded="false" disabled>
                <span class="visually-hidden">Toggle Dropdown</span>
            </button>
            <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="#" onclick="event.preventDefault(); bulkUpdateStatus('æŠ•ç¨¿æº–å‚™å®Œäº†')">â˜€ï¸ ã€ŒæŠ•ç¨¿æº–å‚™å®Œäº†ã€ã«ã™ã‚‹</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="#" onclick="event.preventDefault(); bulkUpdateStatus('ç”Ÿæƒ…å ±å–å¾—')">â˜ï¸ ã€Œç”Ÿæƒ…å ±å–å¾—ã€ã«æˆ»ã™</a></li>
                <li><a class="dropdown-item" href="#" onclick="event.preventDefault(); bulkUpdateStatus('URLå–å¾—æ¸ˆ')">â›…ï¸ ã€ŒURLå–å¾—æ¸ˆã€ã«æˆ»ã™</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="#" onclick="event.preventDefault(); bulkUpdateStatus('æŠ•ç¨¿æ¸ˆ')">ğŸš€ ã€ŒæŠ•ç¨¿æ¸ˆã€ã«ã™ã‚‹</a></li>
                <li><a class="dropdown-item" href="#" onclick="event.preventDefault(); bulkUpdateStatus('å¯¾è±¡å¤–')">â˜” ã€Œå¯¾è±¡å¤–ã€ã«ã™ã‚‹</a></li>
            </ul>
            <button type="button" class="btn btn-sm btn-outline-info" id="export-json-btn" onclick="exportToJson()" disabled title="é¸æŠã—ãŸå•†å“ã®å…¨ãƒ‡ãƒ¼ã‚¿ã‚’JSONå½¢å¼ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™">
                <i class="bi bi-file-earmark-code me-1"></i>JSONã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
            </button>
            <button type="button" class="btn btn-sm btn-outline-secondary" id="select-all-toggle-btn" onclick="toggleSelectAll()">
                <i class="bi bi-check-square me-1"></i>ã™ã¹ã¦é¸æŠ
            </button>
            <button type="button" class="btn btn-sm btn-outline-danger" id="bulk-delete-btn" onclick="bulkDelete()" disabled>
                <i class="bi bi-trash-fill me-1"></i>é¸æŠã—ãŸé …ç›®ã‚’å‰Šé™¤
            </button>
        </div>
    </div>
</div>

<div class="accordion mb-4" id="importAccordion">
    <div class="accordion-item">
        <h2 class="accordion-header" id="headingOne">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="false" aria-controls="collapseOne">
                <i class="bi bi-file-earmark-arrow-down-fill me-2"></i>JSONã‹ã‚‰å•†å“ã‚’ä¸€æ‹¬æ›´æ–°ï¼ˆã‚¯ãƒªãƒƒã‚¯ã—ã¦å±•é–‹ï¼‰
            </button>
        </h2>
        <div id="collapseOne" class="accordion-collapse collapse" aria-labelledby="headingOne" data-bs-parent="#importAccordion">
            <div class="accordion-body">
                <p class="text-muted small">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ãŸJSONã‚’ç·¨é›†ã—ã€ã“ã“ã«è²¼ã‚Šä»˜ã‘ã¦æ›´æ–°ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚`post_url`ã¨`ai_caption`ã®æœ‰ç„¡ã«å¿œã˜ã¦ã€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã¨ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ãŒè‡ªå‹•ã§æ›´æ–°ã•ã‚Œã¾ã™ã€‚</p>
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <label for="json-import-textarea" class="form-label mb-0">ã“ã“ã«JSONãƒ‡ãƒ¼ã‚¿ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„</label>
                        <a href="https://gemini.google.com/u/1/gem/d22f71530f97" class="btn btn-sm btn-outline-secondary" target="_blank" rel="noopener noreferrer">
                        <i class="bi bi-robot me-1"></i>æŠ•ç¨¿æ–‡ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ï¼‹
                        </a>
                    </div>
                    <textarea class="form-control" id="json-import-textarea" rows="5" placeholder="[&#10;  {&#10;    &quot;id&quot;: 123,&#10;    &quot;post_url&quot;: &quot;https://...&quot;,&#10;    &quot;ai_caption&quot;: &quot;...&quot;&#10;  },&#10;  ...&#10;]"></textarea>
                </div>
                <button class="btn btn-primary" onclick="importFromJson()">
                    <i class="bi bi-upload me-1"></i>ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¦DBã‚’æ›´æ–°
                </button>
            </div>
        </div>
    </div>
</div>

<div class="table-responsive">
    <table class="table table-striped table-sm align-middle" style="table-layout: fixed; width: 100%;">
        <thead>
            <tr>
                <th scope="col" style="width: 5%;"></th>
                <th scope="col" style="width: 8%;">ã‚µãƒ ãƒã‚¤ãƒ«</th>
                <th scope="col" style="width: 5%;">ID</th>
                <th scope="col" style="width: 38%;">å•†å“æƒ…å ±</th>
                <th scope="col" style="width: 20%;">å„ç¨®ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—</th>
                <th scope="col" style="width: 10%;">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
            </tr>
        </thead>
        <tbody id="error-table-body">
            <!-- ãƒ‡ãƒ¼ã‚¿ã¯JavaScriptã§ã“ã“ã«æŒ¿å…¥ã•ã‚Œã¾ã™ -->
        </tbody>
    </table>
</div>

<hr class="my-4">

<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">ğŸ“¸ Playwrightã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2" id="screenshot-bulk-action-group">
            <button type="button" class="btn btn-sm btn-outline-secondary" id="screenshot-select-all-toggle-btn" onclick="toggleSelectAllScreenshots()">
                <i class="bi bi-check-square me-1"></i>ã™ã¹ã¦é¸æŠ
            </button>
            <button type="button" class="btn btn-sm btn-outline-danger" id="screenshot-bulk-delete-btn" onclick="bulkDeleteScreenshots()" disabled>
                <i class="bi bi-trash-fill me-1"></i>é¸æŠã—ãŸé …ç›®ã‚’å‰Šé™¤
            </button>
        </div>
    </div>
</div>
<p>Playwrightã‚¿ã‚¹ã‚¯ã®å®Ÿè¡Œä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸéš›ã«è‡ªå‹•ã§ä¿å­˜ã•ã‚ŒãŸã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã§ã™ã€‚æ–°ã—ã„ã‚‚ã®ãŒä¸€ç•ªä¸Šã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>

{% if files %}
    <div class="list-group" id="screenshot-list">
    {% for file in files %}
        <div class="list-group-item list-group-item-action" id="screenshot-{{ loop.index }}" onclick="toggleScreenshotSelection(this, event)">
            <div class="d-flex align-items-center">
                <!-- ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã¯éè¡¨ç¤ºã«ã™ã‚‹ãŒã€æ©Ÿèƒ½ã®ãŸã‚ã«æ®‹ã™ -->
                <input class="form-check-input me-3 screenshot-checkbox d-none" type="checkbox" value="{{ file }}" onclick="updateScreenshotBulkActionButtons()">
                
                <!-- ç”»åƒã‚¢ã‚¤ã‚³ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã§ç”»åƒã‚’é–‹ã -->
                <a href="/api/screenshots/{{ file }}" target="_blank" class="me-3 text-secondary fs-4" onclick="event.stopPropagation()" title="ç”»åƒã‚’é–‹ã">
                    <i class="bi bi-image"></i>
                </a>

                <div class="flex-grow-1" style="min-width: 0;">
                    <div>
                        <strong>{{ file_details[file]['action_name'] }} 
                            {% if file_details[file]['details'] %}
                                <span class="text-muted fw-normal">({{ file_details[file]['details'] | truncate(12, True, '...') }})</span>
                            {% endif %}
                        </strong>
                        <small class="text-muted">ç™ºç”Ÿæ—¥æ™‚: {{ file_details[file]['timestamp'] }}</small>
                    </div>
                </div>
                <button class="btn btn-sm btn-outline-danger ms-3" onclick="deleteScreenshot(this, '{{ file }}')" title="ã“ã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’å‰Šé™¤">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
        </div>
    {% endfor %}
    </div>
{% else %}
    <div class="alert alert-info" role="alert">
        ç¾åœ¨ã€ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
    </div>
{% endif %}

{% if files %}
<hr class="my-5">
<div class="row">
    <div class="col-12">
        <h2 class="h3 mb-3">ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h2>
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center" id="preview-card-header">
                <span class="text-muted small" id="preview-filename"></span>
                <span class="text-muted small" id="preview-timestamp"></span>
            </div>
            <div class="card-body text-center">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <button class="btn btn-outline-secondary" id="prev-preview-btn"><i class="bi bi-arrow-left"></i> å‰ã¸</button>
                    <span class="text-muted" id="preview-counter">1 / {{ files|length }}</span>
                    <button class="btn btn-outline-secondary" id="next-preview-btn">æ¬¡ã¸ <i class="bi bi-arrow-right"></i></button>
                </div>
                <a id="preview-image-link" href="/api/screenshots/{{ files[0] }}" target="_blank" title="æ–°ã—ã„ã‚¿ãƒ–ã§ç”»åƒã‚’é–‹ã">
                    <div id="preview-image-wrapper">
                        <img id="preview-image" src="/api/screenshots/{{ files[0] }}" class="img-fluid rounded" alt="ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼" style="max-height: 100%; object-fit: contain;">
                    </div>
                </a>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- å•†å“æƒ…å ±è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="infoModal" tabindex="-1" aria-labelledby="infoModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="infoModalLabel">ã‚¨ãƒ©ãƒ¼è©³ç´°</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <h5 class="text-danger"><i class="bi bi-exclamation-triangle-fill me-2"></i>ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</h5>
        <pre id="modal-error-message" class="bg-light p-3 rounded mb-3" style="white-space: pre-wrap; word-break: break-all; font-size: 0.9rem;"></pre>
        
        <h5 class="mt-4"><i class="bi bi-clock-history me-2"></i>ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—</h5>
        <ul class="list-group list-group-flush mb-3" id="modal-timestamps">
            <!-- JSã§ã“ã“ã«ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ãŒæŒ¿å…¥ã•ã‚Œã¾ã™ -->
        </ul>

        <h5 class="mt-4">
            <a class="text-decoration-none text-dark" data-bs-toggle="collapse" href="#collapseFullDataError" role="button" aria-expanded="false" aria-controls="collapseFullDataError">
                <i class="bi bi-database me-2"></i>å…¨ãƒ‡ãƒ¼ã‚¿ <i class="bi bi-chevron-down small"></i>
            </a>
        </h5>
        <div class="collapse" id="collapseFullDataError">
            <pre><code id="modal-full-data" class="bg-light p-3 rounded" style="font-size: 0.8rem; display: block; min-height: 100px;"></code></pre>
            <button class="btn btn-sm btn-outline-secondary mt-2" onclick="copyFullData('modal-full-data')">
                <i class="bi bi-clipboard me-1"></i>ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
            </button>
        </div>

      </div>
      <div class="modal-footer">
        <a href="#" id="modal-post-link" class="btn btn-primary" target="_blank" rel="noopener noreferrer" style="display: none;"><i class="bi bi-box-arrow-up-right me-1"></i>æŠ•ç¨¿ãƒšãƒ¼ã‚¸ã‚’é–‹ã</a>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    function getSelectedScreenshots() {
        return Array.from(document.querySelectorAll('.screenshot-checkbox:checked')).map(cb => cb.value);
    }

    function updateScreenshotBulkActionButtons() {
        const selectedFiles = getSelectedScreenshots();
        const disabled = selectedFiles.length === 0;
        document.querySelectorAll('#screenshot-bulk-action-group button').forEach(button => {
            // ã€Œã™ã¹ã¦é¸æŠã€ãƒœã‚¿ãƒ³ã¯å¸¸ã«æœ‰åŠ¹
            if (button.id !== 'screenshot-select-all-toggle-btn') {
                button.disabled = disabled;
            }
        });
    }

    function toggleSelectAllScreenshots() {
        const allCheckboxes = document.querySelectorAll('.screenshot-checkbox');
        const isAllSelected = getSelectedScreenshots().length === allCheckboxes.length;
        allCheckboxes.forEach(checkbox => {
            checkbox.checked = !isAllSelected;
        });
        updateScreenshotBulkActionButtons();
    }

    async function bulkDeleteScreenshots() {
        const filesToDelete = getSelectedScreenshots();
        if (filesToDelete.length === 0) {
            alert('å‰Šé™¤ã™ã‚‹ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
            return;
        }
        if (!confirm(`${filesToDelete.length}ä»¶ã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
            return;
        }

        // Promise.allSettled ã‚’ä½¿ã£ã¦ã€ã™ã¹ã¦ã®å‰Šé™¤ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ä¸¦è¡Œã—ã¦å®Ÿè¡Œ
        const results = await Promise.allSettled(filesToDelete.map(filename => 
            fetch(`/api/screenshots/${filename}`, { method: 'DELETE' })
        ));

        let successCount = 0;
        let failedCount = 0;

        results.forEach((result, index) => {
            const filename = filesToDelete[index];
            if (result.status === 'fulfilled' && result.value.ok) {
                // æˆåŠŸã—ãŸã‚‰UIã‹ã‚‰è¦ç´ ã‚’å‰Šé™¤
                document.querySelector(`.screenshot-checkbox[value="${filename}"]`).closest('.list-group-item').remove();
                successCount++;
            } else {
                console.error(`Failed to delete ${filename}:`, result.reason || result.value.statusText);
                failedCount++;
            }
        });

        alert(`${successCount}ä»¶ã®å‰Šé™¤ã«æˆåŠŸã—ã¾ã—ãŸã€‚\n${failedCount > 0 ? `${failedCount}ä»¶ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚è©³ç´°ã¯ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚` : ''}`);
        updateScreenshotBulkActionButtons();
    }

    async function deleteScreenshot(buttonElement, filename) {
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ç¢ºèªã‚’æ±‚ã‚ã‚‹
        if (!confirm(`æœ¬å½“ã«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã€Œ${filename}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚`)) {
            return;
        }

        try {
            const response = await fetch(`/api/screenshots/${filename}`, {
                method: 'DELETE',
            });

            const result = await response.json();
            if (!response.ok) {
                throw new Error(result.detail || 'å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            }

            // æˆåŠŸã—ãŸã‚‰ã€ãƒªã‚¹ãƒˆã‹ã‚‰ãã®é …ç›®ã‚’å‰Šé™¤
            buttonElement.closest('.list-group-item').remove();
        } catch (error) {
            alert(`ã‚¨ãƒ©ãƒ¼: ${error.message}`);
        }
    }

    function toggleScreenshotSelection(element, event) {
        // ãƒœã‚¿ãƒ³ã‚„ãƒªãƒ³ã‚¯ã®ã‚¯ãƒªãƒƒã‚¯ã¯ç„¡è¦–ã™ã‚‹
        if (event.target.closest('a, button')) {
            return;
        }
        const checkbox = element.querySelector('.screenshot-checkbox');
        if (checkbox) {
            checkbox.checked = !checkbox.checked;
            element.classList.toggle('selected', checkbox.checked);
            updateScreenshotBulkActionButtons();
        }
    }

    let infoModalInstance = null;
    let allProductsData = []; // å…¨å•†å“ãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒã™ã‚‹é…åˆ—

    function copyFullData(elementId) {
        const dataText = document.getElementById(elementId).textContent;
        navigator.clipboard.writeText(dataText).then(() => {
            // ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ã‚’è¡¨ç¤ºã™ã‚‹ (base.htmlã«showToasté–¢æ•°ãŒã‚ã‚‹ã¨ä»®å®š)
            if (typeof showToast === 'function') {
                showToast('ã‚³ãƒ”ãƒ¼å®Œäº†', 'å…¨ãƒ‡ãƒ¼ã‚¿ãŒã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã•ã‚Œã¾ã—ãŸã€‚');
            } else {
                alert('ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚');
            }
        }).catch(err => {
            console.error('ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã¸ã®ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ: ', err);
        });
    }

    function showInfoModal(element) {
        event.stopPropagation();

        // data-productå±æ€§ã‹ã‚‰JSONæ–‡å­—åˆ—ã‚’å–å¾—ã—ã€ãƒ‘ãƒ¼ã‚¹ã™ã‚‹
        const product = JSON.parse(element.dataset.product);

        // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å°‚ç”¨ã‚¨ãƒªã‚¢ã«è¡¨ç¤º
        const errorMessageElem = document.getElementById('modal-error-message');
        errorMessageElem.textContent = product.error_message || 'ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚';

        // ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—è¡¨ç¤ºã‚¨ãƒªã‚¢ã‚’ã‚¯ãƒªã‚¢ã—ã€å†æç”»
        const timestampsList = document.getElementById('modal-timestamps');
        timestampsList.innerHTML = '';

        const formatModalTimestamp = (ts) => {
            if (!ts) return '<span class="text-muted">---</span>';
            return new Date(ts).toLocaleString('ja-JP', { timeZone: 'Asia/Tokyo' });
        };

        const urlDataIcon = product.post_url ? `âœ”ï¸` : `âŒ`;
        const captionDataIcon = product.ai_caption ? `âœ”ï¸` : `âŒ`;

        const timestampItems = {
            'ä½œæˆæ—¥æ™‚': product.created_at,
            'æŠ•ç¨¿URLå–å¾—æ—¥æ™‚': { ts: product.post_url_updated_at, icon: urlDataIcon },
            'AIæ–‡ç« ä½œæˆæ—¥æ™‚': { ts: product.ai_caption_created_at, icon: captionDataIcon },
            'æŠ•ç¨¿å®Œäº†æ—¥æ™‚': product.posted_at
        };

        for (const [label, value] of Object.entries(timestampItems)) {
            const listItem = document.createElement('li');
            listItem.className = 'list-group-item d-flex justify-content-between align-items-center';
            if (typeof value === 'object' && value !== null && 'ts' in value) {
                listItem.innerHTML = `${label}<span class="badge bg-light text-dark">${formatModalTimestamp(value.ts)} <span class="ms-1">${value.icon}</span></span>`;
            } else {
                listItem.innerHTML = `${label}<span class="badge bg-light text-dark">${formatModalTimestamp(value)}</span>`;
            }
            timestampsList.appendChild(listItem);
        }

        // å…¨ãƒ‡ãƒ¼ã‚¿ã‚’æ•´å½¢ã—ã¦è¡¨ç¤ºï¼ˆã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒé•·ã„å ´åˆãŒã‚ã‚‹ã®ã§ã€JSONã‹ã‚‰ã¯é™¤å¤–ã—ã¦ã‚‚è‰¯ã„ï¼‰
        document.getElementById('modal-full-data').textContent = JSON.stringify(product, null, 2);

        const postLink = document.getElementById('modal-post-link');
        if (product.post_url) {
            postLink.href = product.post_url;
            postLink.style.display = 'inline-block';
        } else {
            postLink.style.display = 'none';
        }

        infoModalInstance.show();
    }

    function getSelectedProductIds() {
        return Array.from(document.querySelectorAll('.product-checkbox:checked')).map(cb => cb.value);
    }

    function updateBulkActionButtons() {
        const selectedIds = getSelectedProductIds();
        const disabled = selectedIds.length === 0;
        // bulk-action-groupå†…ã®ã™ã¹ã¦ã®ãƒœã‚¿ãƒ³ã®disabledçŠ¶æ…‹ã‚’æ›´æ–°
        document.querySelectorAll('#bulk-action-group button').forEach(button => {
            button.disabled = disabled;
        });
        document.getElementById('export-json-btn').disabled = disabled; // JSONã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒœã‚¿ãƒ³ã‚‚æ›´æ–°
        document.getElementById('bulk-delete-btn').disabled = disabled; // å‰Šé™¤ãƒœã‚¿ãƒ³ã‚‚æ›´æ–°
    }

    function toggleSelectAll() {
        const allCheckboxes = document.querySelectorAll('.product-checkbox');
        const allSelected = getSelectedProductIds().length === allCheckboxes.length;
        allCheckboxes.forEach(checkbox => {
            checkbox.checked = !allSelected;
            checkbox.closest('tr').classList.toggle('selected', !allSelected);
        });
        updateBulkActionButtons();
    }

    async function bulkUpdateStatus(status) {
        const productIds = getSelectedProductIds();
        if (productIds.length === 0) return;
        if (!confirm(`${productIds.length}ä»¶ã®å•†å“ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ã€Œ${status}ã€ã«å¤‰æ›´ã—ã¾ã™ã‹ï¼Ÿ`)) return;

        try {
            const response = await fetch('/api/products/bulk-status-update', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ product_ids: productIds, status: status })
            });
            const result = await response.json();
            if (!response.ok) throw new Error(result.message);
            
            productIds.forEach(id => document.getElementById(`product-row-${id}`).remove());
            alert(result.message);
            updateBulkActionButtons();
        } catch (error) {
            alert(`ä¸€æ‹¬æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`);
        }
    }

    async function bulkDelete() {
        const productIds = getSelectedProductIds();
        if (productIds.length === 0) return;
        if (!confirm(`${productIds.length}ä»¶ã®å•†å“ã‚’æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;

        try {
            const response = await fetch('/api/inventory/bulk-delete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ product_ids: productIds })
            });
            const result = await response.json();
            if (!response.ok) throw new Error(result.message);

            productIds.forEach(id => document.getElementById(`product-row-${id}`).remove());
            alert(result.message);
            updateBulkActionButtons();
        } catch (error) {
            alert(`ä¸€æ‹¬å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`);
        }
    }

    function exportToJson() {
        const selectedIds = getSelectedProductIds();
        if (selectedIds.length === 0) {
            alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹å•†å“ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
            return;
        }

        // allProductsData ã‹ã‚‰é¸æŠã•ã‚ŒãŸå•†å“ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡º
        const selectedProducts = allProductsData.filter(product => selectedIds.includes(String(product.id)));

        if (selectedProducts.length === 0) {
            alert('é¸æŠã•ã‚ŒãŸå•†å“ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãŠè©¦ã—ãã ã•ã„ã€‚');
            return;
        }

        const jsonString = JSON.stringify(selectedProducts, null, 2);
        const blob = new Blob([jsonString], { type: 'application/json' });
        const url = URL.createObjectURL(blob);

        const a = document.createElement('a');
        a.href = url;
        // ãƒ•ã‚¡ã‚¤ãƒ«åã«ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’è¿½åŠ  (ä¾‹: error_products_20231027T103000.json)
        const timestamp = new Date().toISOString().replace(/[:.-]/g, '').slice(0, 15);
        a.download = `error_products_${timestamp}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    async function importFromJson() {
        const textarea = document.getElementById('json-import-textarea');
        const jsonText = textarea.value;
        if (!jsonText.trim()) {
            alert('JSONãƒ‡ãƒ¼ã‚¿ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
            return;
        }

        try {
            const products = JSON.parse(jsonText);
            const response = await fetch('/api/products/bulk-update-from-json', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ products: products })
            });
            const result = await response.json();
            if (!response.ok) {
                throw new Error(result.message || 'ã‚¤ãƒ³ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            }
            alert(result.message);
            location.reload(); // ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ãƒªã‚¹ãƒˆã‚’æ›´æ–°
        } catch (error) {
            alert(`ã‚¨ãƒ©ãƒ¼: ${error.message}\n\nå…¥åŠ›ã•ã‚ŒãŸJSONã®å½¢å¼ãŒæ­£ã—ã„ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚`);
        }
    }

    document.addEventListener('DOMContentLoaded', function () {
        infoModalInstance = new bootstrap.Modal(document.getElementById('infoModal'));

        fetch('/api/errors')
            .then(response => response.json())
            .then(data => {
                allProductsData = data; // å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«ä¿å­˜
                const tableBody = document.getElementById('error-table-body');
                tableBody.innerHTML = '';
                if (data.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="5" class="text-center">éå»24æ™‚é–“ä»¥å†…ã«ã‚¨ãƒ©ãƒ¼ã«ãªã£ãŸå•†å“ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</td></tr>';
                    return;
                }
                data.forEach(product => {
                    // HTMLå±æ€§ã«åŸ‹ã‚è¾¼ã‚€ãŸã‚ã«JSONæ–‡å­—åˆ—ã‚’ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã™ã‚‹
                    const formatTimestamp = (ts) => {
                        if (!ts) return '<span class="text-muted">---</span>';
                        return new Date(ts).toLocaleString('sv-SE', {
                            year: 'numeric', month: '2-digit', day: '2-digit',
                            hour: '2-digit', minute: '2-digit'
                        }).replace(' ', '&nbsp;');
                    };

                    const getStatusIcon = (product) => {
                        const hasCreationTs = !!product.created_at;
                        const hasUrlTs = !!product.post_url_updated_at;
                        const hasCaptionTs = !!product.ai_caption_created_at;
                        const hasUrlData = !!product.post_url;
                        const hasCaptionData = !!product.ai_caption;

                        // ãƒ‡ãƒ¼ã‚¿ã¨ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã®ä¸æ•´åˆãƒã‚§ãƒƒã‚¯
                        if (hasUrlTs !== hasUrlData) {
                            return `<span class="fs-5" title="ãƒ‡ãƒ¼ã‚¿ä¸æ•´åˆ: æŠ•ç¨¿URLã®æœ‰ç„¡ã¨æ—¥æ™‚ã®çŠ¶æ…‹ãŒä¸€è‡´ã—ã¾ã›ã‚“">â˜”</span>`;
                        }
                        if (hasCaptionTs !== hasCaptionData) {
                            return `<span class="fs-5" title="ãƒ‡ãƒ¼ã‚¿ä¸æ•´åˆ: AIæ–‡ç« ã®æœ‰ç„¡ã¨æ—¥æ™‚ã®çŠ¶æ…‹ãŒä¸€è‡´ã—ã¾ã›ã‚“">â˜”</span>`;
                        }
                        // ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã®é †åºãŒä¸æ­£ãªã‚±ãƒ¼ã‚¹
                        if (hasCaptionTs && !hasUrlTs) {
                            return '<span class="fs-5" title="ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—é †åºä¸æ­£: URLå–å¾—ã‚ˆã‚Šå…ˆã«AIæ–‡ç« ãŒä½œæˆã•ã‚Œã¦ã„ã¾ã™">â˜”</span>';
                        }

                        // æ­£å¸¸ç³»ã®é€²æ—ã‚’åˆ¤å®š
                        if (hasCreationTs && hasUrlTs && hasCaptionTs) {
                            return '<span class="fs-5" title="å…¨å·¥ç¨‹ã®ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ãŒã‚ã‚Šã¾ã™">â˜€ï¸</span>'; // æ™´ã‚Œ
                        } else if (hasCreationTs && hasUrlTs) {
                            return '<span class="fs-5" title="URLå–å¾—ã¾ã§å®Œäº†ã—ã¦ã„ã¾ã™">â›…ï¸</span>'; // æ›‡ã‚Šæ™´ã‚Œ
                        } else if (hasCreationTs) {
                            return '<span class="fs-5" title="ä½œæˆã®ã¿å®Œäº†ã—ã¦ã„ã¾ã™">â˜ï¸</span>'; // æ›‡ã‚Š
                        }
                        return '<span class="fs-5" title="ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ãŒä¸è¶³ã—ã¦ã„ã¾ã™">â˜”</span>'; // é›¨
                    };

                    const escapedProductJson = JSON.stringify(product).replace(/'/g, '&apos;').replace(/"/g, '&quot;');
                    const urlDataIcon = product.post_url ? `<span title="post_urlãƒ‡ãƒ¼ã‚¿æœ‰ã‚Š">âœ”ï¸</span>` : `<span title="post_urlãƒ‡ãƒ¼ã‚¿ç„¡ã—">âŒ</span>`;
                    const captionDataIcon = product.ai_caption ? `<span title="ai_captionãƒ‡ãƒ¼ã‚¿æœ‰ã‚Š">âœ”ï¸</span>` : `<span title="ai_captionãƒ‡ãƒ¼ã‚¿ç„¡ã—">âŒ</span>`;
                    
                    const productName = product.name || '';
                    const fullErrorMessage = product.error_message || '';
                    // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ”¹è¡Œãªã—ã®50æ–‡å­—ã«ä¸¸ã‚ã‚‹
                    const shortProductName = productName.length > 15 ? productName.substring(0, 15) + '...' : productName;
                    const processedErrorMessage = fullErrorMessage.replace(/\n/g, ' ');
                    const truncatedErrorMessage = processedErrorMessage.length > 50 ? processedErrorMessage.substring(0, 50) + '...' : processedErrorMessage;

                    const row = `
                        <tr id="product-row-${product.id}">
                            <td class="text-center" data-label="é¸æŠ">
                                <input class="form-check-input product-checkbox" type="checkbox" value="${product.id}">
                            </td>
                            <td data-label="ã‚µãƒ ãƒã‚¤ãƒ«" class="align-top">
                                <a href="${product.url}" target="_blank" rel="noopener noreferrer">
                                    <img src="${product.image_url || 'https://via.placeholder.com/80'}" alt="${product.name}" class="img-thumbnail" style="width: 100%; height: auto; aspect-ratio: 1 / 1; object-fit: cover;">
                                </a>
                            </td>
                            <td data-label="ID">
                                ${product.id}
                            </td>
                            <td class="text-start" data-label="å•†å“æƒ…å ±" style="min-width: 0;">
                                <div style="min-width: 0;"> <!-- ãƒ†ã‚­ã‚¹ãƒˆéƒ¨åˆ†ã®ã‚³ãƒ³ãƒ†ãƒŠ -->
                                    <div class="desktop-only"> <!-- PCç”¨ãƒ†ã‚­ã‚¹ãƒˆ -->
                                        <div class="fw-bold truncate-cell" title="${productName}">${productName}</div>
                                        <div class="text-danger small truncate-cell" title="${truncatedErrorMessage}">${truncatedErrorMessage}</div>
                                    </div>
                                    <div class="mobile-only"> <!-- ã‚¹ãƒãƒ›ç”¨ãƒ†ã‚­ã‚¹ãƒˆ -->
                                        <div class="fw-bold truncate-cell" title="${productName}">${shortProductName}</div>
                                        <div class="text-danger small truncate-cell" title="${truncatedErrorMessage}">${truncatedErrorMessage}</div>
                                    </div>
                                </div>
                                <div class="mobile-only text-nowrap"> <!-- ã‚¹ãƒãƒ›ã§ã®ã¿è¡¨ç¤ºã•ã‚Œã‚‹ã‚¢ã‚¤ã‚³ãƒ³ã‚¨ãƒªã‚¢ -->
                                    <button type="button" class="btn btn-link p-0" onclick="showInfoModal(this)" data-product='${escapedProductJson}' title="è©³ç´°æƒ…å ±ã‚’è¡¨ç¤º"><i class="bi bi-info-circle fs-5"></i></button>
                                    ${getStatusIcon(product)}
                                </div>
                            </td>
                            <td class="small text-muted" style="font-size: 0.75rem; line-height: 1.4;" data-label="å„ç¨®ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—">
                                <div><span class="badge bg-light text-dark me-1" style="width: 3.5rem;">ä½œæˆ</span> ${formatTimestamp(product.created_at)}</div>
                                <div><span class="badge bg-light text-dark me-1" style="width: 3.5rem;">URLå–å¾—</span> ${formatTimestamp(product.post_url_updated_at)} ${urlDataIcon}</div>
                                <div><span class="badge bg-light text-dark me-1" style="width: 3.5rem;">AIæ–‡ç« </span> ${formatTimestamp(product.ai_caption_created_at)} ${captionDataIcon}</div>
                            </td>
                            <td class="text-center" data-label="ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹">
                                <button type="button" class="btn btn-link p-0" 
                                    onclick="showInfoModal(this)" data-product='${escapedProductJson}'
                                    title="è©³ç´°æƒ…å ±ã‚’è¡¨ç¤º">
                                    <i class="bi bi-info-circle fs-5"></i>
                                </button>
                                ${getStatusIcon(product)}
                            </td>
                        </tr>
                    `;
                    tableBody.innerHTML += row;
                });
            });

        document.getElementById('error-table-body').addEventListener('change', function (e) {
            if (e.target.classList.contains('product-checkbox')) {
                e.target.closest('tr').classList.toggle('selected', e.target.checked);
                updateBulkActionButtons();
            }
        });

        document.getElementById('error-table-body').addEventListener('click', function (e) {
            if (e.target.closest('a, button, .form-check-input')) return;
            const row = e.target.closest('tr');
            const checkbox = row.querySelector('.product-checkbox');
            if (checkbox) checkbox.click();
        });

        // --- Screenshot Previewer ---
        const allPreviewFiles = {{ files | tojson }};
        const allFileDetails = {{ file_details | tojson }};
        const totalFiles = allPreviewFiles.length;
        let currentPreviewIndex = 0;

        if (totalFiles > 0) {
            const previewImage = document.getElementById('preview-image'); 
            const previewImageLink = document.getElementById('preview-image-link');
            const previewCounter = document.getElementById('preview-counter');
            const prevBtn = document.getElementById('prev-preview-btn');
            const nextBtn = document.getElementById('next-preview-btn');

            function updatePreviewer() {
                const fullFilename = allPreviewFiles[currentPreviewIndex];
                const details = allFileDetails[fullFilename];
                const imageUrl = `/api/screenshots/${fullFilename}`;

                // ãƒªã‚¹ãƒˆã¨åŒã˜çœç•¥è¡¨è¨˜ã‚’ç”Ÿæˆ
                let displayFilename = details.action_name;
                if (details.details) {
                    const truncatedDetails = details.details.length > 12 ? details.details.substring(0, 12) + '...' : details.details;
                    displayFilename += ` (${truncatedDetails})`;
                }

                previewImage.src = imageUrl;
                previewImageLink.href = imageUrl;
                // ãƒ•ã‚¡ã‚¤ãƒ«åã€ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã€ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚’å€‹åˆ¥ã«æ›´æ–°
                const filenameSpan = document.getElementById('preview-filename'); 
                if (filenameSpan) filenameSpan.textContent = displayFilename;
                document.getElementById('preview-timestamp').textContent = `ç™ºç”Ÿæ—¥æ™‚: ${details.timestamp}`;
                previewCounter.textContent = `${currentPreviewIndex + 1} / ${totalFiles}`;

                prevBtn.disabled = (currentPreviewIndex === 0);
                nextBtn.disabled = (currentPreviewIndex === totalFiles - 1);
            }

            prevBtn.addEventListener('click', () => {
                if (currentPreviewIndex > 0) {
                    currentPreviewIndex--;
                    updatePreviewer();
                }
            });

            nextBtn.addEventListener('click', () => {
                if (currentPreviewIndex < totalFiles - 1) {
                    currentPreviewIndex++;
                    updatePreviewer();
                }
            });

            // åˆæœŸçŠ¶æ…‹ã®ãƒœã‚¿ãƒ³ã‚’æ›´æ–°
            updatePreviewer();
        }
        // --- End Screenshot Previewer ---
    });
</script>
{% endblock %}