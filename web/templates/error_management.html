{% extends "base.html" %}

{% block title %}エラー管理 - R-Auto Control Panel{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">🚨 エラー商品管理</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2" id="bulk-action-group">
            <button type="button" class="btn btn-sm btn-outline-primary" onclick="bulkUpdateStatus('投稿準備完了')" disabled title="選択した商品を「投稿準備完了」ステータスに変更します">
                <i class="bi bi-arrow-clockwise me-1"></i>☀️ 再投稿準備
            </button>
            <button type="button" class="btn btn-sm btn-outline-primary dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown" aria-expanded="false" disabled>
                <span class="visually-hidden">Toggle Dropdown</span>
            </button>
            <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="#" onclick="event.preventDefault(); bulkUpdateStatus('投稿準備完了')">☀️ 「投稿準備完了」にする</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="#" onclick="event.preventDefault(); bulkUpdateStatus('生情報取得')">☁️ 「生情報取得」に戻す</a></li>
                <li><a class="dropdown-item" href="#" onclick="event.preventDefault(); bulkUpdateStatus('URL取得済')">⛅️ 「URL取得済」に戻す</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="#" onclick="event.preventDefault(); bulkUpdateStatus('投稿済')">🚀 「投稿済」にする</a></li>
                <li><a class="dropdown-item" href="#" onclick="event.preventDefault(); bulkUpdateStatus('対象外')">☔ 「対象外」にする</a></li>
            </ul>
            <button type="button" class="btn btn-sm btn-outline-info" id="export-json-btn" onclick="exportToJson()" disabled title="選択した商品の全データをJSON形式でダウンロードします">
                <i class="bi bi-file-earmark-code me-1"></i>JSONエクスポート
            </button>
            <button type="button" class="btn btn-sm btn-outline-secondary" id="select-all-toggle-btn" onclick="toggleSelectAll()">
                <i class="bi bi-check-square me-1"></i>すべて選択
            </button>
            <button type="button" class="btn btn-sm btn-outline-danger" id="bulk-delete-btn" onclick="bulkDelete()" disabled>
                <i class="bi bi-trash-fill me-1"></i>選択した項目を削除
            </button>
        </div>
    </div>
</div>

<div class="accordion mb-4" id="importAccordion">
    <div class="accordion-item">
        <h2 class="accordion-header" id="headingOne">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="false" aria-controls="collapseOne">
                <i class="bi bi-file-earmark-arrow-down-fill me-2"></i>JSONから商品を一括更新（クリックして展開）
            </button>
        </h2>
        <div id="collapseOne" class="accordion-collapse collapse" aria-labelledby="headingOne" data-bs-parent="#importAccordion">
            <div class="accordion-body">
                <p class="text-muted small">エクスポートしたJSONを編集し、ここに貼り付けて更新を実行します。`post_url`と`ai_caption`の有無に応じて、ステータスとタイムスタンプが自動で更新されます。</p>
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <label for="json-import-textarea" class="form-label mb-0">ここにJSONデータを貼り付けてください</label>
                        <a href="https://gemini.google.com/u/1/gem/d22f71530f97" class="btn btn-sm btn-outline-secondary" target="_blank" rel="noopener noreferrer">
                        <i class="bi bi-robot me-1"></i>投稿文ジェネレータ＋
                        </a>
                    </div>
                    <textarea class="form-control" id="json-import-textarea" rows="5" placeholder="[&#10;  {&#10;    &quot;id&quot;: 123,&#10;    &quot;post_url&quot;: &quot;https://...&quot;,&#10;    &quot;ai_caption&quot;: &quot;...&quot;&#10;  },&#10;  ...&#10;]"></textarea>
                </div>
                <button class="btn btn-primary" onclick="importFromJson()">
                    <i class="bi bi-upload me-1"></i>インポートしてDBを更新
                </button>
            </div>
        </div>
    </div>
</div>

<div class="table-responsive">
    <table class="table table-striped table-sm align-middle" style="table-layout: fixed; width: 100%;">
        <thead>
            <tr>
                <th scope="col" style="width: 5%;"></th>
                <th scope="col" style="width: 8%;">サムネイル</th>
                <th scope="col" style="width: 5%;">ID</th>
                <th scope="col" style="width: 38%;">商品情報</th>
                <th scope="col" style="width: 20%;">各種タイムスタンプ</th>
                <th scope="col" style="width: 10%;">ステータス</th>
            </tr>
        </thead>
        <tbody id="error-table-body">
            <!-- データはJavaScriptでここに挿入されます -->
        </tbody>
    </table>
</div>

<hr class="my-4">

<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">📸 エラースクリーンショット</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2" id="screenshot-bulk-action-group">
            <button type="button" class="btn btn-sm btn-outline-secondary" id="screenshot-select-all-toggle-btn" onclick="toggleSelectAllScreenshots()">
                <i class="bi bi-check-square me-1"></i>すべて選択
            </button>
            <button type="button" class="btn btn-sm btn-outline-danger" id="screenshot-bulk-delete-btn" onclick="bulkDeleteScreenshots()" disabled>
                <i class="bi bi-trash-fill me-1"></i>選択した項目を削除
            </button>
        </div>
    </div>
</div>
<p>Playwrightタスクの実行中にエラーが発生した際に自動で保存されたスクリーンショットです。新しいものが一番上に表示されます。</p>

{% if files %}
    <div class="list-group" id="screenshot-list">
    {% for file in files %}
        <div class="list-group-item" id="screenshot-{{ loop.index }}">
            <div class="d-flex align-items-center">
                <input class="form-check-input me-3 screenshot-checkbox" type="checkbox" value="{{ file }}" onclick="updateScreenshotBulkActionButtons()">
                <a href="/api/screenshots/{{ file }}" class="text-decoration-none text-dark flex-grow-1" target="_blank">
                    <div>
                        <i class="bi bi-image me-2"></i>
                        <strong>{{ file_details[file].action_name }}</strong>
                        <span class="badge bg-secondary rounded-pill ms-2 d-none d-md-inline-block">{{ file }}</span>
                        <br class="d-none d-md-block">
                        <small class="text-muted">エラー発生日時: {{ file_details[file].error_timestamp }}</small>
                    </div>
                </a>
                <button class="btn btn-sm btn-outline-danger ms-3" onclick="deleteScreenshot(this, '{{ file }}')" title="このスクリーンショットを削除">
                    <i class="bi bi-trash"></i> <span class="d-none d-md-inline">削除</span>
                </button>
            </div>
        </div>
    {% endfor %}
    </div>
{% else %}
    <div class="alert alert-info" role="alert">
        現在、保存されているスクリーンショットはありません。
    </div>
{% endif %}

<!-- 商品情報詳細モーダル -->
<div class="modal fade" id="infoModal" tabindex="-1" aria-labelledby="infoModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="infoModalLabel">エラー詳細</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <h5 class="text-danger"><i class="bi bi-exclamation-triangle-fill me-2"></i>エラーメッセージ</h5>
        <pre id="modal-error-message" class="bg-light p-3 rounded mb-3" style="white-space: pre-wrap; word-break: break-all; font-size: 0.9rem;"></pre>
        
        <h5 class="mt-4"><i class="bi bi-clock-history me-2"></i>タイムスタンプ</h5>
        <ul class="list-group list-group-flush mb-3" id="modal-timestamps">
            <!-- JSでここにタイムスタンプが挿入されます -->
        </ul>

        <h5 class="mt-4">
            <a class="text-decoration-none text-dark" data-bs-toggle="collapse" href="#collapseFullDataError" role="button" aria-expanded="false" aria-controls="collapseFullDataError">
                <i class="bi bi-database me-2"></i>全データ <i class="bi bi-chevron-down small"></i>
            </a>
        </h5>
        <div class="collapse" id="collapseFullDataError">
            <pre><code id="modal-full-data" class="bg-light p-3 rounded" style="font-size: 0.8rem; display: block; min-height: 100px;"></code></pre>
            <button class="btn btn-sm btn-outline-secondary mt-2" onclick="copyFullData('modal-full-data')">
                <i class="bi bi-clipboard me-1"></i>クリップボードにコピー
            </button>
        </div>

      </div>
      <div class="modal-footer">
        <a href="#" id="modal-post-link" class="btn btn-primary" target="_blank" rel="noopener noreferrer" style="display: none;"><i class="bi bi-box-arrow-up-right me-1"></i>投稿ページを開く</a>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block styles %}
<style>
    .truncate-cell {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .truncate-2-lines {
        display: -webkit-box;
        -webkit-box-orient: vertical;
        -webkit-line-clamp: 2;
        overflow: hidden;
        text-overflow: ellipsis;
        line-height: 1.4; /* 1行の高さを指定 */
        height: 2.8em;    /* 2行分の高さを確保 (line-height * 2) */
    }
    tbody tr {
        cursor: pointer;
    }
    tr.selected .img-thumbnail {
        border: 3px solid #0d6efd;
        padding: 1px;
    }
    .table .form-check-input {
        width: 1.25em;
        height: 1.25em;
        vertical-align: middle;
    }
    /* スマートフォンなどの小さい画面向けのスタイル */
    @media (max-width: 767.98px) {
        thead {
            display: none; /* ヘッダーを非表示 */
        }
        tr {
            display: grid;
            grid-template-columns: 50px 1fr; /* サムネイル | 情報 */
            grid-template-areas:
                "thumb info";
            gap: 0.5rem;
            border: 1px solid #dee2e6;
            border-top: none; /* 上の境界線を消す */
            border-radius: .25rem;
            margin-bottom: 0; /* 下のマージンをなくす */
            padding: 0.75rem;
            position: relative;
        }
        td {
            display: block;
            text-align: left !important; /* 全てのセルを左寄せに */
            width: 100% !important; /* 幅を100%に */
            border: none;
            padding: 0;
        }
        /* 各セルにラベルを追加 */
        td:before {
            content: attr(data-label);
            font-weight: bold;
            display: block;
            color: #6c757d;
        }
        /* grid-areaで配置 */
        td[data-label="サムネイル"] { grid-area: thumb; }
        td[data-label="商品情報"] {
            grid-area: info; 
            display: flex; /* Flexboxに変更 */
            justify-content: space-between; /* 両端揃え */
            align-items: center; /* 中央揃え */
            gap: 0.5rem; /* 要素間の隙間 */
            min-width: 0; /* flexアイテムの縮小を許可 */
        }

        /* スマホでは非表示にする列 */
        td[data-label="各種タイムスタンプ"],
        td[data-label="ステータス"] {
            display: none;
        }
        td[data-label="ID"] {
            position: absolute;
            top: 0.25rem;
            left: 0.25rem;
            background-color: transparent;
            color: #000;
            padding: 0.1rem 0.4rem;
            border-radius: .25rem;
            font-size: 0.7rem;
            line-height: 1.2;
            z-index: 10;
        }

        /* ラベルが不要なセル */
        td[data-label="サムネイル"]:before,
        td[data-label="商品情報"]:before,
        td[data-label="ID"]:before {
            content: "";
            display: none;
        }
        /* 最初の行だけ上の境界線を表示 */
        tr:first-child {
            border-top: 1px solid #dee2e6;
        }

        /* PC表示を非表示に */
        .desktop-only {
            display: none;
        }
    }
    /* PC幅ではモバイル表示を非表示に */
    @media (min-width: 767.99px) {
        .mobile-only {
            display: none;
        }
    }
    /* チェックボックス列を常に非表示にする */
    .table th:first-child,
    .table td:first-child {
        display: none;
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    function getSelectedScreenshots() {
        return Array.from(document.querySelectorAll('.screenshot-checkbox:checked')).map(cb => cb.value);
    }

    function updateScreenshotBulkActionButtons() {
        const selectedFiles = getSelectedScreenshots();
        const disabled = selectedFiles.length === 0;
        document.querySelectorAll('#screenshot-bulk-action-group button').forEach(button => {
            // 「すべて選択」ボタンは常に有効
            if (button.id !== 'screenshot-select-all-toggle-btn') {
                button.disabled = disabled;
            }
        });
    }

    function toggleSelectAllScreenshots() {
        const allCheckboxes = document.querySelectorAll('.screenshot-checkbox');
        const isAllSelected = getSelectedScreenshots().length === allCheckboxes.length;
        allCheckboxes.forEach(checkbox => {
            checkbox.checked = !isAllSelected;
        });
        updateScreenshotBulkActionButtons();
    }

    async function bulkDeleteScreenshots() {
        const filesToDelete = getSelectedScreenshots();
        if (filesToDelete.length === 0) {
            alert('削除するスクリーンショットを選択してください。');
            return;
        }
        if (!confirm(`${filesToDelete.length}件のスクリーンショットを本当に削除しますか？`)) {
            return;
        }

        // Promise.allSettled を使って、すべての削除リクエストを並行して実行
        const results = await Promise.allSettled(filesToDelete.map(filename => 
            fetch(`/api/screenshots/${filename}`, { method: 'DELETE' })
        ));

        let successCount = 0;
        let failedCount = 0;

        results.forEach((result, index) => {
            const filename = filesToDelete[index];
            if (result.status === 'fulfilled' && result.value.ok) {
                // 成功したらUIから要素を削除
                document.querySelector(`.screenshot-checkbox[value="${filename}"]`).closest('.list-group-item').remove();
                successCount++;
            } else {
                console.error(`Failed to delete ${filename}:`, result.reason || result.value.statusText);
                failedCount++;
            }
        });

        alert(`${successCount}件の削除に成功しました。\n${failedCount > 0 ? `${failedCount}件の削除に失敗しました。詳細はコンソールを確認してください。` : ''}`);
        updateScreenshotBulkActionButtons();
    }

    async function deleteScreenshot(buttonElement, filename) {
        // ユーザーに確認を求める
        if (!confirm(`本当にスクリーンショット「${filename}」を削除しますか？\nこの操作は元に戻せません。`)) {
            return;
        }

        try {
            const response = await fetch(`/api/screenshots/${filename}`, {
                method: 'DELETE',
            });

            const result = await response.json();
            if (!response.ok) {
                throw new Error(result.detail || '削除に失敗しました。');
            }

            // 成功したら、リストからその項目を削除
            buttonElement.closest('.list-group-item').remove();
        } catch (error) {
            alert(`エラー: ${error.message}`);
        }
    }

    let infoModalInstance = null;
    let allProductsData = []; // 全商品データを保持する配列

    function copyFullData(elementId) {
        const dataText = document.getElementById(elementId).textContent;
        navigator.clipboard.writeText(dataText).then(() => {
            // トースト通知を表示する (base.htmlにshowToast関数があると仮定)
            if (typeof showToast === 'function') {
                showToast('コピー完了', '全データがクリップボードにコピーされました。');
            } else {
                alert('クリップボードにコピーしました。');
            }
        }).catch(err => {
            console.error('クリップボードへのコピーに失敗しました: ', err);
        });
    }

    function showInfoModal(element) {
        event.stopPropagation();

        // data-product属性からJSON文字列を取得し、パースする
        const product = JSON.parse(element.dataset.product);

        // エラーメッセージを専用エリアに表示
        const errorMessageElem = document.getElementById('modal-error-message');
        errorMessageElem.textContent = product.error_message || 'エラーメッセージはありません。';

        // タイムスタンプ表示エリアをクリアし、再描画
        const timestampsList = document.getElementById('modal-timestamps');
        timestampsList.innerHTML = '';

        const formatModalTimestamp = (ts) => {
            if (!ts) return '<span class="text-muted">---</span>';
            return new Date(ts).toLocaleString('ja-JP', { timeZone: 'Asia/Tokyo' });
        };

        const urlDataIcon = product.post_url ? `✔️` : `❌`;
        const captionDataIcon = product.ai_caption ? `✔️` : `❌`;

        const timestampItems = {
            '作成日時': product.created_at,
            '投稿URL取得日時': { ts: product.post_url_updated_at, icon: urlDataIcon },
            'AI文章作成日時': { ts: product.ai_caption_created_at, icon: captionDataIcon },
            '投稿完了日時': product.posted_at
        };

        for (const [label, value] of Object.entries(timestampItems)) {
            const listItem = document.createElement('li');
            listItem.className = 'list-group-item d-flex justify-content-between align-items-center';
            if (typeof value === 'object' && value !== null && 'ts' in value) {
                listItem.innerHTML = `${label}<span class="badge bg-light text-dark">${formatModalTimestamp(value.ts)} <span class="ms-1">${value.icon}</span></span>`;
            } else {
                listItem.innerHTML = `${label}<span class="badge bg-light text-dark">${formatModalTimestamp(value)}</span>`;
            }
            timestampsList.appendChild(listItem);
        }

        // 全データを整形して表示（エラーメッセージが長い場合があるので、JSONからは除外しても良い）
        document.getElementById('modal-full-data').textContent = JSON.stringify(product, null, 2);

        const postLink = document.getElementById('modal-post-link');
        if (product.post_url) {
            postLink.href = product.post_url;
            postLink.style.display = 'inline-block';
        } else {
            postLink.style.display = 'none';
        }

        infoModalInstance.show();
    }

    function getSelectedProductIds() {
        return Array.from(document.querySelectorAll('.product-checkbox:checked')).map(cb => cb.value);
    }

    function updateBulkActionButtons() {
        const selectedIds = getSelectedProductIds();
        const disabled = selectedIds.length === 0;
        // bulk-action-group内のすべてのボタンのdisabled状態を更新
        document.querySelectorAll('#bulk-action-group button').forEach(button => {
            button.disabled = disabled;
        });
        document.getElementById('export-json-btn').disabled = disabled; // JSONエクスポートボタンも更新
        document.getElementById('bulk-delete-btn').disabled = disabled; // 削除ボタンも更新
    }

    function toggleSelectAll() {
        const allCheckboxes = document.querySelectorAll('.product-checkbox');
        const allSelected = getSelectedProductIds().length === allCheckboxes.length;
        allCheckboxes.forEach(checkbox => {
            checkbox.checked = !allSelected;
            checkbox.closest('tr').classList.toggle('selected', !allSelected);
        });
        updateBulkActionButtons();
    }

    async function bulkUpdateStatus(status) {
        const productIds = getSelectedProductIds();
        if (productIds.length === 0) return;
        if (!confirm(`${productIds.length}件の商品のステータスを「${status}」に変更しますか？`)) return;

        try {
            const response = await fetch('/api/products/bulk-status-update', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ product_ids: productIds, status: status })
            });
            const result = await response.json();
            if (!response.ok) throw new Error(result.message);
            
            productIds.forEach(id => document.getElementById(`product-row-${id}`).remove());
            alert(result.message);
            updateBulkActionButtons();
        } catch (error) {
            alert(`一括更新に失敗しました: ${error.message}`);
        }
    }

    async function bulkDelete() {
        const productIds = getSelectedProductIds();
        if (productIds.length === 0) return;
        if (!confirm(`${productIds.length}件の商品を本当に削除しますか？`)) return;

        try {
            const response = await fetch('/api/inventory/bulk-delete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ product_ids: productIds })
            });
            const result = await response.json();
            if (!response.ok) throw new Error(result.message);

            productIds.forEach(id => document.getElementById(`product-row-${id}`).remove());
            alert(result.message);
            updateBulkActionButtons();
        } catch (error) {
            alert(`一括削除に失敗しました: ${error.message}`);
        }
    }

    function exportToJson() {
        const selectedIds = getSelectedProductIds();
        if (selectedIds.length === 0) {
            alert('エクスポートする商品を選択してください。');
            return;
        }

        // allProductsData から選択された商品データを抽出
        const selectedProducts = allProductsData.filter(product => selectedIds.includes(String(product.id)));

        if (selectedProducts.length === 0) {
            alert('選択された商品データが見つかりませんでした。ページを再読み込みしてお試しください。');
            return;
        }

        const jsonString = JSON.stringify(selectedProducts, null, 2);
        const blob = new Blob([jsonString], { type: 'application/json' });
        const url = URL.createObjectURL(blob);

        const a = document.createElement('a');
        a.href = url;
        // ファイル名にタイムスタンプを追加 (例: error_products_20231027T103000.json)
        const timestamp = new Date().toISOString().replace(/[:.-]/g, '').slice(0, 15);
        a.download = `error_products_${timestamp}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    async function importFromJson() {
        const textarea = document.getElementById('json-import-textarea');
        const jsonText = textarea.value;
        if (!jsonText.trim()) {
            alert('JSONデータを入力してください。');
            return;
        }

        try {
            const products = JSON.parse(jsonText);
            const response = await fetch('/api/products/bulk-update-from-json', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ products: products })
            });
            const result = await response.json();
            if (!response.ok) {
                throw new Error(result.message || 'インポートに失敗しました。');
            }
            alert(result.message);
            location.reload(); // ページをリロードしてリストを更新
        } catch (error) {
            alert(`エラー: ${error.message}\n\n入力されたJSONの形式が正しいか確認してください。`);
        }
    }

    document.addEventListener('DOMContentLoaded', function () {
        infoModalInstance = new bootstrap.Modal(document.getElementById('infoModal'));

        fetch('/api/errors')
            .then(response => response.json())
            .then(data => {
                allProductsData = data; // 取得したデータをグローバル変数に保存
                const tableBody = document.getElementById('error-table-body');
                tableBody.innerHTML = '';
                if (data.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="5" class="text-center">過去24時間以内にエラーになった商品はありません。</td></tr>';
                    return;
                }
                data.forEach(product => {
                    // HTML属性に埋め込むためにJSON文字列をエスケープする
                    const formatTimestamp = (ts) => {
                        if (!ts) return '<span class="text-muted">---</span>';
                        return new Date(ts).toLocaleString('sv-SE', {
                            year: 'numeric', month: '2-digit', day: '2-digit',
                            hour: '2-digit', minute: '2-digit'
                        }).replace(' ', '&nbsp;');
                    };

                    const getStatusIcon = (product) => {
                        const hasCreationTs = !!product.created_at;
                        const hasUrlTs = !!product.post_url_updated_at;
                        const hasCaptionTs = !!product.ai_caption_created_at;
                        const hasUrlData = !!product.post_url;
                        const hasCaptionData = !!product.ai_caption;

                        // データとタイムスタンプの不整合チェック
                        if (hasUrlTs !== hasUrlData) {
                            return `<span class="fs-5" title="データ不整合: 投稿URLの有無と日時の状態が一致しません">☔</span>`;
                        }
                        if (hasCaptionTs !== hasCaptionData) {
                            return `<span class="fs-5" title="データ不整合: AI文章の有無と日時の状態が一致しません">☔</span>`;
                        }
                        // タイムスタンプの順序が不正なケース
                        if (hasCaptionTs && !hasUrlTs) {
                            return '<span class="fs-5" title="タイムスタンプ順序不正: URL取得より先にAI文章が作成されています">☔</span>';
                        }

                        // 正常系の進捗を判定
                        if (hasCreationTs && hasUrlTs && hasCaptionTs) {
                            return '<span class="fs-5" title="全工程のタイムスタンプがあります">☀️</span>'; // 晴れ
                        } else if (hasCreationTs && hasUrlTs) {
                            return '<span class="fs-5" title="URL取得まで完了しています">⛅️</span>'; // 曇り晴れ
                        } else if (hasCreationTs) {
                            return '<span class="fs-5" title="作成のみ完了しています">☁️</span>'; // 曇り
                        }
                        return '<span class="fs-5" title="タイムスタンプが不足しています">☔</span>'; // 雨
                    };

                    const escapedProductJson = JSON.stringify(product).replace(/'/g, '&apos;').replace(/"/g, '&quot;');
                    const urlDataIcon = product.post_url ? `<span title="post_urlデータ有り">✔️</span>` : `<span title="post_urlデータ無し">❌</span>`;
                    const captionDataIcon = product.ai_caption ? `<span title="ai_captionデータ有り">✔️</span>` : `<span title="ai_captionデータ無し">❌</span>`;
                    
                    const productName = product.name || '';
                    const fullErrorMessage = product.error_message || '';
                    // エラーメッセージを改行なしの50文字に丸める
                    const shortProductName = productName.length > 15 ? productName.substring(0, 15) + '...' : productName;
                    const processedErrorMessage = fullErrorMessage.replace(/\n/g, ' ');
                    const truncatedErrorMessage = processedErrorMessage.length > 50 ? processedErrorMessage.substring(0, 50) + '...' : processedErrorMessage;

                    const row = `
                        <tr id="product-row-${product.id}">
                            <td class="text-center" data-label="選択">
                                <input class="form-check-input product-checkbox" type="checkbox" value="${product.id}">
                            </td>
                            <td data-label="サムネイル" class="align-top">
                                <a href="${product.url}" target="_blank" rel="noopener noreferrer">
                                    <img src="${product.image_url || 'https://via.placeholder.com/80'}" alt="${product.name}" class="img-thumbnail" style="width: 100%; height: auto; aspect-ratio: 1 / 1; object-fit: cover;">
                                </a>
                            </td>
                            <td data-label="ID">
                                ${product.id}
                            </td>
                            <td class="text-start" data-label="商品情報" style="min-width: 0;">
                                <div style="min-width: 0;"> <!-- テキスト部分のコンテナ -->
                                    <div class="desktop-only"> <!-- PC用テキスト -->
                                        <div class="fw-bold truncate-cell" title="${productName}">${productName}</div>
                                        <div class="text-danger small truncate-cell" title="${truncatedErrorMessage}">${truncatedErrorMessage}</div>
                                    </div>
                                    <div class="mobile-only"> <!-- スマホ用テキスト -->
                                        <div class="fw-bold truncate-cell" title="${productName}">${shortProductName}</div>
                                        <div class="text-danger small truncate-cell" title="${truncatedErrorMessage}">${truncatedErrorMessage}</div>
                                    </div>
                                </div>
                                <div class="mobile-only text-nowrap"> <!-- スマホでのみ表示されるアイコンエリア -->
                                    <button type="button" class="btn btn-link p-0" onclick="showInfoModal(this)" data-product='${escapedProductJson}' title="詳細情報を表示"><i class="bi bi-info-circle fs-5"></i></button>
                                    ${getStatusIcon(product)}
                                </div>
                            </td>
                            <td class="small text-muted" style="font-size: 0.75rem; line-height: 1.4;" data-label="各種タイムスタンプ">
                                <div><span class="badge bg-light text-dark me-1" style="width: 3.5rem;">作成</span> ${formatTimestamp(product.created_at)}</div>
                                <div><span class="badge bg-light text-dark me-1" style="width: 3.5rem;">URL取得</span> ${formatTimestamp(product.post_url_updated_at)} ${urlDataIcon}</div>
                                <div><span class="badge bg-light text-dark me-1" style="width: 3.5rem;">AI文章</span> ${formatTimestamp(product.ai_caption_created_at)} ${captionDataIcon}</div>
                            </td>
                            <td class="text-center" data-label="ステータス">
                                <button type="button" class="btn btn-link p-0" 
                                    onclick="showInfoModal(this)" data-product='${escapedProductJson}'
                                    title="詳細情報を表示">
                                    <i class="bi bi-info-circle fs-5"></i>
                                </button>
                                ${getStatusIcon(product)}
                            </td>
                        </tr>
                    `;
                    tableBody.innerHTML += row;
                });
            });

        document.getElementById('error-table-body').addEventListener('change', function (e) {
            if (e.target.classList.contains('product-checkbox')) {
                e.target.closest('tr').classList.toggle('selected', e.target.checked);
                updateBulkActionButtons();
            }
        });

        document.getElementById('error-table-body').addEventListener('click', function (e) {
            if (e.target.closest('a, button, .form-check-input')) return;
            const row = e.target.closest('tr');
            const checkbox = row.querySelector('.product-checkbox');
            if (checkbox) checkbox.click();
        });
    });
</script>
{% endblock %}