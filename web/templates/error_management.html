{% extends "base.html" %}

{% block title %}ã‚¨ãƒ©ãƒ¼ç®¡ç† - R-Auto Control Panel{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">ğŸš¨ ã‚¨ãƒ©ãƒ¼å•†å“ç®¡ç†</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2" id="bulk-action-group">
            <button type="button" class="btn btn-sm btn-outline-primary" onclick="bulkUpdateStatus('æŠ•ç¨¿æº–å‚™å®Œäº†')" disabled>
                <i class="bi bi-arrow-clockwise me-1"></i>é¸æŠã‚’å†æŠ•ç¨¿æº–å‚™
            </button>
            <button type="button" class="btn btn-sm btn-outline-primary dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown" aria-expanded="false" disabled>
                <span class="visually-hidden">Toggle Dropdown</span>
            </button>
            <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="#" onclick="event.preventDefault(); bulkUpdateStatus('æŠ•ç¨¿æº–å‚™å®Œäº†')">é¸æŠã‚’ã€ŒæŠ•ç¨¿æº–å‚™å®Œäº†ã€ã«ã™ã‚‹</a></li>
                <li><a class="dropdown-item" href="#" onclick="event.preventDefault(); bulkUpdateStatus('å¯¾è±¡å¤–')">é¸æŠã‚’ã€Œå¯¾è±¡å¤–ã€ã«ã™ã‚‹</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="#" onclick="event.preventDefault(); bulkUpdateStatus('ç”Ÿæƒ…å ±å–å¾—')">é¸æŠã‚’ã€Œç”Ÿæƒ…å ±å–å¾—ã€ã«æˆ»ã™</a></li>
                <li><a class="dropdown-item" href="#" onclick="event.preventDefault(); bulkUpdateStatus('URLå–å¾—æ¸ˆ')">é¸æŠã‚’ã€ŒURLå–å¾—æ¸ˆã€ã«æˆ»ã™</a></li>
                <li><a class="dropdown-item" href="#" onclick="event.preventDefault(); bulkUpdateStatus('æŠ•ç¨¿æ¸ˆ')">é¸æŠã‚’ã€ŒæŠ•ç¨¿æ¸ˆã€ã«ã™ã‚‹</a></li>
            </ul>
            <button type="button" class="btn btn-sm btn-outline-secondary" id="select-all-toggle-btn" onclick="toggleSelectAll()">
                <i class="bi bi-check-square me-1"></i>ã™ã¹ã¦é¸æŠ
            </button>
            <button type="button" class="btn btn-sm btn-outline-danger" id="bulk-delete-btn" onclick="bulkDelete()" disabled>
                <i class="bi bi-trash-fill me-1"></i>é¸æŠã—ãŸé …ç›®ã‚’å‰Šé™¤
            </button>
        </div>
    </div>
</div>

<div class="table-responsive">
    <table class="table table-striped table-sm align-middle" style="table-layout: fixed; width: 100%;">
        <thead>
            <tr>
                <th scope="col" style="width: 5%;"></th>
                <th scope="col" style="width: 8%;">ã‚µãƒ ãƒã‚¤ãƒ«</th>
                <th scope="col" style="width: 5%;">ID</th>
                <th scope="col" style="width: 57%;">å•†å“æƒ…å ±</th>
                <th scope="col" style="width: 15%;">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
            </tr>
        </thead>
        <tbody id="error-table-body">
            <!-- ãƒ‡ãƒ¼ã‚¿ã¯JavaScriptã§ã“ã“ã«æŒ¿å…¥ã•ã‚Œã¾ã™ -->
        </tbody>
    </table>
</div>

<hr class="my-4">

<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">ğŸ“¸ Playwrightã‚¿ã‚¹ã‚¯ ã‚¨ãƒ©ãƒ¼ç”»é¢ç¢ºèª</h1>
</div>
<p>Playwrightã‚¿ã‚¹ã‚¯ã®å®Ÿè¡Œä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸéš›ã«è‡ªå‹•ã§ä¿å­˜ã•ã‚ŒãŸã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã§ã™ã€‚æ–°ã—ã„ã‚‚ã®ãŒä¸€ç•ªä¸Šã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>

{% if files %}
    <div class="list-group">
    {% for file in files %}
        <div class="list-group-item d-flex justify-content-between align-items-center" id="screenshot-{{ loop.index }}">
            <a href="/api/screenshots/{{ file }}" class="text-decoration-none text-dark flex-grow-1" target="_blank">
                <div>
                    <i class="bi bi-image me-2"></i>
                    <strong>{{ file_details[file].action_name }}</strong>
                    <br>
                    <small class="text-muted">ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ—¥æ™‚: {{ file_details[file].error_timestamp }}</small>
                </div>
            </a>
            <div class="d-flex align-items-center">
                <span class="badge bg-secondary rounded-pill me-3">{{ file }}</span>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteScreenshot(this, '{{ file }}')" title="ã“ã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’å‰Šé™¤">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
        </div>
    {% endfor %}
    </div>
{% else %}
    <div class="alert alert-info" role="alert">
        ç¾åœ¨ã€ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
    </div>
{% endif %}

<!-- å•†å“æƒ…å ±è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="infoModal" tabindex="-1" aria-labelledby="infoModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="infoModalLabel">ã‚¨ãƒ©ãƒ¼è©³ç´°</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <!-- å…¨ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹é …ç›®è¡¨ç¤ºç”¨ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ -->
        <div class="accordion" id="accordionFullData">
            <div class="accordion-item">
                <h2 class="accordion-header" id="headingOne">
                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                    å…¨ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹é …ç›®
                </button>
                </h2>
                <div id="collapseOne" class="accordion-collapse collapse show" aria-labelledby="headingOne" data-bs-parent="#accordionFullData">
                <div class="accordion-body">
                    <pre><code id="modal-full-data" style="font-size: 0.8rem;"></code></pre>
                </div>
                </div>
            </div>
        </div>
      </div>
      <div class="modal-footer">
        <a href="#" id="modal-post-link" class="btn btn-primary" target="_blank" rel="noopener noreferrer" style="display: none;"><i class="bi bi-box-arrow-up-right me-1"></i>æŠ•ç¨¿ãƒšãƒ¼ã‚¸ã‚’é–‹ã</a>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block styles %}
<style>
    .truncate-cell {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    tbody tr {
        cursor: pointer;
    }
    tr.selected .img-thumbnail {
        border: 3px solid #0d6efd;
        padding: 1px;
    }
    .table .form-check-input {
        width: 1.25em;
        height: 1.25em;
        vertical-align: middle;
    }
    /* ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ãªã©ã®å°ã•ã„ç”»é¢å‘ã‘ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    @media (max-width: 767.98px) {
        /* ç¸¦é•·ç”»é¢ã§ã¯ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’éè¡¨ç¤º */
        @media (orientation: portrait) {
            thead {
                display: none;
            }
            /* å„åˆ—ã®å¹…ã‚’èª¿æ•´ */
            td:nth-child(2) { width: 15%; } /* ã‚µãƒ ãƒã‚¤ãƒ« */
            td:nth-child(3) { width: 10%; } /* ID */
            td:nth-child(4) { width: 75%; } /* å•†å“æƒ…å ± */
        }
    }
    /* ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹åˆ—ã‚’å¸¸ã«éè¡¨ç¤ºã«ã™ã‚‹ */
    .table th:first-child,
    .table td:first-child {
        display: none;
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    async function deleteScreenshot(buttonElement, filename) {
        if (!confirm(`æœ¬å½“ã«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã€Œ${filename}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚`)) {
            return;
        }

        try {
            const response = await fetch(`/api/screenshots/${filename}`, {
                method: 'DELETE',
            });

            const result = await response.json();
            if (!response.ok) {
                throw new Error(result.detail || 'å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            }

            // æˆåŠŸã—ãŸã‚‰ã€ãƒªã‚¹ãƒˆã‹ã‚‰ãã®é …ç›®ã‚’å‰Šé™¤
            buttonElement.closest('.list-group-item').remove();
        } catch (error) {
            alert(`ã‚¨ãƒ©ãƒ¼: ${error.message}`);
        }
    }

    let infoModalInstance = null;

    function showInfoModal(element) {
        event.stopPropagation();

        // data-productå±æ€§ã‹ã‚‰JSONæ–‡å­—åˆ—ã‚’å–å¾—ã—ã€ãƒ‘ãƒ¼ã‚¹ã™ã‚‹
        const product = JSON.parse(element.dataset.product);

        // å…¨ãƒ‡ãƒ¼ã‚¿ã‚’æ•´å½¢ã—ã¦ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³å†…ã«è¡¨ç¤º
        document.getElementById('modal-full-data').textContent = JSON.stringify(product, null, 2);

        const postLink = document.getElementById('modal-post-link');
        if (product.post_url) {
            postLink.href = product.post_url;
            postLink.style.display = 'inline-block';
        } else {
            postLink.style.display = 'none';
        }

        infoModalInstance.show();
    }

    function getSelectedProductIds() {
        return Array.from(document.querySelectorAll('.product-checkbox:checked')).map(cb => cb.value);
    }

    function updateBulkActionButtons() {
        const selectedIds = getSelectedProductIds();
        const disabled = selectedIds.length === 0;
        // bulk-action-groupå†…ã®ã™ã¹ã¦ã®ãƒœã‚¿ãƒ³ã®disabledçŠ¶æ…‹ã‚’æ›´æ–°
        document.querySelectorAll('#bulk-action-group button').forEach(button => {
            button.disabled = disabled;
        });
        document.getElementById('bulk-delete-btn').disabled = disabled; // å‰Šé™¤ãƒœã‚¿ãƒ³ã‚‚æ›´æ–°
    }

    function toggleSelectAll() {
        const allCheckboxes = document.querySelectorAll('.product-checkbox');
        const allSelected = getSelectedProductIds().length === allCheckboxes.length;
        allCheckboxes.forEach(checkbox => {
            checkbox.checked = !allSelected;
            checkbox.closest('tr').classList.toggle('selected', !allSelected);
        });
        updateBulkActionButtons();
    }

    async function bulkUpdateStatus(status) {
        const productIds = getSelectedProductIds();
        if (productIds.length === 0) return;
        if (!confirm(`${productIds.length}ä»¶ã®å•†å“ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ã€Œ${status}ã€ã«å¤‰æ›´ã—ã¾ã™ã‹ï¼Ÿ`)) return;

        try {
            const response = await fetch('/api/products/bulk-status-update', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ product_ids: productIds, status: status })
            });
            const result = await response.json();
            if (!response.ok) throw new Error(result.message);
            
            productIds.forEach(id => document.getElementById(`product-row-${id}`).remove());
            alert(result.message);
            updateBulkActionButtons();
        } catch (error) {
            alert(`ä¸€æ‹¬æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`);
        }
    }

    async function bulkDelete() {
        const productIds = getSelectedProductIds();
        if (productIds.length === 0) return;
        if (!confirm(`${productIds.length}ä»¶ã®å•†å“ã‚’æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;

        try {
            const response = await fetch('/api/inventory/bulk-delete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ product_ids: productIds })
            });
            const result = await response.json();
            if (!response.ok) throw new Error(result.message);

            productIds.forEach(id => document.getElementById(`product-row-${id}`).remove());
            alert(result.message);
            updateBulkActionButtons();
        } catch (error) {
            alert(`ä¸€æ‹¬å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`);
        }
    }

    document.addEventListener('DOMContentLoaded', function () {
        infoModalInstance = new bootstrap.Modal(document.getElementById('infoModal'));

        fetch('/api/errors')
            .then(response => response.json())
            .then(data => {
                const tableBody = document.getElementById('error-table-body');
                tableBody.innerHTML = '';
                if (data.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="5" class="text-center">éå»24æ™‚é–“ä»¥å†…ã«ã‚¨ãƒ©ãƒ¼ã«ãªã£ãŸå•†å“ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</td></tr>';
                    return;
                }
                data.forEach(product => {
                    // HTMLå±æ€§ã«åŸ‹ã‚è¾¼ã‚€ãŸã‚ã«JSONæ–‡å­—åˆ—ã‚’ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã™ã‚‹
                    const escapedProductJson = JSON.stringify(product).replace(/'/g, '&apos;').replace(/"/g, '&quot;');
                    const row = `
                        <tr id="product-row-${product.id}">
                            <td class="text-center">
                                <input class="form-check-input product-checkbox" type="checkbox" value="${product.id}">
                            </td>
                            <td>
                                <a href="${product.url}" target="_blank" rel="noopener noreferrer">
                                    <img src="${product.image_url || 'https://via.placeholder.com/80'}" alt="${product.name}" class="img-thumbnail" style="width: 100%; height: auto; aspect-ratio: 1 / 1; object-fit: cover;">
                                </a>
                            </td>
                            <td class="text-center">
                                ${product.id}
                            </td>
                            <td class="text-start">
                                <div class="fw-bold truncate-cell" title="${product.name || ''}">${product.name || ''}</div>
                                <div class="text-danger small truncate-cell" title="${product.error_message || ''}">${product.error_message || ''}</div>
                            </td>
                            <td class="text-center">
                                <button type="button" class="btn btn-link p-0" 
                                    onclick="showInfoModal(this)" data-product='${escapedProductJson}'
                                    title="ã‚¨ãƒ©ãƒ¼è©³ç´°ã‚’è¡¨ç¤º">
                                    <span class="fs-5">ğŸš¨</span>
                                </button>
                            </td>
                        </tr>
                    `;
                    tableBody.innerHTML += row;
                });
            });

        document.getElementById('error-table-body').addEventListener('change', function (e) {
            if (e.target.classList.contains('product-checkbox')) {
                e.target.closest('tr').classList.toggle('selected', e.target.checked);
                updateBulkActionButtons();
            }
        });

        document.getElementById('error-table-body').addEventListener('click', function (e) {
            if (e.target.closest('a, button, .form-check-input')) return;
            const row = e.target.closest('tr');
            const checkbox = row.querySelector('.product-checkbox');
            if (checkbox) checkbox.click();
        });
    });
</script>
{% endblock %}