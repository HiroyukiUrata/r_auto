{% extends "base.html" %}

{% block title %}投稿済商品 - R-Auto Control Panel{% endblock %}

{% block styles %}
<style>
    .truncate-cell {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .product-thumbnail {
        width: 50px;
        height: 50px;
        aspect-ratio: 1 / 1; /* 縦横比を1:1に固定 */
        object-fit: contain; /* 画像全体が収まるように表示 */
        background-color: #f8f9fa; /* 余白の背景色 */
        padding: 0; /* Bootstrapのimg-thumbnailのpaddingを上書き */
    }
    tbody tr {
        cursor: pointer; /* クリック可能であることを示す */
    }
    .grayscale {
        filter: grayscale(100%);
        cursor: not-allowed;
    }
    .pagination .page-link {
        white-space: nowrap; /* ページリンク内のテキストを折り返さない */
    }
    /* スマートフォンなどの小さい画面向けのページネーション調整 */
    @media (max-width: 767.98px) {
        .pagination .page-item {
            margin: 0 1px; /* ページアイテム間のマージンを減らす */
        }
        .pagination .page-link {
            padding: 0.25rem 0.5rem; /* パディングを減らす */
            font-size: 0.875rem; /* フォントサイズを少し小さくする */
        }
    }
    /* スマートフォンなどの小さい画面向けのスタイル */
    @media (max-width: 767.98px) {
        thead { display: none; }
        tbody {
            display: block; /* trのmarginを有効にするため */
            width: 100%;
        }
        tr {
            display: grid;
            grid-template-columns: 50px 1fr auto; /* サムネイル | 情報 | アクション */
            gap: 0.1rem; /* 要素間の隙間を極限まで狭く */
            border: 1px solid #dee2e6; /* 枠線 */
            border-bottom: 0; /* 下の枠線は消す */
            border-radius: 0; /* 角丸をなくす */
            margin-bottom: 0; /* カード間のマージンをなくす */
            padding: 0.1rem 0; /* カード内の上下パディングを最小限に、左右は0に */
        }
        tbody tr:last-child {
            border-bottom: 1px solid #dee2e6; /* 最後のカードにだけ下線を追加 */
        }
        /* table-stripedの背景色を無効化 */
        .table-striped>tbody>tr:nth-of-type(odd)>* {
            --bs-table-accent-bg: transparent;
        }
        td {
            display: block;
            text-align: left !important;
            width: 100% !important;
            border: none;
            padding: 0;
            background-color: transparent !important; /* 背景色を強制的に透明に */
        }
        td[data-label="サムネイル"] { grid-column: 1; grid-row: 1 / 3; align-self: center; }
        td[data-label="商品情報"] { grid-column: 2; grid-row: 1 / 3; align-self: center; min-width: 0; }
        td[data-label="投稿日時"] { grid-column: 3; grid-row: 1; align-self: start; }
        td[data-label="i"] { grid-column: 3; grid-row: 2; align-self: center; }
        .product-thumbnail {
            border: none; /* スマホ表示では画像の枠線を消す */
        }
    }
    /* PC表示でサムネイル列を中央揃えにする */
    @media (min-width: 768px) {
        td[data-label="サムネイル"] { text-align: center !important; }
        .product-thumbnail {
            width: 70px; /* PC表示では画像を大きく */
            height: 70px;
        }
    }
    /* 選択された行の画像スタイル (PC/スマホ共通) */
    tr.selected .img-thumbnail {
        border: 3px solid #0d6efd !important; /* プライマリカラーで枠線を太く */
        padding: 1px;
    }
    /* PC表示では検索フィルターを常に表示 */
    @media (min-width: 768px) {
        #search-filters.collapse {
            display: flex;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2"><i class="bi bi-send-check-fill me-2"></i>投稿済商品</h1>
</div>

<!-- 操作エリア -->
<div class="d-flex justify-content-between align-items-center mb-3">
    <!-- 表示件数 -->
    <div class="input-group input-group-sm" style="width: auto;">
        <label class="input-group-text" for="items-per-page-select"><i class="bi bi-list-ol"></i></label>
        <select class="form-select" id="items-per-page-select">
            <option value="10">10件</option>
            <option value="30" selected>30件</option>
            <option value="50">50件</option>
            <option value="100">100件</option>
        </select>
    </div>
    <!-- 一括操作ボタン -->
    <div class="d-flex gap-2">
        <button type="button" class="btn btn-sm btn-outline-secondary" id="select-all-toggle-btn" onclick="toggleSelectAll()" title="すべて選択/解除">
            <i class="bi bi-check-square"></i><span class="d-none d-md-inline ms-1">全選択</span>
        </button>
        <button type="button" class="btn btn-sm btn-outline-info" id="bulk-recollect-btn" onclick="bulkRecollect()" disabled title="選択した商品を再収集リストに戻します">
            <i class="bi bi-recycle"></i><span class="d-none d-md-inline ms-1">再コレ</span>
        </button>
        <button type="button" class="btn btn-sm btn-outline-danger" id="bulk-delete-btn" onclick="bulkDelete()" disabled title="選択した商品を削除">
            <i class="bi bi-trash-fill"></i><span class="d-none d-md-inline ms-1">選択項目を削除</span>
        </button>
    </div>
</div>

<!-- スマホ表示用の検索フィルター開閉ボタン -->
<div class="d-grid d-md-none mb-3">
    <button class="btn btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#search-filters" aria-expanded="false" aria-controls="search-filters">
        <i class="bi bi-funnel-fill me-2"></i>検索条件
    </button>
</div>

<!-- 検索フィルター -->
<div class="row g-2 mb-3 align-items-end collapse" id="search-filters">
    <div class="col-lg-5 col-md-12">
        <label for="search-input" class="form-label small mb-1 d-none d-md-block">キーワード</label>
        <div class="input-group input-group-sm">
            <input type="search" id="search-input" class="form-control" placeholder="商品名、キーワードで検索...">
        </div>
    </div>
    <div class="col-lg-5 col-md-8">
        <label for="start-date-input" class="form-label small mb-1 d-none d-md-block">投稿期間</label>
        <div class="input-group input-group-sm">
            <input type="date" id="start-date-input" class="form-control">
            <span class="input-group-text">～</span>
            <input type="date" id="end-date-input" class="form-control">
        </div>
    </div>
    <div class="col-lg-2 col-md-4 d-flex gap-2 mt-2 mt-md-0">
        <button class="btn btn-primary btn-sm w-100" type="button" id="search-btn"><i class="bi bi-search"></i> 検索</button>
        <button class="btn btn-outline-secondary btn-sm" type="button" id="clear-btn" title="条件をクリア"><i class="bi bi-x-lg"></i></button>
    </div>
</div>

<div class="table-responsive">
    <table class="table table-striped table-sm align-middle" style="table-layout: fixed; width: 100%;">
        <thead>
            <tr>
                <th scope="col" style="width: 12%;">サムネイル</th>
                <th scope="col" style="width: 76%;">商品情報</th>
                <th scope="col" style="width: 12%;">投稿日時</th>
                <th scope="col" style="width: 5%;" class="text-center"><i class="bi bi-info-circle-fill"></i></th>
            </tr>
        </thead>
        <tbody id="posted-products-table-body">
            <!-- データはJavaScriptでここに挿入されます -->
        </tbody>
    </table>
</div>

<nav aria-label="Page navigation">
    <ul class="pagination justify-content-center flex-wrap" id="pagination-container">
        <!-- ページネーションはここに挿入されます -->
    </ul>
</nav>

<!-- Info Modal -->
<div class="modal fade" id="infoModal" tabindex="-1" aria-labelledby="infoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="infoModalLabel"><i class="bi bi-card-text me-2"></i>商品詳細</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <h6 class="fw-bold">商品名</h6>
                <p id="infoModalProductName" class="mb-3"></p>
                <div class="d-flex flex-wrap gap-2 mb-3">
                    <a href="#" id="infoModalProductUrl" class="btn btn-sm btn-outline-primary" target="_blank" rel="noopener noreferrer"><i class="bi bi-bag-fill me-1"></i>商品ページ</a>
                    <!-- コレ！ページ (post_url) -->
                    <a href="#" id="infoModalPostUrl" class="btn btn-sm btn-outline-success" target="_blank" rel="noopener noreferrer"><i class="bi bi-send-fill me-1"></i>コレ！ページ</a>
                    <!-- 投稿済ROOMページ (room_url) -->
                    <a href="#" id="infoModalRoomUrl" class="btn btn-sm btn-outline-info" target="_blank" rel="noopener noreferrer"><i class="bi bi-house-heart-fill me-1"></i>投稿済ROOMページ</a>
                    <!-- 投稿済ROOMページ登録フォーム -->
                    <div id="registerRoomUrlForm" class="input-group input-group-sm" style="display: none; max-width: 400px;">
                        <input type="url" class="form-control" id="roomUrlInput" placeholder="投稿済ROOMページのURLを貼り付け">
                        <button class="btn btn-success" type="button" id="saveRoomUrlBtn"><i class="bi bi-save-fill"></i></button>
                    </div>
                </div>
                <h6 class="fw-bold"><i class="bi bi-robot me-2"></i>AIによるキャプション</h6>
                <div id="infoModalAiCaption" style="white-space: pre-wrap;"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-info" id="info-modal-recollect-btn">再コレ</button>
                <button type="button" class="btn btn-danger me-auto" id="info-modal-delete-btn">削除</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteConfirmModalLabel"><i class="bi bi-exclamation-triangle-fill text-danger me-2"></i>商品の削除</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>本当にこの商品を削除しますか？</p>
                <p class="fw-bold" id="delete-product-name"></p>
                <p class="small text-muted">この操作は元に戻せません。</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                <button type="button" class="btn btn-danger" id="confirm-delete-btn">削除する</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentPage = 1;

    async function fetchPostedProducts(page = 1, searchTerm = '', startDate = '', endDate = '') {
        const tableBody = document.getElementById('posted-products-table-body');
        tableBody.innerHTML = `<tr><td colspan="5" class="text-center"><div class="spinner-border spinner-border-sm" role="status"><span class="visually-hidden">Loading...</span></div></td></tr>`;
        
        const itemsPerPage = document.getElementById('items-per-page-select').value;
        try {
            const params = new URLSearchParams({
                page: page,
                per_page: itemsPerPage,
                search_term: searchTerm
            });
            if (startDate) params.append('start_date', startDate);
            if (endDate) params.append('end_date', endDate);
            const url = `/api/posted-products?${params.toString()}`;
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error('サーバーからのデータ取得に失敗しました。');
            }
            const data = await response.json();
            
            tableBody.innerHTML = '';
            if (data.products.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5" class="text-center">該当する商品はありません。</td></tr>';
            } else {
                data.products.forEach(product => {
                    let postedAt;
                    if (product.posted_at) {
                        const now = new Date();
                        const postDate = new Date(product.posted_at);
                        const diffMinutes = Math.floor((now - postDate) / (1000 * 60));
                        const diffHours = Math.floor(diffMinutes / 60);

                        if (diffHours < 24) {
                            if (diffMinutes < 60) {
                                postedAt = `${diffMinutes}分前`;
                            } else {
                                postedAt = `${diffHours}時間前`;
                            }
                        } else {
                            // 1日以上前なら「月/日」表記
                            postedAt = `${postDate.getMonth() + 1}月${postDate.getDate()}日`;
                        }
                    } else {
                        postedAt = 'N/A';
                    }

                    let thumbnailHtml;
                    if (product.room_url) {
                        thumbnailHtml = `<a href="${product.room_url}" target="_blank" rel="noopener noreferrer">
                                            <img src="${product.image_url || 'https://via.placeholder.com/60'}" alt="${product.name}" class="img-thumbnail product-thumbnail">
                                         </a>`;
                    } else {
                        thumbnailHtml = `<img src="${product.image_url || 'https://via.placeholder.com/60'}" alt="${product.name}" class="img-thumbnail product-thumbnail grayscale" title="ROOM投稿URL未取得">`;
                    }

                    const escapedProductJson = JSON.stringify(product).replace(/'/g, '&apos;').replace(/"/g, '&quot;');

                    const row = `
                        <tr id="product-row-${product.id}" data-product='${escapedProductJson}'>
                            <td data-label="サムネイル">
                                ${thumbnailHtml}
                            </td>
                            <td data-label="商品情報" class="text-start">
                                <div class="fw-bold truncate-cell" title="${product.name || ''}">${product.name || ''}</div>
                                <div class="text-muted small truncate-cell" title="${product.ai_caption || ''}">${product.ai_caption || ''}</div>
                            </td>
                            <td data-label="投稿日時" class="small text-muted">${postedAt}</td>
                            <td data-label="i" class="text-center">
                                ${product.ai_caption ? `
                                <i class="bi bi-info-circle text-primary fs-5"
                                   data-bs-toggle="modal"
                                   data-bs-target="#infoModal"></i>` : ''}
                            </td>
                        </tr>
                    `;
                    tableBody.innerHTML += row;
                });
            }
            
            renderPagination(data.total_pages, page);
            
        } catch (error) {
            console.error('Error:', error);
            tableBody.innerHTML = `<tr><td colspan="5" class="text-center text-danger">${error.message}</td></tr>`;
        }
    }

    function renderPagination(totalPages, currentPage) {
        const paginationContainer = document.getElementById('pagination-container');
        paginationContainer.innerHTML = '';

        if (totalPages <= 1) return;

        // Previous button
        const prevLi = document.createElement('li');
        prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
        prevLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage - 1})">前へ</a>`;
        paginationContainer.appendChild(prevLi);

        // Page numbers
        // Show a limited number of pages around the current page
        // 画面幅に応じて表示するページ数を変更
        const maxPagesToShow = window.innerWidth < 768 ? 5 : 7;
        let startPage = Math.max(1, currentPage - Math.floor(maxPagesToShow / 2));
        let endPage = Math.min(totalPages, startPage + maxPagesToShow - 1);

        if (endPage - startPage + 1 < maxPagesToShow) {
            startPage = Math.max(1, endPage - maxPagesToShow + 1);
        }

        if (startPage > 1) {
            const firstLi = document.createElement('li');
            firstLi.className = 'page-item';
            firstLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(1)">1</a>`;
            paginationContainer.appendChild(firstLi);
            if (startPage > 2) {
                const ellipsisLi = document.createElement('li');
                ellipsisLi.className = 'page-item disabled';
                ellipsisLi.innerHTML = `<span class="page-link">...</span>`;
                paginationContainer.appendChild(ellipsisLi);
            }
        }

        for (let i = startPage; i <= endPage; i++) {
            const pageLi = document.createElement('li');
            pageLi.className = `page-item ${i === currentPage ? 'active' : ''}`;
            pageLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${i})">${i}</a>`;
            paginationContainer.appendChild(pageLi);
        }

        if (endPage < totalPages) {
            if (endPage < totalPages - 1) {
                const ellipsisLi = document.createElement('li');
                ellipsisLi.className = 'page-item disabled';
                ellipsisLi.innerHTML = `<span class="page-link">...</span>`;
                paginationContainer.appendChild(ellipsisLi);
            }
            const lastLi = document.createElement('li');
            lastLi.className = 'page-item';
            lastLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${totalPages})">${totalPages}</a>`;
            paginationContainer.appendChild(lastLi);
        }

        // Next button
        const nextLi = document.createElement('li');
        nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
        nextLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage + 1})">次へ</a>`;
        paginationContainer.appendChild(nextLi);
    }

    function changePage(page) {
        event.preventDefault();
        currentPage = page;
        triggerSearch();
    }

    function triggerSearch() {
        const searchTerm = document.getElementById('search-input').value;
        const startDate = document.getElementById('start-date-input').value;
        const endDate = document.getElementById('end-date-input').value;
        fetchPostedProducts(currentPage, searchTerm, startDate, endDate);
    }

    function updateBulkActionButtons() {
        const selectedIds = getSelectedProductIds();
        const disabled = selectedIds.length === 0;
        document.getElementById('bulk-recollect-btn').disabled = disabled;
        document.getElementById('bulk-delete-btn').disabled = disabled;
    }

    function getSelectedProductIds() {
        return Array.from(document.querySelectorAll('#posted-products-table-body tr.selected')).map(row => {
            return row.id.replace('product-row-', '');
        });
    }

    function toggleSelectAll() {
        const selectableRows = document.querySelectorAll('#posted-products-table-body tr');
        const isAllSelected = getSelectedProductIds().length === selectableRows.length && selectableRows.length > 0;

        selectableRows.forEach(row => row.classList.toggle('selected', !isAllSelected));
        updateBulkActionButtons();
    }

    async function bulkRecollect() {
        const productIds = getSelectedProductIds();
        if (productIds.length === 0) return;
        if (!confirm(`${productIds.length}件の商品を「再コレ」（再収集）リストに戻しますか？`)) return;

        // UIから即座に削除
        productIds.forEach(id => {
            const row = document.getElementById(`product-row-${id}`);
            if (row) row.remove();
        });
        updateBulkActionButtons();

        // バックグラウンドでAPIを呼び出す
        fetch('/api/posted-products/bulk-recollect', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ product_ids: productIds })
        })
        .then(response => response.json())
        .then(result => {
            if (!result.status || result.status !== 'success') throw new Error(result.detail || '一括再コレ処理の開始に失敗しました。');
            showToast('タスク開始', result.message, 'info');
        })
        .catch(error => alert(`エラー: ${error.message}`));
    }

    async function bulkDelete() {
        const productIds = getSelectedProductIds();
        if (productIds.length === 0) return;
        if (!confirm(`${productIds.length}件の商品を削除しますか？この操作は元に戻せません。`)) return;
        
        // UIから即座に削除
        productIds.forEach(id => {
            const row = document.getElementById(`product-row-${id}`);
            if (row) row.remove();
        });
        updateBulkActionButtons();

        // バックグラウンドでAPIを呼び出す
        fetch('/api/posted-products/bulk-delete', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ product_ids: productIds })
        })
        .then(response => response.json())
        .then(result => {
            if (!result.status || result.status !== 'success') throw new Error(result.detail || '一括削除処理の開始に失敗しました。');
            showToast('タスク開始', result.message, 'info');
        })
        .catch(error => alert(`エラー: ${error.message}`));
    }

    async function saveRoomUrl(productId) {
        const input = document.getElementById('roomUrlInput');
        const url = input.value.trim();
        if (!url) {
            alert('URLを入力してください。');
            return;
        }
        
        try {
            const response = await fetch(`/api/posted-products/${productId}/room-url`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ room_url: url })
            });
            const result = await response.json();
            if (!response.ok) {
                throw new Error(result.detail || 'URLの保存に失敗しました。');
            }
            showToast('成功', '投稿済ROOMページのURLを保存しました。', 'success');
            
            // モーダルを閉じる
            const infoModal = bootstrap.Modal.getInstance(document.getElementById('infoModal'));
            if (infoModal) infoModal.hide();

            // ページをリロードせずにUIを更新
            triggerSearch();

        } catch (error) {
            alert(`エラー: ${error.message}`);
        }
    }

    async function recollectProduct(productId, productName) {
        if (event) {
            event.stopPropagation();
        }
        if (!confirm(`商品「${productName}」を「再コレ」（再収集）リストに戻しますか？`)) return;
        
        // UIから即座に削除
        const row = document.getElementById(`product-row-${productId}`);
        if (row) row.remove();
        updateBulkActionButtons();
        const infoModal = bootstrap.Modal.getInstance(document.getElementById('infoModal'));
        if (infoModal) infoModal.hide();

        // バックグラウンドでAPIを呼び出す
        fetch(`/api/posted-products/${productId}/recollect`, { method: 'POST' })
            .then(response => response.json())
            .then(result => {
                if (!result.status || result.status !== 'success') throw new Error(result.detail || '再コレ処理の開始に失敗しました。');
                showToast('タスク開始', result.message, 'info');
            })
            .catch(error => alert(`エラー: ${error.message}`));
    }

    function deleteProduct(productId, productName) {
        // eventが渡された場合のみstopPropagationを実行
        if (event) {
            event.stopPropagation(); // 行選択イベントの発火を防ぐ
        }
        
        const deleteModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
        document.getElementById('delete-product-name').textContent = productName;
        const confirmBtn = document.getElementById('confirm-delete-btn');

        // 既存のリスナーを削除してから新しいリスナーを追加
        const newConfirmBtn = confirmBtn.cloneNode(true);
        confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);

        newConfirmBtn.addEventListener('click', async () => {
            // UIから即座に削除
            const row = document.getElementById(`product-row-${productId}`);
            if (row) row.remove();
            updateBulkActionButtons();
            deleteModal.hide();

            // バックグラウンドでAPIを呼び出す
            fetch(`/api/posted-products/${productId}`, { method: 'DELETE' })
                .then(response => response.json())
                .then(result => {
                    if (!result.status || result.status !== 'success') throw new Error(result.detail || '削除処理の開始に失敗しました。');
                    showToast('タスク開始', result.message, 'info');
                })
                .catch(error => alert(`エラー: ${error.message}`));
        });
        deleteModal.show();
    }

    document.addEventListener('DOMContentLoaded', function() {
        triggerSearch();

        const searchBtn = document.getElementById('search-btn');
        const searchInput = document.getElementById('search-input');
        const clearBtn = document.getElementById('clear-btn');
        const startDateInput = document.getElementById('start-date-input');
        const endDateInput = document.getElementById('end-date-input');
        const itemsPerPageSelect = document.getElementById('items-per-page-select');

        searchBtn.addEventListener('click', () => {
            currentPage = 1;
            triggerSearch();
        });

        clearBtn.addEventListener('click', () => {
            currentPage = 1;
            searchInput.value = '';
            startDateInput.value = '';
            endDateInput.value = '';
            triggerSearch();
        });

        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                currentPage = 1;
                triggerSearch();
            }
        });

        itemsPerPageSelect.addEventListener('change', () => {
            currentPage = 1; // 表示件数を変えたら1ページ目に戻る
            triggerSearch();
        });

        const infoModal = document.getElementById('infoModal');
        if (infoModal) {
            infoModal.addEventListener('show.bs.modal', function (event) {
                const button = event.relatedTarget;
                const row = button.closest('tr');
                const product = JSON.parse(row.dataset.product.replace(/&apos;/g, "'").replace(/&quot;/g, '"'));

                const productId = product.id;
                const productName = product.name;
                const aiCaption = product.ai_caption;
                
                infoModal.querySelector('#infoModalProductName').textContent = productName;
                infoModal.querySelector('#infoModalAiCaption').textContent = aiCaption;

                // リンクの設定
                const productUrlLink = infoModal.querySelector('#infoModalProductUrl');
                const postUrlLink = infoModal.querySelector('#infoModalPostUrl'); // コレ！ページ用
                const roomUrlLink = infoModal.querySelector('#infoModalRoomUrl'); // 投稿済ROOMページ用
                const registerForm = infoModal.querySelector('#registerRoomUrlForm');
                const saveUrlBtn = infoModal.querySelector('#saveRoomUrlBtn');
                const roomUrlInput = infoModal.querySelector('#roomUrlInput');

                productUrlLink.href = product.url || '#';
                productUrlLink.style.display = product.url ? 'inline-flex' : 'none';

                // コレ！ページ (post_url) は常に表示
                postUrlLink.href = product.post_url || '#';
                postUrlLink.style.display = product.post_url ? 'inline-flex' : 'none';

                // 投稿済ROOMページ (room_url) の有無で表示を切り替え
                if (product.room_url) {
                    roomUrlLink.href = product.room_url;
                    roomUrlLink.style.display = 'inline-flex';
                    registerForm.style.display = 'none';
                } else {
                    roomUrlLink.style.display = 'none'; // リンクは非表示
                    registerForm.style.display = 'flex';
                    roomUrlInput.value = ''; // 入力欄をクリア
                    saveUrlBtn.onclick = () => saveRoomUrl(productId);
                }

                const recollectBtn = infoModal.querySelector('#info-modal-recollect-btn');
                const newRecollectBtn = recollectBtn.cloneNode(true);
                recollectBtn.parentNode.replaceChild(newRecollectBtn, recollectBtn);

                newRecollectBtn.addEventListener('click', () => {
                    // モーダルを閉じる必要はないので、直接関数を呼び出す
                    recollectProduct(productId, productName);
                });


                const deleteBtn = infoModal.querySelector('#info-modal-delete-btn');
                
                const newDeleteBtn = deleteBtn.cloneNode(true);
                deleteBtn.parentNode.replaceChild(newDeleteBtn, deleteBtn);

                newDeleteBtn.addEventListener('click', () => {
                    bootstrap.Modal.getInstance(infoModal).hide();
                    deleteProduct(productId, productName);
                });
            });
        }

        const tableBody = document.getElementById('posted-products-table-body');
        tableBody.addEventListener('click', function (e) {
            const row = e.target.closest('tr');
            if (!row) return;

            // 行内のリンク(a)やボタン(i)がクリックされた場合は、行選択を無効にする
            if (e.target.closest('a') || e.target.closest('i[data-bs-toggle="modal"]') || e.target.closest('button')) {
                return;
            }

            // クリックされた行の 'selected' クラスをトグル（付け外し）する
            row.classList.toggle('selected');
            // 一括操作ボタンの状態を更新
            updateBulkActionButtons();
        });

    });
</script>

{% endblock %}