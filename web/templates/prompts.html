{% extends "base.html" %}

{% block title %}ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç·¨é›† - R-Auto Control Panel{% endblock %}

{% block styles %}
<style>
    .prompt-textarea {
        font-family: 'Menlo', 'Monaco', 'Consolas', "Courier New", monospace;
        font-size: 0.95rem;
        line-height: 1.6;
        height: 65vh; /* ãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆã®é«˜ã•ã®65%ã‚’ç¢ºä¿ */
    }
    .tab-content, .tab-pane, .card, .card-body {
        height: 100%;
        display: flex;
        flex-direction: column;
    }
    .card-header {
        background-color: #f8f9fa;
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">ğŸ“ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç·¨é›†</h1>
</div>

<p class="text-muted">
    AIãŒã‚¿ã‚¹ã‚¯ã‚’å®Ÿè¡Œã™ã‚‹éš›ã«ä½¿ç”¨ã™ã‚‹æŒ‡ç¤ºï¼ˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼‰ã‚’ã“ã“ã§ç·¨é›†ã§ãã¾ã™ã€‚å¤‰æ›´ã¯ã€Œä¿å­˜ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨å³åº§ã«åæ˜ ã•ã‚Œã¾ã™ã€‚
</p>

<!-- Nav tabs -->
<ul class="nav nav-tabs" id="promptTabs" role="tablist">
    <!-- ã‚¿ãƒ–ã¯ã“ã“ã«JavaScriptã§æŒ¿å…¥ã•ã‚Œã¾ã™ -->
</ul>

<!-- Tab panes -->
<div class="tab-content pt-3" id="promptTabContent">
    <div class="text-center mt-5" id="loading-indicator">
        <div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div>
        <p class="mt-2">ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</p>
    </div>
    <!-- ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¯ã“ã“ã«JavaScriptã§æŒ¿å…¥ã•ã‚Œã¾ã™ -->
</div>


{% endblock %}

{% block scripts %}
<script>
    async function savePrompt(promptKey) {
        const card = document.getElementById(`prompt-card-${promptKey}`);
        const textarea = card.querySelector('textarea');
        const saveButton = card.querySelector('button');
        const originalButtonHtml = saveButton.innerHTML;

        const content = textarea.value;
        const filename = textarea.dataset.filename;

        // ãƒœã‚¿ãƒ³ã‚’ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã«ã™ã‚‹
        saveButton.disabled = true;
        saveButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> ä¿å­˜ä¸­...';

        try {
            const response = await fetch(`/api/prompts/${promptKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ content: content, filename: filename })
            });

            const result = await response.json();
            if (!response.ok) {
                throw new Error(result.error || 'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            }
            showToast('ä¿å­˜å®Œäº†', result.message, 'success');
        } catch (error) {
            showToast('ã‚¨ãƒ©ãƒ¼', error.message, 'danger');
        } finally {
            // ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’å…ƒã«æˆ»ã™
            saveButton.disabled = false;
            saveButton.innerHTML = originalButtonHtml;
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        const tabsContainer = document.getElementById('promptTabs');
        const contentContainer = document.getElementById('promptTabContent');
        const loadingIndicator = document.getElementById('loading-indicator');

        fetch('/api/prompts')
            .then(response => response.json())
            .then(data => {
                loadingIndicator.remove(); // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºã‚’å‰Šé™¤
                if (data.error) {
                    throw new Error(data.error);
                }

                let isFirst = true;
                for (const key in data) {
                    const prompt = data[key];
                    const activeClass = isFirst ? 'active' : '';
                    const showClass = isFirst ? 'show' : '';

                    // ã‚¿ãƒ–ã®ãƒªãƒ³ã‚¯éƒ¨åˆ†ã‚’ç”Ÿæˆ
                    const tabHtml = `
                        <li class="nav-item" role="presentation">
                            <button class="nav-link ${activeClass}" id="${key}-tab" data-bs-toggle="tab" data-bs-target="#${key}-pane" type="button" role="tab" aria-controls="${key}-pane" aria-selected="${isFirst}">${prompt.name_ja}</button>
                        </li>
                    `;
                    tabsContainer.innerHTML += tabHtml;

                    // ã‚¿ãƒ–ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„éƒ¨åˆ†ã‚’ç”Ÿæˆ
                    const contentHtml = `
                        <div class="tab-pane fade ${showClass} ${activeClass}" id="${key}-pane" role="tabpanel" aria-labelledby="${key}-tab" tabindex="0">
                            <div class="card h-100" id="prompt-card-${key}">
                                <div class="card-body flex-grow-1">
                                    <p class="text-muted small mb-2">${prompt.description}</p>
                                    <textarea class="form-control prompt-textarea flex-grow-1" data-filename="${prompt.filename}">${prompt.content}</textarea>
                                </div>
                                <div class="card-footer text-end">
                                    <button class="btn btn-primary" onclick="savePrompt('${key}')"><i class="bi bi-save-fill me-1"></i>ä¿å­˜</button>
                                </div>
                            </div>
                        </div>
                    `;
                    contentContainer.innerHTML += contentHtml;
                    isFirst = false;
                }
            })
            .catch(error => {
                contentContainer.innerHTML = `<div class="alert alert-danger">${error.message}</div>`;
            });
    });
</script>
{% endblock %}