{% extends "base.html" %}

{% block title %}ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç·¨é›† - R-Auto Control Panel{% endblock %}

{% block styles %}
<style>
    .prompt-textarea {
        font-family: 'Menlo', 'Monaco', 'Consolas', "Courier New", monospace;
        font-size: 0.95rem;
        line-height: 1.6;
        height: 65vh; /* ãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆã®é«˜ã•ã®65%ã‚’ç¢ºä¿ */
    }
    .tab-content, .tab-pane, .card, .card-body {
        height: 100%;
        display: flex;
        flex-direction: column;
    }
    .card-header {
        background-color: #f8f9fa;
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">ğŸ“ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç·¨é›†</h1>
</div>

<p class="text-muted">
    AIãŒã‚¿ã‚¹ã‚¯ã‚’å®Ÿè¡Œã™ã‚‹éš›ã«ä½¿ç”¨ã™ã‚‹æŒ‡ç¤ºï¼ˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼‰ã‚’ã“ã“ã§ç·¨é›†ã§ãã¾ã™ã€‚å¤‰æ›´ã¯ã€Œä¿å­˜ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨å³åº§ã«åæ˜ ã•ã‚Œã¾ã™ã€‚
</p>

<!-- Nav tabs -->
<ul class="nav nav-tabs" id="promptTabs" role="tablist">
    <!-- ã‚¿ãƒ–ã¯ã“ã“ã«JavaScriptã§æŒ¿å…¥ã•ã‚Œã¾ã™ -->
</ul>

<!-- Tab panes -->
<div class="tab-content pt-3" id="promptTabContent">
    <div class="text-center mt-5" id="loading-indicator">
        <div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div>
        <p class="mt-2">ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</p>
    </div>
    <!-- ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¯ã“ã“ã«JavaScriptã§æŒ¿å…¥ã•ã‚Œã¾ã™ -->
</div>


{% endblock %}

{% block scripts %}
<script>
    async function savePrompt(promptKey) {
        const card = document.getElementById(`prompt-card-${promptKey}`);
        const textarea = card.querySelector('textarea');
        const saveButton = card.querySelector('button');
        const originalButtonHtml = saveButton.innerHTML;

        const content = textarea.value;
        const filename = textarea.dataset.filename;

        // ãƒœã‚¿ãƒ³ã‚’ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã«ã™ã‚‹
        saveButton.disabled = true;
        saveButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> ä¿å­˜ä¸­...';

        try {
            const response = await fetch(`/api/prompts/${promptKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ content: content, filename: filename })
            });

            const result = await response.json();
            if (!response.ok) {
                throw new Error(result.error || 'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            }
            showToast('ä¿å­˜å®Œäº†', result.message, 'success');
        } catch (error) {
            showToast('ã‚¨ãƒ©ãƒ¼', error.message, 'danger');
        } finally {
            // ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’å…ƒã«æˆ»ã™
            saveButton.disabled = false;
            saveButton.innerHTML = originalButtonHtml;
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        const tabsContainer = document.getElementById('promptTabs');
        const contentContainer = document.getElementById('promptTabContent');
        const loadingIndicator = document.getElementById('loading-indicator');

        fetch('/api/prompts')
            .then(response => response.json())
            .then(data => {
                loadingIndicator.remove(); // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºã‚’å‰Šé™¤
                if (data.error) {
                    throw new Error(data.error);
                }

                let isFirst = true;
                for (const key in data) {
                    const prompt = data[key];
                    const activeClass = isFirst ? 'active' : '';
                    const showClass = isFirst ? 'show' : '';

                    // ã‚¿ãƒ–ã®ãƒªãƒ³ã‚¯éƒ¨åˆ†ã‚’ç”Ÿæˆ
                    const tabHtml = `
                        <li class="nav-item" role="presentation">
                            <button class="nav-link ${activeClass}" id="${key}-tab" data-bs-toggle="tab" data-bs-target="#${key}-pane" type="button" role="tab" aria-controls="${key}-pane" aria-selected="${isFirst}">${prompt.name_ja}</button>
                        </li>
                    `;
                    tabsContainer.innerHTML += tabHtml;

                    // ã‚¿ãƒ–ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„éƒ¨åˆ†ã‚’ç”Ÿæˆ
                    const contentHtml = `
                        <div class="tab-pane fade ${showClass} ${activeClass}" id="${key}-pane" role="tabpanel" aria-labelledby="${key}-tab" tabindex="0">
                            <div class="accordion mb-3" id="profileAccordion-${key}">
                                <div class="accordion-item">
                                    <h2 class="accordion-header">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-${key}" aria-expanded="false" aria-controls="collapse-${key}">
                                            <i class="bi bi-collection-fill me-2"></i>ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ç®¡ç†
                                        </button>
                                    </h2>
                                    <div id="collapse-${key}" class="accordion-collapse collapse" data-bs-parent="#profileAccordion-${key}">
                                        <div class="accordion-body">
                                            <div class="row g-2 align-items-center">
                                                <div class="col-sm-4">
                                                    <label for="profile-select-${key}" class="form-label">ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</label>
                                                    <select id="profile-select-${key}" class="form-select"></select>
                                                </div>
                                                <div class="col-sm-8 d-flex align-items-end gap-2">
                                                    <button class="btn btn-primary" onclick="loadProfile('${key}')"><i class="bi bi-box-arrow-in-down me-1"></i>èª­ã¿è¾¼ã¿</button>
                                                    <button class="btn btn-danger" onclick="deleteProfile('${key}')"><i class="bi bi-trash me-1"></i>å‰Šé™¤</button>
                                                </div>
                                            </div>
                                            <hr>
                                            <div class="row g-2 align-items-center">
                                                <div class="col-sm-4">
                                                    <label for="new-profile-name-${key}" class="form-label">ç¾åœ¨ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’åå‰ã‚’ä»˜ã‘ã¦ä¿å­˜</label>
                                                    <input type="text" id="new-profile-name-${key}" class="form-control" placeholder="ä¾‹: å¯¾è©±é‡è¦–ã‚³ãƒ¡ãƒ³ãƒˆç”¨">
                                                </div>
                                                <div class="col-sm-8 d-flex align-items-end"><button class="btn btn-success" onclick="saveProfile('${key}')"><i class="bi bi-save me-1"></i>ä¿å­˜</button></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="card h-100" id="prompt-card-${key}">
                                <div class="card-body flex-grow-1">
                                    <p class="text-muted small mb-2">${prompt.description}</p>
                                    <textarea class="form-control prompt-textarea flex-grow-1" data-filename="${prompt.filename}">${prompt.content}</textarea>
                                </div>
                                <div class="card-footer text-end">
                                    <button class="btn btn-primary" onclick="savePrompt('${key}')"><i class="bi bi-floppy-fill me-1"></i>ç¾åœ¨ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä¿å­˜</button>
                                </div>
                            </div>
                        </div>
                    `;
                    contentContainer.innerHTML += contentHtml;
                    isFirst = false;
                }

                // å„ã‚¿ãƒ–ã®ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
                Object.keys(data).forEach(key => fetchProfiles(key));
            })
            .catch(error => {
                contentContainer.innerHTML = `<div class="alert alert-danger">${error.message}</div>`;
            });
    });

    // --- ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ç®¡ç†ç”¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆ ---

    async function fetchProfiles(promptKey) {
        try {
            const response = await fetch(`/api/prompt-profiles/${promptKey}`);
            const profiles = await response.json();
            const select = document.getElementById(`profile-select-${promptKey}`);
            select.innerHTML = '<option value="">-- ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ --</option>';
            profiles.forEach(p => {
                const option = document.createElement('option');
                option.value = p;
                option.textContent = p;
                select.appendChild(option);
            });
        } catch (error) {
            console.error('Failed to fetch profiles:', error);
        }
    }

    async function loadProfile(promptKey) {
        const select = document.getElementById(`profile-select-${promptKey}`);
        const profileName = select.value;
        if (!profileName) {
            alert('èª­ã¿è¾¼ã‚€ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
            return;
        }
        if (!confirm(`ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã€Œ${profileName}ã€ã‚’èª­ã¿è¾¼ã¿ã¾ã™ã‹ï¼Ÿ\nç¾åœ¨ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚`)) return;

        try {
            const response = await fetch(`/api/prompt-profiles/${promptKey}/${profileName}`, { method: 'PUT' });
            const result = await response.json();
            if (!response.ok) throw new Error(result.error);
            alert(result.message);
            location.reload(); // ç”»é¢ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦å¤‰æ›´ã‚’åæ˜ 
        } catch (error) {
            alert(`ã‚¨ãƒ©ãƒ¼: ${error.message}`);
        }
    }

    async function saveProfile(promptKey) {
        const input = document.getElementById(`new-profile-name-${promptKey}`);
        const profileName = input.value.trim();
        if (!profileName) {
            alert('ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
            return;
        }
        if (!confirm(`ç¾åœ¨ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ã€Œ${profileName}ã€ã¨ã—ã¦ä¿å­˜ã—ã¾ã™ã‹ï¼Ÿ`)) return;

        try {
            const response = await fetch(`/api/prompt-profiles/${promptKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ profile_name: profileName })
            });
            const result = await response.json();
            if (!response.ok) throw new Error(result.error);
            alert(result.message);
            input.value = '';
            await fetchProfiles(promptKey); // ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚’æ›´æ–°
        } catch (error) {
            alert(`ã‚¨ãƒ©ãƒ¼: ${error.message}`);
        }
    }

    async function deleteProfile(promptKey) {
        const select = document.getElementById(`profile-select-${promptKey}`);
        const profileName = select.value;
        if (!profileName) {
            alert('å‰Šé™¤ã™ã‚‹ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
            return;
        }
        if (!confirm(`æœ¬å½“ã«ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã€Œ${profileName}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚`)) return;

        try {
            const response = await fetch(`/api/prompt-profiles/${promptKey}/${profileName}`, { method: 'DELETE' });
            const result = await response.json();
            if (!response.ok) throw new Error(result.error);
            alert(result.message);
            await fetchProfiles(promptKey); // ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚’æ›´æ–°
        } catch (error) {
            alert(`ã‚¨ãƒ©ãƒ¼: ${error.message}`);
        }
    }
</script>
{% endblock %}