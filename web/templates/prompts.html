{% extends "base.html" %}

{% block title %}ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç·¨é›† - R-Auto Control Panel{% endblock %}

{% block styles %}
<style>
    .prompt-textarea {
        font-family: 'Menlo', 'Monaco', 'Consolas', "Courier New", monospace;
        font-size: 0.95rem;
        line-height: 1.6;
    }
    .card-header {
        background-color: #f8f9fa;
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">ğŸ“ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç·¨é›†</h1>
</div>


<!-- Nav tabs -->
<ul class="nav nav-tabs" id="promptTabs" role="tablist">
    <!-- ã‚¿ãƒ–ã¯ã“ã“ã«JavaScriptã§æŒ¿å…¥ã•ã‚Œã¾ã™ -->
</ul>

<!-- Tab panes -->
<div class="tab-content pt-3" id="promptTabContent">
    <div class="text-center mt-5" id="loading-indicator">
        <div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div>
        <p class="mt-2">ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</p>
    </div>
    <!-- ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¯ã“ã“ã«JavaScriptã§æŒ¿å…¥ã•ã‚Œã¾ã™ -->
</div>

<!-- ãƒ†ã‚¹ãƒˆå®Ÿè¡Œç”¨ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="testPromptModal" tabindex="-1" aria-labelledby="testPromptModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="testPromptModalLabel">ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row">
            <div class="col-md-6">
                <h6><i class="bi bi-file-earmark-text me-1"></i>ãƒ†ã‚¹ãƒˆç”¨ãƒ‡ãƒ¼ã‚¿ (JSON)</h6>
                <p class="text-muted small">ã“ã“ã«ãƒ†ã‚¹ãƒˆã—ãŸã„ãƒ‡ãƒ¼ã‚¿ã‚’JSONå½¢å¼ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«å¿œã˜ã¦é©åˆ‡ãªå½¢å¼ã®ãƒ‡ãƒ¼ã‚¿ã‚’è¤‡æ•°ä»¶ï¼ˆé…åˆ—å½¢å¼ã§ï¼‰å…¥åŠ›ã§ãã¾ã™ã€‚</p>
                <textarea id="test-data-input" class="form-control" rows="15" style="font-family: monospace; font-size: 0.8rem;"></textarea>
            </div>
            <div class="col-md-6">
                <h6><i class="bi bi-robot me-1"></i>AIã«ã‚ˆã‚‹ç”Ÿæˆçµæœ</h6>
                <p class="text-muted small">&nbsp;</p> <!-- é«˜ã•ã‚’åˆã‚ã›ã‚‹ãŸã‚ã®ãƒ€ãƒŸãƒ¼ -->
                <div id="test-result-output" class="bg-light p-2 rounded" style="height: calc(100% - 50px); overflow-y: auto; font-family: monospace; font-size: 0.8rem; white-space: pre-wrap;">
                    ã“ã“ã«çµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
                </div>
            </div>
        </div>
      </div>
      <div class="modal-footer">
        <input type="hidden" id="test-prompt-key-hidden">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é–‰ã˜ã‚‹</button>
        <button type="button" class="btn btn-primary" id="run-test-btn" onclick="runPromptTest()">
            <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
            <i class="bi bi-play-fill me-1"></i>ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        </button>
      </div>
    </div>
  </div>
</div>


{% endblock %}

{% block scripts %}
<script>
    let testPromptModal = null;

    const createCaptionSampleData = `[
    { "id": 101, "page_url": "https://item.rakuten.co.jp/shop/item001/", "item_description": "ã€æ¥½å¤©1ä½ã€‘ãƒ¯ã‚¤ãƒ¤ãƒ¬ã‚¹ã‚¤ãƒ¤ãƒ›ãƒ³ Bluetooth5.3 é«˜éŸ³è³ª ãƒã‚¤ã‚ºã‚­ãƒ£ãƒ³ã‚»ãƒªãƒ³ã‚°", "image_url": "https://thumbnail.image.rakuten.co.jp/@0_mall/shop/cabinet/item001.jpg", "ai_caption": "" },
    { "id": 102, "page_url": "https://item.rakuten.co.jp/shop/item002/", "item_description": "é€æ–™ç„¡æ–™ï¼ ãµã‚ãµã‚ä»Šæ²»ã‚¿ã‚ªãƒ« 3æšã‚»ãƒƒãƒˆ æŠ—èŒé˜²è‡­", "image_url": "https://thumbnail.image.rakuten.co.jp/@0_mall/shop/cabinet/item002.jpg", "ai_caption": "" },
    { "id": 103, "page_url": "https://item.rakuten.co.jp/shop/item003/", "item_description": "è¨³ã‚ã‚Šï¼ ç†Šæœ¬çœŒç”£ã¿ã‹ã‚“ 5kg ç”˜ãã¦ã‚¸ãƒ¥ãƒ¼ã‚·ãƒ¼", "image_url": "https://thumbnail.image.rakuten.co.jp/@0_mall/shop/cabinet/item003.jpg", "ai_caption": "" },
    { "id": 104, "page_url": "https://item.rakuten.co.jp/shop/item004/", "item_description": "é˜²ç½ãƒªãƒ¥ãƒƒã‚¯ 33ç‚¹ã‚»ãƒƒãƒˆ 1äººç”¨ éå¸¸ç”¨æŒã¡å‡ºã—è¢‹", "image_url": "https://thumbnail.image.rakuten.co.jp/@0_mall/shop/cabinet/item004.jpg", "ai_caption": "" },
    { "id": 105, "page_url": "https://item.rakuten.co.jp/shop/item005/", "item_description": "çŒ«å£± ãƒãƒªãƒãƒªãƒœã‚¦ãƒ« çŒ«ç”¨çˆªã¨ããƒ™ãƒƒãƒ‰ äº¤æ›å¯èƒ½", "image_url": "https://thumbnail.image.rakuten.co.jp/@0_mall/shop/cabinet/item005.jpg", "ai_caption": "" }
]`;

    const sampleData = {
        // æŠ•ç¨¿æ–‡ç”Ÿæˆã«é–¢é€£ã™ã‚‹ã‚­ãƒ¼ã§åŒã˜ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’å‚ç…§ã•ã›ã‚‹
        'create-caption-browser': createCaptionSampleData,
        'create-caption-gemini': createCaptionSampleData,
        'create-caption-flow': createCaptionSampleData,

        'create-comment': `[
    { "id": "user001", "ai_prompt_message": "æ–°è¦ã«ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ãã‚Œã¾ã—ãŸã€‚ ä»Šå›ã€æ–°ãŸã«3ä»¶ã®ã€Œã„ã„ã­ã€ã‚’ã—ã¦ãã‚Œã¾ã—ãŸã€‚", "comment_body": "" },
    { "id": "user002", "ai_prompt_message": "ä»¥å‰ã‹ã‚‰ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ãã‚Œã¦ã„ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ã™ã€‚ ã„ã¤ã‚‚ãŸãã•ã‚“ã®ã€Œã„ã„ã­ã€ã‚’ãã‚Œã‚‹å¸¸é€£ã®æ–¹ã§ã™ã€‚ ä»Šå›ã‚‚10ä»¶ã®ã€Œã„ã„ã­ã€ã‚’ã—ã¦ãã‚Œã¾ã—ãŸã€‚", "comment_body": "" },
    { "id": "user003", "ai_prompt_message": "ã¾ã ãƒ•ã‚©ãƒ­ãƒ¼ã•ã‚Œã¦ã„ãªã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ã™ã€‚ ä»Šå›ã€æ–°ãŸã«2ä»¶ã®ã€Œã„ã„ã­ã€ã‚’ã—ã¦ãã‚Œã¾ã—ãŸã€‚", "comment_body": "" },
    { "id": "user004", "ai_prompt_message": "ä»¥å‰ã‹ã‚‰ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ãã‚Œã¦ã„ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ã™ã€‚ ä»Šå›ã€æ–°ãŸã«1ä»¶ã®ã€Œã„ã„ã­ã€ã‚’ã—ã¦ãã‚Œã¾ã—ãŸã€‚", "comment_body": "" },
    { "id": "user005", "ai_prompt_message": "æ–°è¦ã«ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ãã‚Œã¾ã—ãŸã€‚ ä»Šå›ã€æ–°ãŸã«8ä»¶ã®ã€Œã„ã„ã­ã€ã‚’ã—ã¦ãã‚Œã¾ã—ãŸã€‚", "comment_body": "" }
]`,
        'summarize-text': `[
    { "text": "é•·æ–‡ã®ãƒ†ã‚­ã‚¹ãƒˆã‚µãƒ³ãƒ—ãƒ«1..." },
    { "text": "é•·æ–‡ã®ãƒ†ã‚­ã‚¹ãƒˆã‚µãƒ³ãƒ—ãƒ«2..." },
    { "text": "é•·æ–‡ã®ãƒ†ã‚­ã‚¹ãƒˆã‚µãƒ³ãƒ—ãƒ«3..." },
    { "text": "é•·æ–‡ã®ãƒ†ã‚­ã‚¹ãƒˆã‚µãƒ³ãƒ—ãƒ«4..." }
]`,
        'default': `[
    { "key1": "value1", "key2": "value2" }
]`
    };

    // ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ã‚’è¡¨ç¤ºã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
    function showToast(title, message, type = 'info') {
        // base.html ã«ã‚ã‚‹ãƒˆãƒ¼ã‚¹ãƒˆè¦ç´ ã‚’å–å¾—
        const toastEl = document.getElementById('appToast');
        const toastTitle = document.getElementById('toast-title');
        const toastBody = document.getElementById('toast-body');
        
        toastTitle.textContent = title;
        toastBody.textContent = message;

        // typeã«å¿œã˜ã¦ãƒ˜ãƒƒãƒ€ãƒ¼ã®è‰²ã‚’å¤‰æ›´ (success, danger, infoãªã©)
        toastEl.querySelector('.toast-header').className = `toast-header bg-${type} text-white`;

        const toast = new bootstrap.Toast(toastEl);
        toast.show();
    }

    async function savePrompt(promptKey) {
        // promptKey (ä¾‹: create-caption-flow) ã‚’ä½¿ã£ã¦ã€å¯¾å¿œã™ã‚‹ã‚«ãƒ¼ãƒ‰ã¨ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã‚’ç‰¹å®šã—ã¾ã™ã€‚
        const card = document.getElementById(`prompt-card-${promptKey}`);
        const textarea = document.querySelector(`#prompt-card-${promptKey} textarea`);
        const saveButton = card.querySelector('.btn-primary'); // ä¿å­˜ãƒœã‚¿ãƒ³ã‚’ã‚ˆã‚Šæ­£ç¢ºã«ç‰¹å®š
        const originalButtonHtml = saveButton.innerHTML;

        const content = textarea.value;
        const filename = textarea.dataset.filename; // data-filenameå±æ€§ã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«åã‚’å–å¾—

        // ãƒœã‚¿ãƒ³ã‚’ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã«ã™ã‚‹
        saveButton.disabled = true;
        saveButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> ä¿å­˜ä¸­...';

        try {
            const response = await fetch(`/api/prompts/${promptKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ content: content })
            });

            const result = await response.json();
            if (!response.ok) {
                throw new Error(result.error || 'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            }
            showToast('ä¿å­˜å®Œäº†', result.message, 'success');
        } catch (error) {
            showToast('ã‚¨ãƒ©ãƒ¼', error.message, 'danger');
        } finally {
            // ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’å…ƒã«æˆ»ã™
            saveButton.disabled = false;
            saveButton.innerHTML = originalButtonHtml;
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        const tabsContainer = document.getElementById('promptTabs');
        const contentContainer = document.getElementById('promptTabContent');
        const loadingIndicator = document.getElementById('loading-indicator');

        fetch('/api/prompts')
            .then(response => response.json())
            .then(data => {
                // â˜…â˜…â˜… ãƒ­ã‚°å‡ºåŠ›è¿½åŠ  â˜…â˜…â˜…
                console.log("[/api/prompts] ã‹ã‚‰å—ã‘å–ã£ãŸãƒ‡ãƒ¼ã‚¿:", JSON.parse(JSON.stringify(data)));

                loadingIndicator.remove(); // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºã‚’å‰Šé™¤
                if (data.error) {
                    throw new Error(data.error);
                }

                let isFirst = true;
                for (const key in data) {
                    const prompt = data[key]; // promptã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å–å¾—
                    const activeClass = isFirst ? 'active' : '';
                    const showClass = isFirst ? 'show' : '';

                    // ã‚¿ãƒ–ã®ãƒªãƒ³ã‚¯éƒ¨åˆ†ã‚’ç”Ÿæˆ
                    const tabHtml = `
                        <li class="nav-item" role="presentation">
                            <button class="nav-link ${activeClass}" id="${key}-tab" data-bs-toggle="tab" data-bs-target="#${key}-pane" type="button" role="tab" aria-controls="${key}-pane" aria-selected="${isFirst}">${prompt.name_ja}</button>
                        </li>
                    `;
                    tabsContainer.innerHTML += tabHtml;

                    // ã‚¿ãƒ–ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„éƒ¨åˆ†ã‚’ç”Ÿæˆ
                    const contentHtml = `
                        <div class="tab-pane fade ${showClass} ${activeClass}" id="${key}-pane" role="tabpanel" aria-labelledby="${key}-tab" tabindex="0" style="min-height: 75vh;">
                            <div class="card h-100 d-flex flex-column" id="prompt-card-${key}">
                                <div class="card-header d-flex justify-content-between align-items-center flex-wrap">
                                    <p class="text-muted small mb-0 me-3">${prompt.description}</p>
                                    <div class="d-flex align-items-center gap-2">
                                        <div class="dropdown">
                                            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="profileMenuButton-${key}" data-bs-toggle="dropdown" aria-expanded="false">
                                                <i class="bi bi-collection-fill me-1"></i>ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«
                                            </button>
                                            <div class="dropdown-menu p-3" aria-labelledby="profileMenuButton-${key}" style="min-width: 400px;">
                                                <div class="mb-3">
                                                    <label for="profile-select-${key}" class="form-label small">ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦èª­ã¿è¾¼ã¿</label>
                                                    <div class="input-group">
                                                        <select id="profile-select-${key}" class="form-select form-select-sm"></select>
                                                        <button class="btn btn-sm btn-primary" onclick="loadProfile('${key}')"><span class="d-none d-md-inline">èª­è¾¼</span><i class="bi bi-box-arrow-in-down d-inline d-md-none"></i></button>
                                                        <button class="btn btn-sm btn-danger" onclick="deleteProfile('${key}')"><span class="d-none d-md-inline">å‰Šé™¤</span><i class="bi bi-trash d-inline d-md-none"></i></button>
                                                    </div>
                                                </div>
                                                <hr>
                                                <div>
                                                    <label for="new-profile-name-${key}" class="form-label small">ç¾åœ¨ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’åå‰ã‚’ä»˜ã‘ã¦ä¿å­˜</label>
                                                    <div class="input-group">
                                                        <input type="text" id="new-profile-name-${key}" class="form-control form-control-sm" placeholder="ä¾‹: å¯¾è©±é‡è¦–ã‚³ãƒ¡ãƒ³ãƒˆç”¨">
                                                        <button class="btn btn-sm btn-success" onclick="saveProfile('${key}')"><span class="d-none d-md-inline">ä¿å­˜</span><i class="bi bi-save d-inline d-md-none"></i></button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <button class="btn btn-sm btn-info" onclick="openTestModal('${key}')">
                                            <i class="bi bi-play-circle me-1"></i><span class="d-none d-md-inline">ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</span>
                                        </button>
                                        <button class="btn btn-sm btn-primary" onclick="savePrompt('${key}')"><i class="bi bi-floppy-fill me-1"></i>ä¿å­˜</button>
                                    </div>
                                </div>
                                <div class="card-body flex-grow-1 d-flex flex-column">
                                    <textarea class="form-control prompt-textarea flex-grow-1" data-filename="${prompt.filename}">${prompt.content}</textarea>
                                </div>
                            </div>
                        </div>
                    `;
                    contentContainer.innerHTML += contentHtml;
                    isFirst = false;
                }

                // å„ã‚¿ãƒ–ã®ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
                Object.keys(data).forEach(key => fetchProfiles(key));

                // ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ç”Ÿæˆ
                testPromptModal = new bootstrap.Modal(document.getElementById('testPromptModal'));
            })
            .catch(error => {
                contentContainer.innerHTML = `<div class="alert alert-danger">${error.message}</div>`;
            });

        // --- ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã®ãƒ•ã‚©ãƒ¼ã‚«ã‚¹å‡¦ç† ---
        // CSSã§ã®åˆ¶å¾¡ãŒåŠ¹ã‹ãªã„ãŸã‚ã€JavaScriptã§ç›´æ¥ã‚¹ã‚¿ã‚¤ãƒ«ã‚’æ“ä½œã—ã¾ã™ã€‚
        contentContainer.addEventListener('focusin', function(event) {
            // ã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºç”Ÿã—ãŸè¦ç´ ãŒ .prompt-textarea ã‹ã©ã†ã‹ã‚’ç¢ºèª
            if (event.target.matches('.prompt-textarea')) {
                const textarea = event.target;
                textarea.style.transition = 'min-height 0.2s ease-in-out';
                textarea.style.minHeight = '500px';
                textarea.style.flexGrow = '0'; // flex-growã‚’ç„¡åŠ¹åŒ–
            }
        });

        contentContainer.addEventListener('focusout', function(event) {
            // ã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºç”Ÿã—ãŸè¦ç´ ãŒ .prompt-textarea ã‹ã©ã†ã‹ã‚’ç¢ºèª
            if (event.target.matches('.prompt-textarea')) {
                const textarea = event.target;
                textarea.style.minHeight = ''; // å…ƒã®é«˜ã•ã«æˆ»ã™
                textarea.style.flexGrow = ''; // å…ƒã®flex-growã«æˆ»ã™
            }
        });
    });

    function openTestModal(promptKey) {
        // â˜…â˜…â˜… ãƒ­ã‚°å‡ºåŠ›è¿½åŠ  â˜…â˜…â˜…
        console.log(`[openTestModal] å‘¼ã³å‡ºã—æ™‚ã® promptKey: '${promptKey}'`);

        // ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã®éè¡¨ç¤ºãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ç¾åœ¨ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚­ãƒ¼ã‚’ä¿å­˜
        document.getElementById('test-prompt-key-hidden').value = promptKey;

        // ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿å…¥åŠ›æ¬„ã«ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’è¨­å®š
        const testDataInput = document.getElementById('test-data-input');
        testDataInput.value = sampleData[promptKey] || sampleData['default'];

        // çµæœè¡¨ç¤ºæ¬„ã‚’ã‚¯ãƒªã‚¢
        document.getElementById('test-result-output').textContent = 'ã“ã“ã«çµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚';

        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
        testPromptModal.show();
    }

    async function runPromptTest() {
        const runButton = document.getElementById('run-test-btn');
        const spinner = runButton.querySelector('.spinner-border');
        const resultOutput = document.getElementById('test-result-output');

        const promptKey = document.getElementById('test-prompt-key-hidden').value;
        const promptContent = document.querySelector(`#prompt-card-${promptKey} textarea`).value;
        const testDataString = document.getElementById('test-data-input').value;

        let testData;
        try {
            testData = JSON.parse(testDataString);
        } catch (e) {
            resultOutput.textContent = `ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã®JSONå½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚\n\nã‚¨ãƒ©ãƒ¼: ${e.message}`;
            return;
        }

        // ãƒœã‚¿ãƒ³ã‚’ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã«
        runButton.disabled = true;
        spinner.classList.remove('d-none');
        resultOutput.textContent = 'AIãŒç”Ÿæˆä¸­ã§ã™...';

        try {
            const response = await fetch('/api/prompts/test', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ prompt_key: promptKey, prompt_content: promptContent, test_data: testData })
            });
            const result = await response.json();
            if (!response.ok) throw new Error(result.detail || 'ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            resultOutput.textContent = JSON.stringify(result, null, 2);
        } catch (error) {
            resultOutput.textContent = `ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:\n\n${error.message}`;
        } finally {
            runButton.disabled = false;
            spinner.classList.add('d-none');
        }
    }
    // --- ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ç®¡ç†ç”¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆ ---

    async function fetchProfiles(promptKey) {
        try {
            const response = await fetch(`/api/prompt-profiles/${promptKey}`);
            const profiles = await response.json();
            const select = document.getElementById(`profile-select-${promptKey}`);
            select.innerHTML = '<option value="">-- ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ --</option>';
            profiles.forEach(p => {
                const option = document.createElement('option');
                option.value = p;
                option.textContent = p;
                select.appendChild(option);
            });
        } catch (error) {
            console.error('Failed to fetch profiles:', error);
        }
    }

    async function loadProfile(promptKey) {
        const select = document.getElementById(`profile-select-${promptKey}`);
        const profileName = select.value;
        if (!profileName) {
            alert('èª­ã¿è¾¼ã‚€ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
            return;
        }
        if (!confirm(`ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã€Œ${profileName}ã€ã‚’èª­ã¿è¾¼ã¿ã¾ã™ã‹ï¼Ÿ\nç¾åœ¨ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚`)) return;

        try {
            const response = await fetch(`/api/prompt-profiles/${promptKey}/${profileName}`, { method: 'PUT' });
            const result = await response.json();
            if (!response.ok) throw new Error(result.error);
            alert(result.message);
            location.reload(); // ç”»é¢ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦å¤‰æ›´ã‚’åæ˜ 
        } catch (error) {
            alert(`ã‚¨ãƒ©ãƒ¼: ${error.message}`);
        }
    }

    async function saveProfile(promptKey) {
        const input = document.getElementById(`new-profile-name-${promptKey}`);
        const profileName = input.value.trim();
        if (!profileName) {
            alert('ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
            return;
        }
        if (!confirm(`ç¾åœ¨ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ã€Œ${profileName}ã€ã¨ã—ã¦ä¿å­˜ã—ã¾ã™ã‹ï¼Ÿ`)) return;

        try {
            const response = await fetch(`/api/prompt-profiles/${promptKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ profile_name: profileName })
            });
            const result = await response.json();
            if (!response.ok) throw new Error(result.error);
            alert(result.message);
            input.value = '';
            await fetchProfiles(promptKey); // ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚’æ›´æ–°
        } catch (error) {
            alert(`ã‚¨ãƒ©ãƒ¼: ${error.message}`);
        }
    }

    async function deleteProfile(promptKey) {
        const select = document.getElementById(`profile-select-${promptKey}`);
        const profileName = select.value;
        if (!profileName) {
            alert('å‰Šé™¤ã™ã‚‹ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
            return;
        }
        if (!confirm(`æœ¬å½“ã«ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã€Œ${profileName}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚`)) return;

        try {
            const response = await fetch(`/api/prompt-profiles/${promptKey}/${profileName}`, { method: 'DELETE' });
            const result = await response.json();
            if (!response.ok) throw new Error(result.error);
            alert(result.message);
            await fetchProfiles(promptKey); // ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚’æ›´æ–°
        } catch (error) {
            alert(`ã‚¨ãƒ©ãƒ¼: ${error.message}`);
        }
    }
</script>
{% endblock %}