{% extends "base.html" %}

{% block title %}ログ確認 - R-Auto Control Panel{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">ログ確認</h1>
</div>

<!-- 期間指定フィルター -->
<div class="row g-2 align-items-center mb-3">
    <div class="col-auto">
        <label for="start-datetime" class="col-form-label">開始日時</label>
    </div>
    <div class="col-auto">
        <input type="datetime-local" id="start-datetime" class="form-control form-control-sm">
    </div>
    <div class="col-auto">
        <label for="end-datetime" class="col-form-label">終了日時</label>
    </div>
    <div class="col-auto">
        <input type="datetime-local" id="end-datetime" class="form-control form-control-sm">
    </div>
    <div class="col-auto">
        <button class="btn btn-sm btn-primary" id="filter-btn">表示</button>
        <button class="btn btn-sm btn-outline-secondary" id="reset-btn">リセット</button>
    </div>
</div>

<div id="log-container" class="bg-dark text-light p-3 rounded" style="height: 70vh; overflow-y: auto; font-family: monospace; white-space: pre-wrap; word-wrap: break-word; font-size: 0.8rem;">
    <p>ログを読み込んでいます...</p>
</div>

<!-- フローティングコントロール -->
<div id="floating-controls" class="p-2 bg-light border rounded-pill shadow-sm">
    <div class="form-check form-switch d-inline-block me-2 align-middle">
        <input class="form-check-input" type="checkbox" role="switch" id="auto-scroll-switch">
        <label class="form-check-label" for="auto-scroll-switch">自動スクロール</label>
    </div>
    <button type="button" class="btn btn-sm btn-outline-secondary rounded-circle" id="refresh-btn" title="手動で更新" style="width: 32px; height: 32px; line-height: 1;">
        <i class="bi bi-arrow-clockwise"></i>
    </button>
</div>

<!-- 画面右下に表示する「一番上に戻る」ボタン -->
<button type="button" class="btn btn-primary rounded-circle" id="scroll-to-top-btn" title="一番上に戻る">
    <i class="bi bi-arrow-up"></i>
</button>
{% endblock %}

{% block styles %}
<style>
    #scroll-to-top-btn {
        position: fixed;
        bottom: 20px;
        right: 20px;
        display: none; /* 最初は非表示 */
        width: 50px;
        height: 50px;
        font-size: 1.5rem;
        z-index: 1050; /* トースト通知より手前に表示 */
    }
    #floating-controls {
        position: fixed;
        top: 80px; /* ヘッダーの高さに応じて調整 */
        right: 20px;
        z-index: 1000; /* navbar(1030)より低い値に設定 */
        display: flex;
        align-items: center;
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const logContainer = document.getElementById('log-container');
        const refreshBtn = document.getElementById('refresh-btn');
        const scrollToTopBtn = document.getElementById('scroll-to-top-btn');
        const autoScrollSwitch = document.getElementById('auto-scroll-switch');
        const startDatetimeInput = document.getElementById('start-datetime');
        const endDatetimeInput = document.getElementById('end-datetime');
        const filterBtn = document.getElementById('filter-btn');
        const resetBtn = document.getElementById('reset-btn');
        let refreshIntervalId = null;

        function setDefaultDateTimes() {
            const now = new Date();
            const year = now.getFullYear();
            const month = (now.getMonth() + 1).toString().padStart(2, '0');
            const day = now.getDate().toString().padStart(2, '0');

            const todayStart = `${year}-${month}-${day}T00:00`;
            const todayEnd = `${year}-${month}-${day}T23:59`;

            startDatetimeInput.value = todayStart;
            endDatetimeInput.value = todayEnd;
        }

        async function fetchLogs(applyFilter = true) {
            try {
                const start = startDatetimeInput.value;
                const end = endDatetimeInput.value;
                let url = '/api/logs';
                const params = new URLSearchParams();
                if (start) {
                    params.append('start', start);
                }
                if (end) {
                    params.append('end', end);
                }
                if (applyFilter && params.toString()) {
                    url += `?${params.toString()}`;
                }

                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`サーバーエラー: ${response.status}`);
                }
                const logText = await response.text();
                logContainer.textContent = logText;

                // 自動スクロールが有効な場合、一番下までスクロール
                if (autoScrollSwitch.checked) {
                    logContainer.scrollTop = logContainer.scrollHeight;
                }

                // ★追加: ログ更新後にもボタンの表示状態をチェックする
                if (logContainer.scrollTop > 200) {
                    scrollToTopBtn.style.display = 'block';
                } else {
                    scrollToTopBtn.style.display = 'none';
                }
            } catch (error) {
                logContainer.textContent = `ログの取得に失敗しました: ${error.message}`;
                console.error(error);
            }
        }

        function startAutoRefresh() {
            if (refreshIntervalId === null) {
                refreshIntervalId = setInterval(() => fetchLogs(false), 5000); // 5秒ごとにフィルターなしで更新
                console.log("自動更新を開始しました。");
            }
        }

        function stopAutoRefresh() {
            if (refreshIntervalId !== null) {
                clearInterval(refreshIntervalId);
                refreshIntervalId = null;
                console.log("自動更新を停止しました。");
            }
        }

        // 更新ボタンのクリックイベント
        refreshBtn.addEventListener('click', () => {
            // 手動更新時はフィルターを適用しない
            fetchLogs(false);
        });

        // フィルターボタンのクリックイベント
        filterBtn.addEventListener('click', () => {
            // 期間指定した場合は自動スクロールと自動更新をオフにする
            if (autoScrollSwitch.checked) {
                autoScrollSwitch.click();
            }
            fetchLogs(true); // フィルターを適用してログを取得
        });

        // リセットボタンのクリックイベント
        resetBtn.addEventListener('click', () => {
            // 日時入力欄を当日の範囲にリセットする
            setDefaultDateTimes();
            fetchLogs(false); // リセット時はフィルターを適用しない
        });
        // 自動スクロールスイッチのイベント
        autoScrollSwitch.addEventListener('change', function() {
            if (this.checked) {
                logContainer.scrollTop = logContainer.scrollHeight; // ONにしたらまず一番下へ
                // フィルター関連のUIを無効化
                startDatetimeInput.disabled = true;
                endDatetimeInput.disabled = true;
                filterBtn.disabled = true;
                startAutoRefresh(); // 自動更新を開始
            } else {
                // フィルター関連のUIを有効化
                startDatetimeInput.disabled = false;
                endDatetimeInput.disabled = false;
                filterBtn.disabled = false;
                stopAutoRefresh(); // 自動更新を停止
            }
        });

        // 一番上に戻るボタンのクリックイベント
        scrollToTopBtn.addEventListener('click', function() {
            logContainer.scrollTop = 0; // 一番上にスクロール
            autoScrollSwitch.checked = false; // 自動スクロールをオフにする
            stopAutoRefresh(); // 自動更新も停止
        });

        // ログコンテナのスクロールイベント
        logContainer.addEventListener('scroll', function() {
            if (logContainer.scrollTop > 200) { // 200px以上スクロールしたら表示
                scrollToTopBtn.style.display = 'block';
            } else {
                scrollToTopBtn.style.display = 'none';
            }

            // ユーザーが手動で上にスクロールしたら自動スクロールをオフにする
            // (一番下から少しでもスクロールアップされたら)
            const isScrolledToBottom = logContainer.scrollHeight - logContainer.clientHeight <= logContainer.scrollTop + 1;
            if (!isScrolledToBottom && autoScrollSwitch.checked) {
                autoScrollSwitch.click(); // changeイベントを発火させて停止処理を呼び出す
            }
        });

        // ページ読み込み時に一度だけログを取得し、一番下にスクロールする
        (async () => {
            setDefaultDateTimes(); // デフォルトの日時を設定
            // 初回はフィルターを適用せずに全ログを取得
            await fetchLogs(false);
            // 初回読み込み時のみ、一番下までスクロール
            logContainer.scrollTop = logContainer.scrollHeight;
        })();
    });
</script>
{% endblock %}