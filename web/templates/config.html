{% extends "base.html" %}

{% block title %}システムコンフィグ - {{ super() }}{% endblock %}
{% block styles %}
<style>
    .form-check-input {
        width: 3em;
        height: 1.5em;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <!-- 一般設定カード -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-sliders me-2"></i>一般設定</h5>
            </div>
            <div class="card-body">
                <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" role="switch" id="headless-switch">
                    <label class="form-check-label" for="headless-switch">Playwright ヘッドレスモード</label>
                    <small class="form-text text-muted d-block">ONにするとブラウザを非表示で実行します（本番用）。OFFにするとブラウザが表示され、VNCで動作を確認できます（デバッグ用）。</small>
                </div>
                <div class="mb-3">
                    <label for="procurement-method" class="form-label">
                        <i class="bi bi-tools me-1"></i>商品調達方法
                        <i class="bi bi-info-circle" data-bs-toggle="tooltip" data-bs-placement="top" title="商品を調達する方法を選択します。楽天APIは未実装です。"></i>
                    </label>
                    <select class="form-select" id="procurement-method">
                        <option value="rakuten_search">楽天市場の検索 (ブラウザ)</option>
                        <option value="rakuten_api">楽天API (ダミー)</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="caption-creation-method" class="form-label">
                        <i class="bi bi-robot me-1"></i>投稿文の生成方法
                        <i class="bi bi-info-circle" data-bs-toggle="tooltip" data-bs-placement="top" title="投稿文を生成する方法を選択します。API方式が推奨されます。"></i>
                    </label>
                    <select class="form-select" id="caption-creation-method">
                        <option value="api">Gemini API (推奨)</option>
                        <option value="browser">ブラウザ操作 (旧方式)</option>
                    </select>
                    <div class="form-text">
                        API方式は高速で安定していますが、APIキーの設定が必要です。ブラウザ操作は設定不要ですが、動作が不安定になることがあります。
                    </div>
                </div>

                <button class="btn btn-primary" onclick="saveGlobalConfig()">
                    <i class="bi bi-save me-1"></i> 設定を保存
                </button>

                <hr class="my-4">

                <div class="d-flex justify-content-start align-items-center gap-2">
                    <button class="btn btn-sm btn-info" onclick="runTaskNow('check-login-status', 'ログイン状態チェック', event)">
                        <i class="bi bi-person-check-fill"></i> ログイン状態チェック
                    </button>
                    <button class="btn btn-sm btn-secondary" onclick="runTaskNow('save-auth-state', '認証状態の保存', event)">
                        <i class="bi bi-shield-lock-fill"></i> 認証状態の保存
                    </button>
                    <button class="btn btn-sm btn-warning" onclick="runTaskNow('restore-auth-state', '認証プロファイルの復元', event)">
                        <i class="bi bi-shield-exclamation"></i> 認証プロファイルの復元
                    </button>
                </div>
                <small class="form-text text-muted d-block mt-2">
                    「認証状態の保存」はVNC経由で手動ログインが必要です。<br>
                    「ログイン状態チェック」で現在の認証が有効か確認できます。<br>
                    「認証プロファイルの復元」は、ログインが切れた際にバックアップから認証情報を復元します。
                </small>
            </div>
        </div>

        <!-- シングルタスクカード -->
        <div class="card mb-4">
            <div class="card-header">
                <i class="bi bi-lightning-charge-fill me-2"></i>シングルタスク
            </div>
            <div class="card-body">
                <p class="card-text">フローに含まれる各タスクを個別に実行できます。</p>
                <div id="single-tasks-container" class="list-group">
                    <!-- シングルタスクはJavaScriptでここに挿入されます -->
                </div>
            </div>
        </div>

        <!-- その他のシステムタスクカード -->
        <div class="card">
            <div class="card-header"><i class="bi bi-tools me-2"></i>その他のシステムタスク</div>
            <div class="card-body">
                <p class="card-text">ここでは、開発やデバッグ目的のタスクを手動で実行できます。</p>
                <div id="debug-tasks-container" class="list-group">
                    <!-- デバッグタスクはJavaScriptでここに挿入されます -->
                </div>
            </div>
        </div>

        <!-- 危険な操作カード -->
        <div class="card mt-4 border-danger">
            <div class="card-header bg-danger text-white">
                <h5 class="mb-0"><i class="bi bi-exclamation-triangle-fill me-2"></i>危険な操作</h5>
            </div>
            <div class="card-body">
                <h6 class="card-title">全商品データの削除</h6>
                <p class="card-text">データベースからすべての商品情報を削除します。この操作は元に戻せません。<br>実行するには、以下のボックスに「<strong class="text-danger">削除します</strong>」と入力してください。</p>
                <div class="row g-2 align-items-center">
                    <div class="col-sm-4">
                        <input type="text" id="delete-confirm-input" class="form-control" placeholder="削除します" oninput="validateDeleteInput()">
                    </div>
                    <div class="col-sm-8">
                        <button id="delete-all-btn" class="btn btn-danger" onclick="deleteAllProducts()" disabled>
                            <i class="bi bi-trash-fill me-1"></i> 全商品データを削除
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    async function fetchGlobalConfig() {
        try {
            const response = await fetch('/api/config');
            const config = await response.json();
            document.getElementById('headless-switch').checked = config.playwright_headless;
            document.getElementById('procurement-method').value = config.procurement_method || 'rakuten_search';
            document.getElementById('caption-creation-method').value = config.caption_creation_method || 'api';
        } catch (error) {
            console.error('Failed to fetch global config:', error);
            // alert(error.message);
        }
    }

    async function saveGlobalConfig() {
        const isHeadless = document.getElementById('headless-switch').checked;

        const payload = {
            playwright_headless: isHeadless,
            procurement_method: document.getElementById('procurement-method').value,
            caption_creation_method: document.getElementById('caption-creation-method').value,
        };

        try {
            const response = await fetch('/api/config', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const result = await response.json();
            if (!response.ok) {
                throw new Error(result.message || '設定の保存に失敗しました。');
            }
            alert('設定を保存しました。');
        } catch (error) {
            console.error('Error saving global config:', error);
            alert(error.message);
        }
    }

    async function fetchDebugTasks() {
        try {
            const response = await fetch('/api/config-tasks');
            const tasks = await response.json();
            const singleTaskContainer = document.getElementById('single-tasks-container');
            const debugTaskContainer = document.getElementById('debug-tasks-container');
            singleTaskContainer.innerHTML = '';
            debugTaskContainer.innerHTML = '';

            const singleTaskIds = [
                'procure-products-single', // 新しい単体タスク
                'get-post-url',
                'create-caption-flow', // 統合されたタスク
            ];

            tasks.forEach(task => {
                // ログインチェックと認証保存は一般設定に移動したので除外
                if (task.tag === 'check-login-status' || task.tag === 'save-auth-state' || task.tag === 'restore-auth-state') return;

                const taskItem = document.createElement('div');
                taskItem.className = 'list-group-item d-flex justify-content-between align-items-center';
                taskItem.innerHTML = `
                    <div>
                        <h5 class="mb-1">${task.name_ja}</h5>
                        <p class="mb-1 small text-muted">${task.description || ''}</p>
                    </div>
                    <button class="btn btn-sm btn-info" onclick="runTaskNow('${task.tag}', '${task.name_ja}', event)">
                        <i class="bi bi-play-fill"></i> 即時実行
                    </button>
                `;

                if (singleTaskIds.includes(task.tag)) {
                    singleTaskContainer.appendChild(taskItem);
                } else {
                    debugTaskContainer.appendChild(taskItem);
                }
            });
        } catch (error) {
            console.error('Failed to fetch debug tasks:', error);
        }
    }

    async function runTaskNow(tag, name_ja, event) {
        let confirmMessage = `タスク「${name_ja}」を今すぐ実行しますか？`;
        if (tag === 'save-auth-state') {
            const hostname = window.location.hostname; // 現在アクセスしているホスト名を取得
            confirmMessage += `\n\n【必要な手動操作】\n1. VNCクライアントで ${hostname}:5900 に接続します。\n2. 表示されたブラウザでログイン操作を行います。\n3. ログインが完了したら、ブラウザのウィンドウを閉じてください。`;
        }

        if (!confirm(confirmMessage)) {
            return;
        }
        try {
            const response = await fetch(`/api/tasks/${tag}/run`, {
                method: 'POST'
            });
            const result = await response.json();
            // response.ok (HTTPステータスが200-299) かどうかで成否を判断する
            if (!response.ok) {
                throw new Error(result.message || 'タスクの実行に失敗しました。');
            }
            alert(result.message);
        } catch (error) {
            console.error('Error running task:', error);
            alert(error.message);
        }
    }

    function validateDeleteInput() {
        const input = document.getElementById('delete-confirm-input');
        const button = document.getElementById('delete-all-btn');
        // 入力値が「削除します」と完全に一致する場合のみボタンを有効化
        if (input.value === '削除します') {
            button.disabled = false;
        } else {
            button.disabled = true;
        }
    }

    async function deleteAllProducts() {
        if (!confirm('本当によろしいですか？すべての商品データがデータベースから削除されます。')) {
            return;
        }

        try {
            const response = await fetch('/api/products/delete-all', {
                method: 'POST'
            });
            const result = await response.json();
            if (!response.ok) {
                throw new Error(result.message || '削除に失敗しました。');
            }
            alert(result.message);
            // 入力欄をクリアしてボタンを再度無効化
            document.getElementById('delete-confirm-input').value = '';
            validateDeleteInput();

        } catch (error) {
            console.error('Error deleting all products:', error);
            alert(error.message);
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        fetchDebugTasks();
        fetchGlobalConfig();
    });
</script>
{% endblock %}