{% extends "base.html" %}

{% block title %}システムコンフィグ - {{ super() }}{% endblock %}
{% block styles %}
<style>
    .form-check-input {
        width: 3em;
        height: 1.5em;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <!-- 一般設定カード -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-sliders me-2"></i>一般設定</h5>
            </div>
            <div class="card-body">
                <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" role="switch" id="headless-switch">
                    <label class="form-check-label" for="headless-switch">Playwright ヘッドレスモード</label>
                    <small class="form-text text-muted d-block">ONにするとブラウザを非表示で実行します（本番用）。OFFにするとブラウザが表示され、VNCで動作を確認できます（デバッグ用）。</small>
                </div>
                <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" role="switch" id="debug-screenshot-switch">
                    <label class="form-check-label" for="debug-screenshot-switch">デバッグ用スクリーンショット撮影を有効にする</label>
                    <small class="form-text text-muted d-block">ONにするとタスクの特定の箇所で動作確認用のスクリーンショットを撮影します。問題発生時の調査に役立ちますが、通常はOFFを推奨します。</small>
                </div>
                <div class="mb-3">
                    <label for="procurement-method" class="form-label">
                        <i class="bi bi-tools me-1"></i>商品調達方法
                        <i class="bi bi-info-circle" data-bs-toggle="tooltip" data-bs-placement="top" title="商品を調達する方法を選択します。楽天APIは未実装です。「ユーザーページ巡回」はdb/source_urls.jsonに登録したROOMページから商品を調達します。"></i>
                    </label>
                    <select class="form-select" id="procurement-method">
                        <option value="rakuten_search">楽天市場の検索 (ブラウザ)</option>
                        <option value="rakuten_api">楽天API (ダミー)</option>
                        <option value="user_page_crawl">ユーザーページ巡回調達</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="caption-creation-method" class="form-label">
                        <i class="bi bi-robot me-1"></i>投稿文の生成方法
                        <i class="bi bi-info-circle" data-bs-toggle="tooltip" data-bs-placement="top" title="投稿文を生成する方法を選択します。API方式が推奨されます。"></i>
                    </label>
                    <select class="form-select" id="caption-creation-method">
                        <option value="api">Gemini API (推奨)</option>
                        <option value="browser">ブラウザ操作 (旧方式)</option>
                    </select>
                    <div class="form-text">
                        API方式は高速で安定していますが、APIキーの設定が必要です。ブラウザ操作は設定不要ですが、動作が不安定になることがあります。
                    </div>
                </div>

                <button class="btn btn-primary" onclick="saveGlobalConfig()">
                    <i class="bi bi-save me-1"></i> 設定を保存
                </button>

                <hr class="my-4">

                <div class="mb-3">
                    <label class="form-label">
                        <i class="bi bi-person-bounding-box me-1"></i>優先実行プロファイル
                        <i class="bi bi-info-circle" data-bs-toggle="tooltip" data-bs-placement="top" title="タスク実行時に優先して使用する認証プロファイルを選択します。プライマリでログインリダイレクトが発生した場合、自動的にもう一方に切り替わります。"></i>
                    </label>
                    <div class="btn-group" role="group" aria-label="Preferred profile toggle">
                        <input type="radio" class="btn-check" name="preferredProfile" id="profile-primary" value="primary" autocomplete="off">
                        <label class="btn btn-outline-primary" for="profile-primary">プライマリ (通常)</label>

                        <input type="radio" class="btn-check" name="preferredProfile" id="profile-secondary" value="secondary" autocomplete="off">
                        <label class="btn btn-outline-primary" for="profile-secondary">セカンダリ (予備)</label>
                    </div>
                </div>

                <div class="d-flex justify-content-start align-items-center gap-2">
                    <button class="btn btn-sm btn-info" onclick="runTaskNow('check-login-status', 'ログイン状態チェック', event)">
                        <i class="bi bi-person-check-fill"></i> ログイン状態チェック
                    </button>
                    <button class="btn btn-sm btn-secondary" onclick="runTaskNow('save-auth-state', '認証状態の保存', event)">
                        <i class="bi bi-shield-lock-fill"></i> 認証状態の保存
                    </button>
                    <button class="btn btn-sm btn-warning" onclick="runTaskNow('restore-auth-state', '認証プロファイルの復元', event)">
                        <i class="bi bi-shield-exclamation"></i> 認証プロファイルの復元
                    </button>
                </div>
                <small class="form-text text-muted d-block mt-2">
                    「認証状態の保存」はVNC経由で手動ログインが必要です。<br>
                    「ログイン状態チェック」で現在の認証が有効か確認できます。<br>
                    「認証プロファイルの復元」は、ログインが切れた際にバックアップから認証情報を復元します。
                </small>
            </div>
        </div>

        <!-- データベース管理カード -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-database-gear me-2"></i>データベース管理</h5>
            </div>
            <div class="card-body">
                <div class="accordion" id="dbAccordion">
                    <!-- エクスポート -->
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingExport">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseExport" aria-expanded="false" aria-controls="collapseExport">
                                エクスポート (SQL形式)
                            </button>
                        </h2>
                        <div id="collapseExport" class="accordion-collapse collapse" aria-labelledby="headingExport" data-bs-parent="#dbAccordion">
                            <div class="accordion-body">
                                <p class="text-muted small">エクスポートしたいテーブルを選択してください。</p>
                                <div id="db-tables-container" class="mb-3">
                                    <!-- テーブル一覧がここに挿入されます -->
                                </div>
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="include-delete-switch">
                                    <label class="form-check-label" for="include-delete-switch">
                                        <i class="bi bi-info-circle me-1" data-bs-toggle="tooltip" title="インポート時に既存のデータをすべて削除してから新しいデータを挿入する場合にチェックします。"></i>
                                        DELETE文を含める (データを全削除)
                                    </label>
                                </div>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-info" onclick="exportDb()"><i class="bi bi-box-arrow-down me-1"></i>テーブル選択エクスポート</button>
                                    <button class="btn btn-success" onclick="exportReusableProducts()"><i class="bi bi-recycle me-1"></i>再利用品エクスポート</button>
                                </div>
                                <hr>
                                <textarea id="sql-export-output" class="form-control" rows="10" readonly placeholder="ここにSQLが出力されます"></textarea>
                                <button class="btn btn-sm btn-outline-secondary mt-2" onclick="copySqlOutput()"><i class="bi bi-clipboard me-1"></i>クリップボードにコピー</button>
                            </div>
                        </div>
                    </div>
                    <!-- インポート -->
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingImport">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseImport" aria-expanded="false" aria-controls="collapseImport">
                                インポート (SQL実行)
                            </button>
                        </h2>
                        <div id="collapseImport" class="accordion-collapse collapse" aria-labelledby="headingImport" data-bs-parent="#dbAccordion">
                            <div class="accordion-body">
                                <p class="text-muted small">ここに実行したいSQLクエリを貼り付けてください。複数のクエリも実行可能です。</p>
                                <textarea id="sql-import-input" class="form-control" rows="10" placeholder="-- 例: UPDATE products SET status = '投稿済' WHERE id = 1;"></textarea>
                                <button class="btn btn-warning mt-3" onclick="importDb()">
                                    <i class="bi bi-play-fill me-1"></i>SQLを実行
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- シングルタスクカード -->
        <div class="card mb-4">
            <div class="card-header">
                <i class="bi bi-lightning-charge-fill me-2"></i>シングルタスク
            </div>
            <div class="card-body">
                <p class="card-text">フローに含まれる各タスクを個別に実行できます。</p>
                <div id="single-tasks-container" class="list-group">
                    <!-- シングルタスクはJavaScriptでここに挿入されます -->
                </div>
            </div>
        </div>

        <!-- その他のシステムタスクカード -->
        <div class="card">
            <div class="card-header"><i class="bi bi-tools me-2"></i>その他のシステムタスク</div>
            <div class="card-body">
                <p class="card-text">ここでは、開発やデバッグ目的のタスクを手動で実行できます。</p>
                <div id="debug-tasks-container" class="list-group">
                    <!-- デバッグタスクはJavaScriptでここに挿入されます -->
                </div>
            </div>
        </div>

        <!-- 危険な操作カード -->
        <div class="card mt-4 border-danger">
            <div class="card-header bg-danger text-white">
                <h5 class="mb-0"><i class="bi bi-exclamation-triangle-fill me-2"></i>危険な操作</h5>
            </div>
            <div class="card-body">
                <h6 class="card-title">全商品データの削除</h6>
                <p class="card-text">データベースからすべての商品情報を削除します。この操作は元に戻せません。<br>実行するには、以下のボックスに「<strong class="text-danger">削除します</strong>」と入力してください。</p>
                <div class="row g-2 align-items-center">
                    <div class="col-sm-4">
                        <input type="text" id="delete-confirm-input" class="form-control" placeholder="削除します" oninput="validateDeleteInput()">
                    </div>
                    <div class="col-sm-8">
                        <button id="delete-all-btn" class="btn btn-danger" onclick="deleteAllProducts()" disabled>
                            <i class="bi bi-trash-fill me-1"></i> 全商品データを削除
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Tooltipの初期化
    const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
    const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl));

    async function fetchGlobalConfig() {
        try {
            const response = await fetch('/api/config');
            const config = await response.json();
            console.log('[Config] APIから取得した設定:', config);
            document.getElementById('headless-switch').checked = config.playwright_headless;
            document.getElementById('debug-screenshot-switch').checked = config.debug_screenshot_enabled;
            document.getElementById('procurement-method').value = config.procurement_method || 'rakuten_search';
            // 優先プロファイル設定の読み込み
            const preferredProfile = config.preferred_profile || 'primary';
            if (document.getElementById(`profile-${preferredProfile}`)) {
                document.getElementById(`profile-${preferredProfile}`).checked = true;
            } else {
                document.getElementById('profile-primary').checked = true; // 不正な値の場合はプライマリをデフォルトに
            }
            document.getElementById('caption-creation-method').value = config.caption_creation_method || 'api';
        } catch (error) {
            console.error('[Config] グローバル設定の取得に失敗しました:', error);
            // alert(error.message);
        }
    }

    async function saveGlobalConfig() {
        const isHeadless = document.getElementById('headless-switch').checked;
        const isDebugScreenshotEnabled = document.getElementById('debug-screenshot-switch').checked;

        const payload = {
            playwright_headless: isHeadless,
            procurement_method: document.getElementById('procurement-method').value,
            caption_creation_method: document.getElementById('caption-creation-method').value,
            debug_screenshot_enabled: isDebugScreenshotEnabled,
        };

        console.log('[Config] 一般設定を保存します:', payload);
        try {
            const response = await fetch('/api/config', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const result = await response.json();
            if (!response.ok) {
                throw new Error(result.message || '設定の保存に失敗しました。');
            }
            showToast('成功', '設定を保存しました。');
        } catch (error) {
            console.error('[Config] 一般設定の保存中にエラー:', error);
            showToast('エラー', error.message, 'danger');
        }
    }

    async function fetchDebugTasks() {
        try {
            const response = await fetch('/api/config-tasks');
            const tasks = await response.json();
            const singleTaskContainer = document.getElementById('single-tasks-container');
            const debugTaskContainer = document.getElementById('debug-tasks-container');
            singleTaskContainer.innerHTML = '';
            debugTaskContainer.innerHTML = '';

            const singleTaskIds = [
                'procure-products-single', // 新しい単体タスク
                'get-post-url',
                'create-caption-flow', // 統合されたタスク
            ];

            tasks.forEach(task => {
                // ログインチェックと認証保存は一般設定に移動したので除外
                if (task.tag === 'check-login-status' || task.tag === 'save-auth-state' || task.tag === 'restore-auth-state') return;

                const taskItem = document.createElement('div');
                taskItem.className = 'list-group-item d-flex justify-content-between align-items-center';
                taskItem.innerHTML = `
                    <div>
                        <h5 class="mb-1">${task.name_ja}</h5>
                        <p class="mb-1 small text-muted">${task.description || ''}</p>
                    </div>
                    <button class="btn btn-sm btn-info" onclick="runTaskNow('${task.tag}', '${task.name_ja}', event)">
                        <i class="bi bi-play-fill"></i> 即時実行
                    </button>
                `;

                if (singleTaskIds.includes(task.tag)) {
                    singleTaskContainer.appendChild(taskItem);
                } else {
                    debugTaskContainer.appendChild(taskItem);
                }
            });
        } catch (error) {
            console.error('Failed to fetch debug tasks:', error);
        }
    }

    async function runTaskNow(tag, name_ja, event) {
        let confirmMessage = `タスク「${name_ja}」を今すぐ実行しますか？`;
        if (tag === 'save-auth-state') {
            const hostname = window.location.hostname; // 現在アクセスしているホスト名を取得
            confirmMessage += `\n\n【必要な手動操作】\n1. VNCクライアントで ${hostname}:5900 に接続します。\n2. 表示されたブラウザでログイン操作を行います。\n3. ログインが完了したら、ブラウザのウィンドウを閉じてください。`;
        }

        if (!confirm(confirmMessage)) {
            return;
        }
        try {
            const response = await fetch(`/api/tasks/${tag}/run`, {
                method: 'POST'
            });
            const result = await response.json();
            // response.ok (HTTPステータスが200-299) かどうかで成否を判断する
            if (!response.ok) {
                throw new Error(result.message || 'タスクの実行に失敗しました。');
            }
            // メッセージに改行が含まれている可能性を考慮
            const messageToShow = result.message.replace(/\\n/g, '\n');
            alert(messageToShow);
        } catch (error) {
            console.error('Error running task:', error);
            alert(error.message);
        }
    }

    function validateDeleteInput() {
        const input = document.getElementById('delete-confirm-input');
        const button = document.getElementById('delete-all-btn');
        // 入力値が「削除します」と完全に一致する場合のみボタンを有効化
        if (input.value === '削除します') {
            button.disabled = false;
        } else {
            button.disabled = true;
        }
    }

    async function deleteAllProducts() {
        if (!confirm('本当によろしいですか？すべての商品データがデータベースから削除されます。')) {
            return;
        }

        try {
            const response = await fetch('/api/products/delete-all', {
                method: 'POST'
            });
            const result = await response.json();
            if (!response.ok) {
                throw new Error(result.message || '削除に失敗しました。');
            }
            alert(result.message);
            // 入力欄をクリアしてボタンを再度無効化
            document.getElementById('delete-confirm-input').value = '';
            validateDeleteInput();

        } catch (error) {
            console.error('Error deleting all products:', error);
            alert(error.message);
        }
    }

    async function fetchDbTables() {
        try {
            const response = await fetch('/api/db/tables');
            const data = await response.json();
            const container = document.getElementById('db-tables-container');
            container.innerHTML = '';
            data.tables.forEach(table => {
                container.innerHTML += `
                    <div class="form-check form-check-inline">
                        <input class="form-check-input db-table-checkbox" type="checkbox" value="${table}" id="table-${table}">
                        <label class="form-check-label" for="table-${table}">${table}</label>
                    </div>
                `;
            });
        } catch (error) {
            console.error('DBテーブル一覧の取得に失敗:', error);
        }
    }

    async function exportDb() {
        const selectedTables = Array.from(document.querySelectorAll('.db-table-checkbox:checked')).map(cb => cb.value);
        if (selectedTables.length === 0) {
            alert('エクスポートするテーブルを1つ以上選択してください。');
            return;
        }
        const includeDelete = document.getElementById('include-delete-switch').checked;
        const outputTextarea = document.getElementById('sql-export-output');
        outputTextarea.value = 'エクスポート中...';

        try {
            const response = await fetch('/api/db/export', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ table_names: selectedTables, include_delete: includeDelete })
            });
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || 'エクスポートに失敗しました。');
            }
            const sqlDump = await response.text();
            outputTextarea.value = sqlDump;
            showToast('成功', 'SQLのエクスポートが完了しました。');
        } catch (error) {
            outputTextarea.value = `エラー: ${error.message}`;
            showToast('エラー', error.message, 'danger');
        }
    }

    function copySqlOutput() {
        const textarea = document.getElementById('sql-export-output');
        if (!textarea.value) return;
        navigator.clipboard.writeText(textarea.value).then(() => {
            showToast('成功', 'クリップボードにコピーしました。');
        }).catch(err => {
            showToast('エラー', 'コピーに失敗しました。', 'danger');
        });
    }

    async function exportReusableProducts() {
        const outputTextarea = document.getElementById('sql-export-output');
        outputTextarea.value = '「再コレ再利用」商品のエクスポート中...';

        if (!confirm('procurement_keywordが「再コレ再利用」の商品を抽出し、INSERT OR REPLACE文を生成します。よろしいですか？')) {
            outputTextarea.value = 'エクスポートがキャンセルされました。';
            return;
        }

        try {
            const response = await fetch('/api/db/export-reusable-products', { method: 'POST' });
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || '再利用可能商品のエクスポートに失敗しました。');
            }
            const sqlDump = await response.text();
            outputTextarea.value = sqlDump;
            showToast('成功', '再利用可能商品のSQLエクスポートが完了しました。');
        } catch (error) {
            outputTextarea.value = `エラー: ${error.message}`;
            showToast('エラー', error.message, 'danger');
        }
    }

    async function importDb() {
        const sqlScript = document.getElementById('sql-import-input').value;
        if (!sqlScript.trim()) {
            alert('実行するSQLクエリを入力してください。');
            return;
        }
        if (!confirm('このSQLクエリを実行しますか？データベースが変更される可能性があります。この操作は元に戻せません。')) {
            return;
        }

        try {
            const response = await fetch('/api/db/import', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ sql_script: sqlScript })
            });
            const result = await response.json();
            if (!response.ok) throw new Error(result.detail || 'SQLの実行に失敗しました。');
            showToast('成功', result.message, 'success');
        } catch (error) {
            showToast('エラー', error.message, 'danger');
        }
    }

    async function savePreferredProfile(profileValue) {
        // この関数は優先プロファイル設定のみを保存する
        const payload = {
            preferred_profile: profileValue
        };

        console.log('[Config] 優先プロファイルを保存します:', payload);
        try {
            const response = await fetch('/api/config', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const result = await response.json();
            if (!response.ok) {
                throw new Error(result.message || '設定の保存に失敗しました。');
            }
            // 成功した場合、trueを返す
            return true;
        } catch (error) {
            console.error('[Config] 優先プロファイルの保存中にエラー:', error);
            // 失敗した場合、エラーをスローする
            throw error;
        }
    }

    function setupProfileToggle() {
        const profileRadios = document.querySelectorAll('input[name="preferredProfile"]');
        let previousProfileValue;

        // ラジオボタンにフォーカスが当たった時に、変更前の値を保持する
        profileRadios.forEach(radio => {
            radio.addEventListener('focus', () => {
                previousProfileValue = document.querySelector('input[name="preferredProfile"]:checked').value;
            });

            // ラジオボタンの値が変更された時に発火
            radio.addEventListener('change', (event) => {
                const newValue = event.target.value;
                const newLabel = document.querySelector(`label[for="${event.target.id}"]`).textContent;

                if (confirm(`優先プロファイルを「${newLabel}」に変更しますか？`)) {
                    // OKが押されたら、設定を保存
                    savePreferredProfile(newValue).then(() => {
                        showToast('成功', '優先プロファイルを更新しました。');
                    }).catch(error => {
                        showToast('エラー', `設定の保存に失敗しました: ${error.message}`, 'danger');
                        // 保存に失敗したら、UIの選択状態を元に戻す
                        document.getElementById(`profile-${previousProfileValue}`).checked = true;
                    });
                } else {
                    // キャンセルが押されたら、選択状態を元に戻す
                    document.getElementById(`profile-${previousProfileValue}`).checked = true;
                }
            });
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        fetchDebugTasks();
        fetchGlobalConfig();
        fetchDbTables();
        setupProfileToggle(); // プロファイル切り替えのイベントリスナーを設定
    });
</script>
{% endblock %}